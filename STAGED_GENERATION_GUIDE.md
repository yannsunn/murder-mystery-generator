# 🚀 段階的生成システムガイド

## 概要

段階的生成システムは、マーダーミステリーシナリオの生成処理を複数のステージに分割して実行することで、タイムアウトを回避し、より安定した生成を実現します。

## システムアーキテクチャ

### 3段階処理フロー

```
┌─────────────────────────────────────────────────┐
│ Stage 1: シナリオ生成                           │
│ ├─ Phase 1-4: 基本生成 (最大240秒)              │
│ └─ Phase 5-8: 詳細生成 (最大240秒)              │
│     ↓ 一時保存（30分間保持）                    │
├─────────────────────────────────────────────────┤
│ Stage 2: PDF生成（独立処理）                    │
│ └─ 保存データからPDF作成 (30秒)                 │
│     ↓ Base64形式で保存                          │
├─────────────────────────────────────────────────┤
│ Stage 3: 画像生成（オプション）                 │
│ └─ PDFから画像変換 (20秒) - 将来実装            │
└─────────────────────────────────────────────────┘
```

## 主な機能

### 1. セッション管理
- 一意のセッションIDでシナリオを管理
- 30分間のセッションタイムアウト
- 進捗状態の保存と復元

### 2. リトライ機能
- 処理失敗時の自動リトライ
- 最後に成功したステージから再開
- エラー時の手動リトライボタン

### 3. 進捗表示
- リアルタイムの進捗パーセンテージ
- 現在処理中のフェーズ表示
- 推定残り時間の表示

## 使用方法

### ユーザー向け

1. **生成モード選択**
   - 詳細オプション画面で「段階的生成モード」を選択（デフォルト）
   - タイムアウトを回避したい場合は推奨

2. **生成開始**
   - 「生成開始」ボタンをクリック
   - 進捗バーで処理状況を確認

3. **PDF生成**
   - シナリオ生成完了後、「PDFダウンロード」ボタンで別途生成
   - Stage 2として独立して処理

### 開発者向け

#### APIエンドポイント

1. **セッション管理**
   ```
   POST /api/scenario-storage?action=create
   POST /api/scenario-storage?action=save
   GET  /api/scenario-storage?action=get&sessionId={id}
   ```

2. **段階的生成**
   ```
   POST /api/staged-generation?stage=1
   POST /api/staged-generation?stage=1-continue
   POST /api/staged-generation?stage=2
   POST /api/staged-generation?stage=3
   ```

#### JavaScriptメソッド

```javascript
// 段階的生成の開始
app.startStagedGeneration()

// リトライ
app.retryStagedGeneration()

// セッション作成
app.createGenerationSession()

// 各ステージの実行
app.executeStage1(sessionId)
app.executeStage1Continue(sessionId)
app.executeStage2(sessionId)
```

## 設定とカスタマイズ

### タイムアウト設定

各APIの`maxDuration`設定：
- `phase1-8`: 60秒
- `scenario-storage`: 30秒
- `staged-generation`: 60秒

### セッションタイムアウト

```javascript
const SESSION_TIMEOUT = 30 * 60 * 1000; // 30分
```

## トラブルシューティング

### タイムアウトエラー
- 段階的生成モードが有効になっているか確認
- ネットワーク接続を確認
- リトライボタンで再試行

### セッション期限切れ
- 30分以内に処理を完了
- 必要に応じて新しいセッションで再開

### PDF生成エラー
- シナリオ生成が完了しているか確認
- セッションIDが有効か確認

## 今後の拡張予定

1. **Stage 3: 画像生成**
   - PDFからのサムネイル生成
   - キャラクターイメージ生成

2. **並列処理**
   - Phase 1-4と5-8の並列実行
   - さらなる高速化

3. **永続化ストレージ**
   - Redis/DynamoDBによる本番環境対応
   - 長期保存オプション