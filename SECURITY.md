# 🛡️ セキュリティガイド

## 🚨 重要なセキュリティ警告

### 1. APIキー管理
```bash
# ❌ 絶対にやってはいけない
GROQ_API_KEY=gsk_actual_key_here  # Gitにコミットしない！

# ✅ 正しい方法
# 1. .envファイルを.gitignoreに追加済み
# 2. 本番環境はVercel環境変数で設定
# 3. 定期的なキーローテーション実施
```

### 2. 露出したAPIキーの対処
**露出したGroq APIキーは即座に無効化してください:**
1. [Groq Console](https://console.groq.com/keys) にアクセス
2. 露出したキーを削除
3. 新しいキーを生成
4. 環境変数を更新

### 3. 本番環境設定

#### Vercel環境変数設定:
```bash
# 必須設定
GROQ_API_KEY=your_new_groq_key
API_SECRET_KEY=your_random_secret_key_32_chars
FRONTEND_URL=https://your-domain.vercel.app
NODE_ENV=production

# オプション設定  
RATE_LIMIT_MAX_REQUESTS=10
RATE_LIMIT_WINDOW_MINUTES=15
OPENAI_API_KEY=your_openai_key_backup
```

#### Netlify環境変数設定:
```bash
# 同じ環境変数をNetlify管理画面で設定
Site settings > Environment variables
```

## 🔐 実装済みセキュリティ機能

### 1. 入力検証・サニタイゼーション
- 参加者数制限（4-8人）
- 列挙値検証（era, setting等）
- 文字列長制限（1000文字）
- XSS攻撃対策
- SQLインジェクション対策

### 2. レート制限
- クライアントIP基準
- 15分間で10リクエスト制限
- 自動リセット機能
- レスポンスヘッダーで制限情報提供

### 3. 認証・認可
- API秘密キー認証
- Bearer token方式
- 開発環境では認証スキップ
- 本番環境では認証必須

### 4. CORS セキュリティ
- 許可ドメイン制限
- プリフライトリクエスト対応
- セキュリティヘッダー追加
- オリジン検証

### 5. エラーハンドリング
- 本番環境では詳細エラー非表示
- 開発環境では詳細エラー表示
- セキュリティログ記録
- 適切なHTTPステータスコード

### 6. コンテンツ安全性
- 不適切コンテンツ検出
- 暴力的表現フィルタ
- 家族向けコンテンツ保証
- 商業品質維持

## 📋 セキュリティチェックリスト

### デプロイ前確認事項:
- [ ] .envファイルがGitにコミットされていない
- [ ] 全てのAPIキーが正しく設定されている
- [ ] 本番環境変数が設定されている
- [ ] FRONTEND_URLが正しく設定されている
- [ ] API_SECRET_KEYが32文字以上のランダム文字列
- [ ] レート制限が適切に設定されている

### 定期的メンテナンス:
- [ ] APIキーを3ヶ月毎にローテーション
- [ ] セキュリティログの確認
- [ ] 依存関係の脆弱性チェック
- [ ] アクセスログの監視

## 🚀 パフォーマンス最適化

### キャッシュ戦略:
- API レスポンスキャッシュ (60秒)
- 静的アセットキャッシュ (1年)
- CDN配信最適化

### 監視・アラート:
- エラー率監視
- レスポンス時間監視
- API使用量監視
- セキュリティイベント監視

## 📞 インシデント対応

### APIキー漏洩時の対応:
1. 即座にキーを無効化
2. 新しいキーを生成・設定
3. アクセスログを確認
4. 影響範囲の特定
5. 再発防止策の実施

### セキュリティ問題報告:
セキュリティの問題を発見した場合は、即座に以下を実施:
1. 本番環境へのアクセス停止
2. 問題の詳細記録
3. 修正パッチの適用
4. 修正後の動作確認

## 📚 追加リソース

- [OWASP セキュリティガイド](https://owasp.org/)
- [Vercel セキュリティベストプラクティス](https://vercel.com/docs/security)
- [Node.js セキュリティガイド](https://nodejs.org/en/docs/guides/security/)

---

**🛡️ セキュリティは継続的な取り組みです。定期的な見直しと更新を実施してください。**