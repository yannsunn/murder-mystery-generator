/**
 * ğŸ”¬ Integrated Micro Generator - å®Œå…¨çµ±åˆãƒã‚¤ã‚¯ãƒ­ç”Ÿæˆã‚·ã‚¹ãƒ†ãƒ 
 * 1å›ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§å…¨ä½“ã‚’ç”Ÿæˆã™ã‚‹ä¿¡é ¼æ€§é‡è¦–ã®ã‚·ã‚¹ãƒ†ãƒ 
 */

import { aiClient } from './utils/ai-client.js';
import { withErrorHandler, AppError, ErrorTypes } from './utils/error-handler.js';
import { setSecurityHeaders } from './security-utils.js';
import { createSecurityMiddleware } from './middleware/rate-limiter.js';
import { createPerformanceMiddleware } from './middleware/performance-monitor.js';
import { createValidationMiddleware } from './middleware/input-validator.js';

export const config = {
  maxDuration: 300, // 5åˆ† - å®Œå…¨ç”Ÿæˆã®ãŸã‚ååˆ†ãªæ™‚é–“
};

// 5æ™‚é–“å¯¾å¿œçµ±åˆç”Ÿæˆãƒ•ãƒ­ãƒ¼
const INTEGRATED_GENERATION_FLOW = [
  {
    name: 'ä½œå“ã‚¿ã‚¤ãƒˆãƒ«ãƒ»ã‚³ãƒ³ã‚»ãƒ—ãƒˆãƒ»å°å…¥',
    weight: 8,
    handler: async (formData, context) => {
      const systemPrompt = `ã‚ãªãŸã¯ä¸–ç•Œãƒˆãƒƒãƒ—ã‚¯ãƒ©ã‚¹ã®ãƒãƒ¼ãƒ€ãƒ¼ãƒŸã‚¹ãƒ†ãƒªãƒ¼ä½œå®¶ã§ã™ã€‚é­…åŠ›çš„ã§ç‹¬å‰µçš„ãªä½œå“ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚`;
      
      const userPrompt = `
ã€é‡è¦ã€‘5æ™‚é–“ã®ãƒãƒ¼ãƒ€ãƒ¼ãƒŸã‚¹ãƒ†ãƒªãƒ¼ã‚»ãƒƒã‚·ãƒ§ãƒ³ç”¨ã®æœ¬æ ¼çš„ã‚·ãƒŠãƒªã‚ªã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

å‚åŠ äººæ•°: ${formData.participants}äºº
æ™‚ä»£èƒŒæ™¯: ${formData.era}
èˆå°è¨­å®š: ${formData.setting}
ä¸–ç•Œè¦³: ${formData.worldview || 'ãƒªã‚¢ãƒ«'}
ãƒˆãƒ¼ãƒ³: ${formData.tone}
äº‹ä»¶ç¨®é¡: ${formData.incident_type}
è¤‡é›‘ã•: ${formData.complexity}

ä»¥ä¸‹ã®å½¢å¼ã§5æ™‚é–“å¯¾å¿œã®æœ¬æ ¼çš„ãªä½œå“åŸºç¤ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ï¼š

## ä½œå“ã‚¿ã‚¤ãƒˆãƒ«
[é­…åŠ›çš„ã§å°è±¡çš„ãªã‚¿ã‚¤ãƒˆãƒ«]

## åŸºæœ¬ã‚³ãƒ³ã‚»ãƒ—ãƒˆ
[500æ–‡å­—ç¨‹åº¦ã®æ·±ã„æ ¸ã¨ãªã‚‹ã‚³ãƒ³ã‚»ãƒ—ãƒˆ - 5æ™‚é–“ã®å±•é–‹ã‚’æ”¯ãˆã‚‹èƒŒæ™¯]

## ä¸–ç•Œè¦³ãƒ»è¨­å®šè©³ç´°
[800æ–‡å­—ç¨‹åº¦ã®è©³ç´°ãªä¸–ç•Œè¦³ã¨èˆå°ã®æå†™ - æ²¡å…¥æ„Ÿã‚’é«˜ã‚ã‚‹è©³ç´°è¨­å®š]

## å°å…¥ã‚·ãƒŠãƒªã‚ªï¼ˆå…¨ä½“é…å¸ƒç”¨ï¼‰
[1200æ–‡å­—ç¨‹åº¦ã®å‚åŠ è€…å…¨å“¡ã«é…å¸ƒã™ã‚‹å°å…¥ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ - ä¸–ç•Œè¦³ã¸ã®æ²¡å…¥ã¨äº‹ä»¶ç™ºç”Ÿã¾ã§ã®çµŒç·¯]

## 5æ™‚é–“æ§‹æˆãƒ—ãƒ­ãƒƒãƒˆ
ã€ç¬¬1æ™‚é–“ã€‘å°å…¥ãƒ»ä¸–ç•Œè¦³èª¬æ˜ãƒ»ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç´¹ä»‹
ã€ç¬¬2æ™‚é–“ã€‘äº‹ä»¶ç™ºç”Ÿãƒ»åˆæœŸèª¿æŸ»
ã€ç¬¬3æ™‚é–“ã€‘è©³ç´°èª¿æŸ»ãƒ»è¨¼æ‹ åé›†ãƒ»è¨¼è¨€è´å–
ã€ç¬¬4æ™‚é–“ã€‘æ¨ç†ãƒ»è­°è«–ãƒ»ä»®èª¬æ§‹ç¯‰
ã€ç¬¬5æ™‚é–“ã€‘æœ€çµ‚æ¨ç†ãƒ»çœŸç›¸å…¬é–‹ãƒ»ã‚¨ãƒ”ãƒ­ãƒ¼ã‚°

## è¤‡é›‘ã•ãƒ¬ãƒ™ãƒ«å¯¾å¿œ
### ã‚·ãƒ³ãƒ—ãƒ«ç‰ˆã®å¤‰æ›´ç‚¹
[è¤‡é›‘ã•ã€Œã‚·ãƒ³ãƒ—ãƒ«ã€é¸æŠæ™‚ã®èª¿æ•´å†…å®¹]

### è¤‡é›‘ç‰ˆã®å¤‰æ›´ç‚¹  
[è¤‡é›‘ã•ã€Œè¤‡é›‘ã€é¸æŠæ™‚ã®è¿½åŠ è¦ç´ ]

## ãƒˆãƒ¼ãƒ³åˆ¥æ¼”å‡ºæŒ‡é‡
### ${formData.tone}ãƒˆãƒ¼ãƒ³å°‚ç”¨æ¼”å‡º
[é¸æŠã•ã‚ŒãŸãƒˆãƒ¼ãƒ³ã«ç‰¹åŒ–ã—ãŸæ¼”å‡ºæ–¹æ³•ã¨é›°å›²æ°—ä½œã‚Š]
`;

      const result = await aiClient.generateWithRetry(systemPrompt, userPrompt);
      return { concept: result.content };
    }
  },

  {
    name: 'ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å®Œå…¨è¨­è¨ˆãƒ»å€‹åˆ¥ãƒãƒ³ãƒ‰ã‚¢ã‚¦ãƒˆ',
    weight: 30,
    handler: async (formData, context) => {
      const concept = context.concept || '';
      const systemPrompt = `5æ™‚é–“ã®ãƒãƒ¼ãƒ€ãƒ¼ãƒŸã‚¹ãƒ†ãƒªãƒ¼å°‚é–€ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒ‡ã‚¶ã‚¤ãƒŠãƒ¼ã¨ã—ã¦ã€å„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒ5æ™‚é–“æ¥½ã—ã‚ã‚‹æ·±ã„å€‹åˆ¥ãƒãƒ³ãƒ‰ã‚¢ã‚¦ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚`;
      
      const userPrompt = `
ã‚³ãƒ³ã‚»ãƒ—ãƒˆ: ${concept}
å‚åŠ äººæ•°: ${formData.participants}äºº
è¤‡é›‘ã•: ${formData.complexity}
ãƒˆãƒ¼ãƒ³: ${formData.tone}

ã€é‡è¦ã€‘5æ™‚é–“ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã§å„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒæ²¡å…¥ã§ãã‚‹è©³ç´°ãªå€‹åˆ¥ãƒãƒ³ãƒ‰ã‚¢ã‚¦ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

## å…¨ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼æ¦‚è¦
[${formData.participants}äººã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼é–“ã®é–¢ä¿‚æ€§ã¨å…¨ä½“æ§‹é€ ]

## å€‹åˆ¥ãƒãƒ³ãƒ‰ã‚¢ã‚¦ãƒˆï¼ˆå„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼é…å¸ƒç”¨ï¼‰

å„ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã”ã¨ã«ï¼š
### ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼[ç•ªå·]ç”¨ãƒãƒ³ãƒ‰ã‚¢ã‚¦ãƒˆã€‘
#### ã‚ãªãŸã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼: [åå‰]

**â–  åŸºæœ¬è¨­å®š**
- å¹´é½¢ãƒ»è·æ¥­ãƒ»å¤–è¦‹: [è©³ç´°è¨­å®š]
- æ€§æ ¼ãƒ»å£èª¿: [ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒæ¼”ã˜ã‚„ã™ã„å…·ä½“çš„æŒ‡é‡]

**â–  ã‚ãªãŸã®èƒŒæ™¯ã‚¹ãƒˆãƒ¼ãƒªãƒ¼**
[800æ–‡å­—ç¨‹åº¦ - ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã¿ãŒçŸ¥ã‚‹è©³ç´°ãªéå»ã¨ç¾åœ¨ã®çŠ¶æ³]

**â–  ã‚ãªãŸãŒçŸ¥ã£ã¦ã„ã‚‹æƒ…å ±**
- å…¬é–‹å¯èƒ½ãªæƒ…å ±: [ä»–ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«è©±ã—ã¦ã‚‚ã‚ˆã„æƒ…å ±]
- ç§˜å¯†ã®æƒ…å ±: [çµ¶å¯¾ã«éš ã™ã¹ãé‡è¦ãªç§˜å¯†]
- æ¨ç†ã®æ‰‹ãŒã‹ã‚Š: [ã‚ãªãŸã ã‘ãŒæ°—ã¥ã‘ã‚‹ç‰¹åˆ¥ãªæƒ…å ±]

**â–  ä»–ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã¨ã®é–¢ä¿‚**
[ä»–ã®${formData.participants - 1}äººãã‚Œãã‚Œã¨ã®å…·ä½“çš„ãªé–¢ä¿‚æ€§ã¨æ„Ÿæƒ…]

**â–  ã‚ãªãŸã®ç›®æ¨™ãƒ»å‹åˆ©æ¡ä»¶**
- ä¸»ç›®æ¨™: [ã“ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãŒé”æˆã™ã¹ããƒ¡ã‚¤ãƒ³ç›®æ¨™]
- ç§˜å¯†ç›®æ¨™: [ä»–ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«çŸ¥ã‚‰ã‚ŒãŸããªã„å€‹äººçš„ç›®æ¨™]

**â–  è¡Œå‹•æŒ‡é‡ãƒ»ãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ã‚¤æŒ‡å°**
- åºç›¤ã§ã®è¡Œå‹•: [æœ€åˆã®1-2æ™‚é–“ã§ã®æ¨å¥¨è¡Œå‹•]
- ä¸­ç›¤ã§ã®è¡Œå‹•: [è¨¼æ‹ åé›†ãƒ»èª¿æŸ»ã§ã®è¡Œå‹•æ–¹é‡]
- çµ‚ç›¤ã§ã®è¡Œå‹•: [æ¨ç†ç™ºè¡¨ã§ã®æˆ¦ç•¥]

**â–  è¤‡é›‘ã•åˆ¥è¿½åŠ è¦ç´ **
### ã‚·ãƒ³ãƒ—ãƒ«ç‰ˆ: [è¤‡é›‘ã•ã€Œã‚·ãƒ³ãƒ—ãƒ«ã€æ™‚ã®ç°¡ç•¥åŒ–å†…å®¹]
### æ¨™æº–ç‰ˆ: [ç¾åœ¨ã®è¨­å®š]
### è¤‡é›‘ç‰ˆ: [è¤‡é›‘ã•ã€Œè¤‡é›‘ã€æ™‚ã®è¿½åŠ ç§˜å¯†ãƒ»é–¢ä¿‚æ€§]

å¿…ãš${formData.participants}äººåˆ†ã®å®Œå…¨ãªå€‹åˆ¥ãƒãƒ³ãƒ‰ã‚¢ã‚¦ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚
`;

      const result = await aiClient.generateWithRetry(systemPrompt, userPrompt);
      return { characters: result.content };
    }
  },

  {
    name: 'äº‹ä»¶ãƒ»è¬ãƒ»çœŸç›¸æ§‹ç¯‰ï¼ˆ5æ™‚é–“å¯¾å¿œï¼‰',
    weight: 25,
    handler: async (formData, context) => {
      const characters = context.characters || '';
      const systemPrompt = `5æ™‚é–“ã®ãƒãƒ¼ãƒ€ãƒ¼ãƒŸã‚¹ãƒ†ãƒªãƒ¼å°‚é–€ã®è¬æ§‹ç¯‰è€…ã¨ã—ã¦ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒ5æ™‚é–“ã‹ã‘ã¦è§£ãæ˜ã‹ã›ã‚‹è¤‡å±¤çš„ã§è«–ç†çš„ãªè¬ã‚’æ§‹ç¯‰ã—ã¦ãã ã•ã„ã€‚`;
      
      const userPrompt = `
ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼: ${characters}
è¤‡é›‘ã•ãƒ¬ãƒ™ãƒ«: ${formData.complexity}
ãƒˆãƒ¼ãƒ³: ${formData.tone}
ç‰¹æ®Šè¦ç´ :
- ãƒ¬ãƒƒãƒ‰ãƒ˜ãƒªãƒ³ã‚°: ${formData.red_herring ? 'ã‚ã‚Š' : 'ãªã—'}
- ã©ã‚“ã§ã‚“è¿”ã—: ${formData.twist_ending ? 'ã‚ã‚Š' : 'ãªã—'}
- ç§˜å¯†ã®å½¹å‰²: ${formData.secret_roles ? 'ã‚ã‚Š' : 'ãªã—'}

ã€é‡è¦ã€‘5æ™‚é–“ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã§æ®µéšçš„ã«è§£æ˜ã•ã‚Œã‚‹è¤‡å±¤çš„ãªäº‹ä»¶æ§‹é€ ã‚’æ§‹ç¯‰ã—ã¦ãã ã•ã„ã€‚

## äº‹ä»¶ç™ºç”Ÿãƒ»ç™ºè¦‹ã‚·ãƒ¼ãƒ³ï¼ˆè©³ç´°ï¼‰
- **äº‹ä»¶ç™ºç”Ÿã®ç¬é–“**: å…·ä½“çš„ãªçŠ¶æ³ã¨çµŒç·¯ï¼ˆ1000æ–‡å­—ç¨‹åº¦ï¼‰
- **ç™ºè¦‹ã‚·ãƒ¼ãƒ³**: ç¬¬ä¸€ç™ºè¦‹è€…ã®ä½“é¨“ã¨ç¾å ´ã®è©³ç´°æå†™
- **åˆæœŸã®æ··ä¹±**: å‚åŠ è€…å…¨å“¡ã®æœ€åˆã®åå¿œã¨çŠ¶æ³

## æ®µéšçš„è¬è§£ãæ§‹é€ ï¼ˆ5æ™‚é–“å¯¾å¿œï¼‰
### ã€ç¬¬1æ®µéšè¬ã€‘è¡¨é¢çš„ãªç–‘å•ï¼ˆ1æ™‚é–“ç›®ï¼‰
- åˆæœŸã®ä¸å¯©ç‚¹ã¨åŸºæœ¬çš„ãªç–‘å•
- ç°¡å˜ã«ç™ºè¦‹ã§ãã‚‹è¨¼æ‹ 

### ã€ç¬¬2æ®µéšè¬ã€‘æ·±å±¤ã®è¬ï¼ˆ2-3æ™‚é–“ç›®ï¼‰  
- ã‚ˆã‚Šè©³ç´°ãªèª¿æŸ»ã§ç™ºè¦‹ã•ã‚Œã‚‹çŸ›ç›¾
- ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼é–“ã®éš ã•ã‚ŒãŸé–¢ä¿‚

### ã€ç¬¬3æ®µéšè¬ã€‘æ ¸å¿ƒã®çœŸç›¸ï¼ˆ4-5æ™‚é–“ç›®ï¼‰
- æ±ºå®šçš„ãªè¨¼æ‹ ã¨æœ€çµ‚çš„ãªçœŸç›¸
- å…¨ã¦ã®è¬ãŒè§£æ˜ã•ã‚Œã‚‹ç¬é–“

## å®Œå…¨ãªçœŸç›¸ãƒ»çŠ¯è¡Œæ§‹é€ 
- **çœŸã®çŠ¯äºº**: çŠ¯äººã¨ãã®å®Œå…¨ãªå‹•æ©Ÿï¼ˆå¿ƒç†çš„èƒŒæ™¯å«ã‚€ï¼‰
- **è©³ç´°çŠ¯è¡Œæ‰‹é †**: åˆ†å˜ä½ã®è©³ç´°ãªçŠ¯è¡Œéç¨‹
- **ä½¿ç”¨ãƒˆãƒªãƒƒã‚¯**: è«–ç†çš„ã§æ¤œè¨¼å¯èƒ½ãªãƒˆãƒªãƒƒã‚¯
- **è¨¼æ‹ éš æ»…å·¥ä½œ**: çŠ¯äººã®å®Œç’§ãªéš è”½è¨ˆç”»

## 5æ™‚é–“å¯¾å¿œè¨¼æ‹ ãƒ»æ‰‹ãŒã‹ã‚Šã‚·ã‚¹ãƒ†ãƒ 
### ã€æ™‚é–“åˆ¥ç™ºè¦‹å¯èƒ½è¨¼æ‹ ã€‘
- 1æ™‚é–“ç›®ç™ºè¦‹å¯èƒ½: [åŸºæœ¬çš„ãªç‰©çš„è¨¼æ‹ ]
- 2æ™‚é–“ç›®ç™ºè¦‹å¯èƒ½: [è©³ç´°èª¿æŸ»ã§åˆ¤æ˜ã™ã‚‹è¨¼æ‹ ]
- 3æ™‚é–“ç›®ç™ºè¦‹å¯èƒ½: [æ¨ç†ãŒå¿…è¦ãªéš ã•ã‚ŒãŸè¨¼æ‹ ]
- 4æ™‚é–“ç›®ç™ºè¦‹å¯èƒ½: [æ±ºå®šçš„è¨¼æ‹ ã¸ã®æ‰‹ãŒã‹ã‚Š]
- 5æ™‚é–“ç›®ç™ºè¦‹å¯èƒ½: [æœ€çµ‚çš„ãªæ±ºå®šçš„è¨¼æ‹ ]

### ã€ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼åˆ¥è¨¼è¨€å†…å®¹ã€‘
[å„ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãŒæŒã¤è¨¼è¨€ãƒ»æƒ…å ±ã‚’æ™‚é–“çµŒéã§æ®µéšçš„ã«å…¬é–‹]

## è¤‡é›‘ã•åˆ¥ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³
### ã‚·ãƒ³ãƒ—ãƒ«ç‰ˆ: [è¬ã®ç°¡ç•¥åŒ–ã€è¨¼æ‹ ã®æ˜ç¢ºåŒ–]
### æ¨™æº–ç‰ˆ: [ç¾åœ¨ã®è¨­å®š]
### è¤‡é›‘ç‰ˆ: [è¿½åŠ ã®è¬ã€è¤‡é›‘ãªäººé–“é–¢ä¿‚ã€å¤šé‡ãƒˆãƒªãƒƒã‚¯]

## ãƒˆãƒ¼ãƒ³åˆ¥æ¼”å‡ºè¦ç´ 
### ${formData.tone}ãƒˆãƒ¼ãƒ³å°‚ç”¨è¦ç´ 
[é¸æŠã•ã‚ŒãŸãƒˆãƒ¼ãƒ³ã«åˆã‚ã›ãŸäº‹ä»¶ã®æ¼”å‡ºæ–¹æ³•]
`;

      const result = await aiClient.generateWithRetry(systemPrompt, userPrompt);
      return { incident_and_truth: result.content };
    }
  },

  {
    name: 'ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ãƒ»é€²è¡Œç®¡ç†ï¼ˆ5æ™‚é–“å®Œå…¨å¯¾å¿œï¼‰',
    weight: 17,
    handler: async (formData, context) => {
      const incident = context.incident_and_truth || '';
      const characters = context.characters || '';
      
      const systemPrompt = `5æ™‚é–“ã®ãƒãƒ¼ãƒ€ãƒ¼ãƒŸã‚¹ãƒ†ãƒªãƒ¼ã‚»ãƒƒã‚·ãƒ§ãƒ³å°‚é–€ã®é€²è¡Œç®¡ç†è€…ã¨ã—ã¦ã€å®Œç’§ãª5æ™‚é–“ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚’æ§‹ç¯‰ã—ã¦ãã ã•ã„ã€‚`;
      
      const userPrompt = `
äº‹ä»¶æƒ…å ±: ${incident}
ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼: ${characters}
è¤‡é›‘ã•: ${formData.complexity}

ã€é‡è¦ã€‘300åˆ†ï¼ˆ5æ™‚é–“ï¼‰ã®å®Œå…¨ãªã‚»ãƒƒã‚·ãƒ§ãƒ³é€²è¡Œã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚’æ§‹ç¯‰ã—ã¦ãã ã•ã„ã€‚

## äº‹ä»¶ç™ºç”Ÿå‰å®Œå…¨ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³
- **é‡è¦ãªå‰å²** (äº‹ä»¶1é€±é–“å‰ã€œå½“æ—¥): äº‹ä»¶ã«è‡³ã‚‹è©³ç´°ãªèƒŒæ™¯
- **é–¢ä¿‚æ€§ã®å¤‰åŒ–**: ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼é–“ã®é–¢ä¿‚ç™ºå±•ã®è©³ç´°
- **çŠ¯è¡Œæº–å‚™ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³**: çŠ¯äººã®æº–å‚™éç¨‹ï¼ˆåˆ†å˜ä½ï¼‰

## äº‹ä»¶ç™ºç”Ÿè©³ç´°ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³
- **åˆ†å˜ä½ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³**: äº‹ä»¶ç™ºç”Ÿã®15åˆ†å‰ã€œç™ºè¦‹ã¾ã§
- **å…¨ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¡Œå‹•è¨˜éŒ²**: å„äººã®è©³ç´°è¡Œå‹•ãƒ­ã‚°
- **é‡è¦è¨¼æ‹ ç”Ÿæˆã‚¿ã‚¤ãƒŸãƒ³ã‚°**: è¨¼æ‹ ãŒã„ã¤ã€ã©ã“ã§ä½œã‚‰ã‚ŒãŸã‹

## 5æ™‚é–“ã‚»ãƒƒã‚·ãƒ§ãƒ³å®Œå…¨é€²è¡Œè¡¨

### ã€ç¬¬1æ™‚é–“ (0-60åˆ†)ã€‘å°å…¥ãƒ»ä¸–ç•Œè¦³ãƒ»ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç´¹ä»‹
- 0-15åˆ†: ã‚²ãƒ¼ãƒ èª¬æ˜ãƒ»ãƒ«ãƒ¼ãƒ«ç¢ºèª
- 15-30åˆ†: å°å…¥ã‚·ãƒŠãƒªã‚ªèª­ã¿ä¸Šã’ãƒ»ä¸–ç•Œè¦³èª¬æ˜  
- 30-45åˆ†: ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç´¹ä»‹ãƒ»é–¢ä¿‚æ€§ç¢ºèª
- 45-60åˆ†: äº‹ä»¶ç™ºç”Ÿãƒ»ç¬¬ä¸€ç™ºè¦‹ãƒ»åˆæœŸæ··ä¹±

### ã€ç¬¬2æ™‚é–“ (60-120åˆ†)ã€‘åˆæœŸèª¿æŸ»ãƒ»åŸºæœ¬è¨¼æ‹ åé›†
- 60-75åˆ†: ç¾å ´æ¤œè¨¼ãƒ»åŸºæœ¬çš„ãªç‰©çš„è¨¼æ‹ ç™ºè¦‹
- 75-90åˆ†: åˆæœŸè¨¼è¨€åé›†ãƒ»å„ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‹ã‚‰ã®æƒ…å ±
- 90-105åˆ†: è¨¼æ‹ æ•´ç†ãƒ»åˆæœŸä»®èª¬æ§‹ç¯‰
- 105-120åˆ†: ç¬¬1å›å…¨ä½“ãƒ‡ã‚£ã‚¹ã‚«ãƒƒã‚·ãƒ§ãƒ³

### ã€ç¬¬3æ™‚é–“ (120-180åˆ†)ã€‘è©³ç´°èª¿æŸ»ãƒ»æ·±å±¤æƒ…å ±
- 120-135åˆ†: è©³ç´°èª¿æŸ»é–‹å§‹ãƒ»éš ã•ã‚ŒãŸè¨¼æ‹ ç™ºè¦‹
- 135-150åˆ†: ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å€‹åˆ¥å°‹å•ãƒ»ç§˜å¯†æƒ…å ±
- 150-165åˆ†: è¨¼æ‹ ã®çŸ›ç›¾ç™ºè¦‹ãƒ»æ–°ãŸãªç–‘å•
- 165-180åˆ†: é–¢ä¿‚æ€§ã®å†æ¤œè¨ãƒ»ä»®èª¬ä¿®æ­£

### ã€ç¬¬4æ™‚é–“ (180-240åˆ†)ã€‘æ¨ç†ãƒ»è­°è«–ãƒ»ä»®èª¬æ§‹ç¯‰
- 180-195åˆ†: å„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ¨ç†ç™ºè¡¨
- 195-210åˆ†: é›†ä¸­è­°è«–ãƒ»è¨¼æ‹ ã®æ¤œè¨¼
- 210-225åˆ†: æœ€çµ‚ä»®èª¬ã®æ§‹ç¯‰ãƒ»çŠ¯äººæ¨ç†
- 225-240åˆ†: æ±ºå®šçš„è¨¼æ‹ ã®æœ€çµ‚ç¢ºèª

### ã€ç¬¬5æ™‚é–“ (240-300åˆ†)ã€‘æœ€çµ‚æ¨ç†ãƒ»çœŸç›¸å…¬é–‹ãƒ»ã‚¨ãƒ”ãƒ­ãƒ¼ã‚°
- 240-255åˆ†: æœ€çµ‚æ¨ç†ç™ºè¡¨ãƒ»æŠ•ç¥¨
- 255-270åˆ†: çœŸç›¸å…¬é–‹ãƒ»çŠ¯äººã®å‘Šç™½
- 270-285åˆ†: å…¨è¬è§£ããƒ»å‹•æ©Ÿèª¬æ˜
- 285-300åˆ†: ã‚¨ãƒ”ãƒ­ãƒ¼ã‚°ãƒ»æ„Ÿæƒ³ãƒ»ç·æ‹¬

## æƒ…å ±å…¬é–‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°è¡¨
### ã€æ™‚é–“åˆ¥å…¬é–‹æƒ…å ±ã€‘
- ç¬¬1æ™‚é–“å…¬é–‹: [åŸºæœ¬æƒ…å ±ãƒ»è¡¨é¢çš„äº‹å®Ÿ]
- ç¬¬2æ™‚é–“å…¬é–‹: [åˆæœŸè¨¼æ‹ ãƒ»åŸºæœ¬çš„è¨¼è¨€]
- ç¬¬3æ™‚é–“å…¬é–‹: [è©³ç´°è¨¼æ‹ ãƒ»éš ã•ã‚ŒãŸæƒ…å ±]
- ç¬¬4æ™‚é–“å…¬é–‹: [è¤‡é›‘ãªè¨¼æ‹ ãƒ»æ±ºå®šçš„æ‰‹ãŒã‹ã‚Š]
- ç¬¬5æ™‚é–“å…¬é–‹: [æœ€çµ‚è¨¼æ‹ ãƒ»å®Œå…¨ãªçœŸç›¸]

### ã€æ¡ä»¶ä»˜ãæƒ…å ±å…¬é–‹ã€‘
[ç‰¹å®šã®è¡Œå‹•ãƒ»è³ªå•ãƒ»æ¨ç†ã§å¾—ã‚‰ã‚Œã‚‹è¿½åŠ æƒ…å ±ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°]

## è¤‡é›‘ã•åˆ¥æ™‚é–“èª¿æ•´
### ã‚·ãƒ³ãƒ—ãƒ«ç‰ˆ: [å„ãƒ•ã‚§ãƒ¼ã‚ºã®ç°¡ç•¥åŒ–ãƒ»æ™‚é–“çŸ­ç¸®ã®ãƒã‚¤ãƒ³ãƒˆ]
### æ¨™æº–ç‰ˆ: [ä¸Šè¨˜ã®æ¨™æº–è¨­å®š]
### è¤‡é›‘ç‰ˆ: [è¿½åŠ èª¿æŸ»æ™‚é–“ãƒ»è¤‡é›‘ãªæ¨ç†æ®µéšã®è¿½åŠ ]
`;

      const result = await aiClient.generateWithRetry(systemPrompt, userPrompt);
      return { timeline: result.content };
    }
  },

  {
    name: 'ã‚²ãƒ¼ãƒ ãƒã‚¹ã‚¿ãƒ¼å®Œå…¨ã‚¬ã‚¤ãƒ‰ï¼ˆ5æ™‚é–“å¯¾å¿œï¼‰',
    weight: 20,
    handler: async (formData, context) => {
      const allData = {
        concept: context.concept || '',
        characters: context.characters || '',
        incident: context.incident_and_truth || '',
        timeline: context.timeline || ''
      };
      
      const systemPrompt = `5æ™‚é–“ã®ãƒãƒ¼ãƒ€ãƒ¼ãƒŸã‚¹ãƒ†ãƒªãƒ¼ã‚»ãƒƒã‚·ãƒ§ãƒ³å°‚é–€ã®ã‚²ãƒ¼ãƒ ãƒã‚¹ã‚¿ãƒ¼æŒ‡å°è€…ã¨ã—ã¦ã€å®Œç’§ãª5æ™‚é–“é€²è¡Œã‚¬ã‚¤ãƒ‰ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚`;
      
      const userPrompt = `
å®Œå…¨ãªã‚·ãƒŠãƒªã‚ªæƒ…å ±: ${JSON.stringify(allData, null, 2)}
å‚åŠ äººæ•°: ${formData.participants}äºº
è¤‡é›‘ã•: ${formData.complexity}
ãƒˆãƒ¼ãƒ³: ${formData.tone}

ã€é‡è¦ã€‘5æ™‚é–“ï¼ˆ300åˆ†ï¼‰ã®ãƒãƒ¼ãƒ€ãƒ¼ãƒŸã‚¹ãƒ†ãƒªãƒ¼ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å®Œç’§ã«é€²è¡Œã™ã‚‹ãŸã‚ã®å®Œå…¨ã‚¬ã‚¤ãƒ‰ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

## äº‹å‰æº–å‚™å®Œå…¨ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### ã€å¿…é ˆæº–å‚™ç‰©ã€‘
- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åˆ¥å€‹åˆ¥ãƒãƒ³ãƒ‰ã‚¢ã‚¦ãƒˆï¼ˆ${formData.participants}éƒ¨ï¼‰
- å°å…¥ã‚·ãƒŠãƒªã‚ªé…å¸ƒè³‡æ–™ï¼ˆ${formData.participants}éƒ¨ï¼‰
- è¨¼æ‹ è³‡æ–™ãƒ»å†™çœŸãƒ»å°é“å…·ãƒªã‚¹ãƒˆ
- ã‚¿ã‚¤ãƒãƒ¼ãƒ»ã‚¹ãƒˆãƒƒãƒ—ã‚¦ã‚©ãƒƒãƒ
- ãƒ›ãƒ¯ã‚¤ãƒˆãƒœãƒ¼ãƒ‰ãƒ»ãƒãƒ¼ã‚«ãƒ¼ï¼ˆè¨¼æ‹ æ•´ç†ç”¨ï¼‰

### ã€ä¼šå ´è¨­å®šã€‘
- ãƒ†ãƒ¼ãƒ–ãƒ«é…ç½®å›³ï¼ˆ${formData.participants}äººç”¨ï¼‰
- ç…§æ˜ãƒ»éŸ³éŸ¿è¨­å®šï¼ˆ${formData.tone}ãƒˆãƒ¼ãƒ³å¯¾å¿œï¼‰
- è¨¼æ‹ å±•ç¤ºã‚¹ãƒšãƒ¼ã‚¹
- å€‹åˆ¥ç›¸è«‡ã‚¹ãƒšãƒ¼ã‚¹

### ã€ã‚²ãƒ¼ãƒ ãƒã‚¹ã‚¿ãƒ¼ç”¨è³‡æ–™ã€‘
- 5æ™‚é–“é€²è¡Œã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è¡¨
- æ™‚é–“åˆ¥æƒ…å ±å…¬é–‹ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ
- ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒãƒ‹ãƒ¥ã‚¢ãƒ«
- ç·Šæ€¥æ™‚ãƒ’ãƒ³ãƒˆé›†

## 5æ™‚é–“å®Œå…¨é€²è¡Œãƒãƒ‹ãƒ¥ã‚¢ãƒ«

### ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹å‰ (15åˆ†å‰)ã€‘
- å‚åŠ è€…å—ä»˜ãƒ»å¸­é †ç¢ºèª
- ãƒ«ãƒ¼ãƒ«èª¬æ˜æº–å‚™ãƒ»è³‡æ–™é…å¸ƒæº–å‚™
- é›°å›²æ°—ä½œã‚Šï¼ˆ${formData.tone}ãƒˆãƒ¼ãƒ³æ¼”å‡ºé–‹å§‹ï¼‰

### ã€ç¬¬1æ™‚é–“ (0-60åˆ†)ã€‘è©³ç´°é€²è¡Œ
- 0-15åˆ†: ã‚²ãƒ¼ãƒ èª¬æ˜ãƒ»ãƒ«ãƒ¼ãƒ«ç¢ºèª
  * æ¨ç†ã‚²ãƒ¼ãƒ ã®åŸºæœ¬ãƒ«ãƒ¼ãƒ«
  * å‹åˆ©æ¡ä»¶ã®èª¬æ˜
  * è³ªå•ãƒ»ç›¸è«‡ã®ãƒ«ãƒ¼ãƒ«
- 15-30åˆ†: å°å…¥ã‚·ãƒŠãƒªã‚ªãƒ»ä¸–ç•Œè¦³èª¬æ˜
  * å…¨ä½“é…å¸ƒè³‡æ–™ã®èª­ã¿ä¸Šã’
  * ä¸–ç•Œè¦³ã¸ã®æ²¡å…¥ä¿ƒé€²
- 30-45åˆ†: ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç´¹ä»‹ãƒ»é–¢ä¿‚æ€§ç¢ºèª
  * å€‹åˆ¥ãƒãƒ³ãƒ‰ã‚¢ã‚¦ãƒˆé…å¸ƒ
  * å„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®è‡ªå·±ç´¹ä»‹
  * åˆæœŸé–¢ä¿‚æ€§ã®ç¢ºèª
- 45-60åˆ†: äº‹ä»¶ç™ºç”Ÿãƒ»ç¬¬ä¸€ç™ºè¦‹
  * äº‹ä»¶ç™ºç”Ÿã®æ¼”å‡º
  * ç¾å ´ã®è©³ç´°èª¬æ˜
  * åˆæœŸæ··ä¹±ã®æ¼”å‡º

### ã€ç¬¬2æ™‚é–“ã€œç¬¬5æ™‚é–“ã€‘
[å„æ™‚é–“ã®è©³ç´°ãªé€²è¡Œæ‰‹é †ãƒ»æ³¨æ„ç‚¹ãƒ»æ¼”å‡ºæ–¹æ³•]

## æ™‚é–“åˆ¥æƒ…å ±å…¬é–‹ãƒãƒ‹ãƒ¥ã‚¢ãƒ«
### ã€å³å¯†ã‚¿ã‚¤ãƒŸãƒ³ã‚°ç®¡ç†ã€‘
- ç¬¬1æ™‚é–“: åŸºæœ¬æƒ…å ±ã®ã¿å…¬é–‹
- ç¬¬2æ™‚é–“: åˆæœŸè¨¼æ‹ å…¬é–‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°
- ç¬¬3æ™‚é–“: é‡è¦è¨¼æ‹ ãƒ»ç§˜å¯†æƒ…å ±å…¬é–‹
- ç¬¬4æ™‚é–“: æ±ºå®šçš„æ‰‹ãŒã‹ã‚Šå…¬é–‹
- ç¬¬5æ™‚é–“: æœ€çµ‚è¨¼æ‹ ãƒ»çœŸç›¸å…¬é–‹

### ã€æƒ…å ±å…¬é–‹æ–¹æ³•ã€‘
[å„æƒ…å ±ã®åŠ¹æœçš„ãªå…¬é–‹æ–¹æ³•ãƒ»æ¼”å‡º]

## å®Œå…¨ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ã€æ™‚é–“ç®¡ç†å•é¡Œã€‘
- é€²è¡ŒãŒæ—©ã™ãã‚‹å ´åˆ: [è©³ç´°èª¿æŸ»ã®è¿½åŠ ãƒ»è­°è«–æ™‚é–“å»¶é•·]
- é€²è¡ŒãŒé…ã™ãã‚‹å ´åˆ: [ãƒ’ãƒ³ãƒˆè¿½åŠ ãƒ»ç°¡ç•¥åŒ–ãƒã‚¤ãƒ³ãƒˆ]

### ã€æ¨ç†åœæ»å•é¡Œã€‘
- è¡Œãè©°ã¾ã£ãŸå ´åˆã®æ®µéšçš„ãƒ’ãƒ³ãƒˆï¼ˆ3æ®µéšï¼‰
- ç¬¬1æ®µéšãƒ’ãƒ³ãƒˆ: [è»½ã„ãƒ’ãƒ³ãƒˆ]
- ç¬¬2æ®µéšãƒ’ãƒ³ãƒˆ: [ä¸­ç¨‹åº¦ã®ãƒ’ãƒ³ãƒˆ]  
- ç¬¬3æ®µéšãƒ’ãƒ³ãƒˆ: [æ±ºå®šçš„ãƒ’ãƒ³ãƒˆ]

### ã€å‚åŠ è€…ãƒ•ã‚©ãƒ­ãƒ¼ã€‘
- ç™ºè¨€ãŒå°‘ãªã„äººã¸ã®è‡ªç„¶ãªæŒ¯ã‚Šæ–¹
- æ¨ç†ãŒå¤–ã‚ŒãŸäººã¸ã®ãƒ•ã‚©ãƒ­ãƒ¼
- ç†±ããªã‚Šã™ããŸè­°è«–ã®ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³

## ${formData.tone}ãƒˆãƒ¼ãƒ³å°‚ç”¨æ¼”å‡ºã‚¬ã‚¤ãƒ‰
[é¸æŠã•ã‚ŒãŸãƒˆãƒ¼ãƒ³ã«ç‰¹åŒ–ã—ãŸæ¼”å‡ºæ–¹æ³•ãƒ»é›°å›²æ°—ä½œã‚Šãƒ»é€²è¡Œãƒ†ã‚¯ãƒ‹ãƒƒã‚¯]

## å®Œå…¨é…å¸ƒè³‡æ–™ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸

### ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ç”¨å€‹åˆ¥ãƒãƒ³ãƒ‰ã‚¢ã‚¦ãƒˆã€‘
[å„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«é…å¸ƒã™ã‚‹å®Œå…¨ãªå€‹åˆ¥è³‡æ–™ã®å†…å®¹ãƒ»ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ]

### ã€å…±é€šé…å¸ƒè³‡æ–™ã€‘
- å°å…¥ã‚·ãƒŠãƒªã‚ªï¼ˆå…¨å“¡é…å¸ƒç”¨ï¼‰
- åŸºæœ¬ãƒ«ãƒ¼ãƒ«èª¬æ˜æ›¸
- è¨¼æ‹ æ•´ç†ã‚·ãƒ¼ãƒˆ

### ã€ã‚²ãƒ¼ãƒ ãƒã‚¹ã‚¿ãƒ¼å°‚ç”¨è³‡æ–™ã€‘
- å®Œå…¨å›ç­”é›†
- æ™‚é–“åˆ¥ãƒã‚§ãƒƒã‚¯ã‚·ãƒ¼ãƒˆ
- ç·Šæ€¥å¯¾å¿œãƒãƒ‹ãƒ¥ã‚¢ãƒ«

## è¤‡é›‘ã•åˆ¥é‹å–¶èª¿æ•´
### ã‚·ãƒ³ãƒ—ãƒ«ç‰ˆ: [ç°¡ç•¥åŒ–ãƒã‚¤ãƒ³ãƒˆãƒ»æ™‚é–“çŸ­ç¸®æ–¹æ³•]
### æ¨™æº–ç‰ˆ: [ä¸Šè¨˜ã®æ¨™æº–é€²è¡Œ]
### è¤‡é›‘ç‰ˆ: [è¿½åŠ è¦ç´ ãƒ»å»¶é•·ãƒã‚¤ãƒ³ãƒˆãƒ»é«˜åº¦ãªæ¼”å‡º]

ã“ã®å®Œå…¨ã‚¬ã‚¤ãƒ‰ã«ã‚ˆã‚Šã€5æ™‚é–“ã®å……å®Ÿã—ãŸãƒãƒ¼ãƒ€ãƒ¼ãƒŸã‚¹ãƒ†ãƒªãƒ¼ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒä¿è¨¼ã•ã‚Œã¾ã™ã€‚
`;

      const result = await aiClient.generateWithRetry(systemPrompt, userPrompt);
      return { gamemaster_guide: result.content };
    }
  }
];

// ãƒ¡ã‚¤ãƒ³ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
export default async function handler(req, res) {
  console.log('ğŸ”¬ Integrated Micro Generator called');
  
  setSecurityHeaders(res);
  
  if (req.method === 'OPTIONS') {
    return res.status(200).end();
  }

  if (req.method !== 'POST') {
    return res.status(405).json({ 
      success: false, 
      error: 'Method not allowed. Use POST.' 
    });
  }

  // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ»ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ»ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³çµ±åˆãƒã‚§ãƒƒã‚¯
  const middlewares = [
    createPerformanceMiddleware(),
    createSecurityMiddleware('generation')
    // createValidationMiddleware('generation') // ä¸€æ™‚ç„¡åŠ¹åŒ–
  ];

  for (const middleware of middlewares) {
    try {
      await new Promise((resolve, reject) => {
        middleware(req, res, (error) => {
          if (error) reject(error);
          else resolve();
        });
      });
    } catch (middlewareError) {
      console.error('Middleware error:', middlewareError);
      return res.status(500).json({ 
        success: false, 
        error: 'Middleware error: ' + middlewareError.message 
      });
    }
  }

  try {
    const { formData, sessionId } = req.body;
    
    console.log('ğŸ”¬ Starting integrated micro generation...');
    console.log('ğŸ“‹ Raw request body:', JSON.stringify(req.body, null, 2));
    console.log('ğŸ“‹ Received formData:', JSON.stringify(formData, null, 2));
    console.log('ğŸ†” Session ID:', sessionId);
    
    if (!formData) {
      return res.status(400).json({
        success: false,
        error: 'formData is required',
        received: req.body
      });
    }
    
    const sessionData = {
      sessionId: sessionId || `integrated_micro_${Date.now()}`,
      formData,
      startTime: new Date().toISOString(),
      phases: {},
      status: 'running',
      generationType: 'integrated_micro'
    };

    let context = {};
    let currentWeight = 0;
    const totalWeight = INTEGRATED_GENERATION_FLOW.reduce((sum, step) => sum + step.weight, 0);

    // å„ã‚¹ãƒ†ãƒƒãƒ—ã‚’é †æ¬¡å®Ÿè¡Œ
    for (let i = 0; i < INTEGRATED_GENERATION_FLOW.length; i++) {
      const step = INTEGRATED_GENERATION_FLOW[i];
      
      console.log(`ğŸ”„ Executing: ${step.name}`);
      
      try {
        const result = await step.handler(formData, context);
        
        // ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã«çµæœã‚’è¿½åŠ 
        Object.assign(context, result);
        
        // ãƒ•ã‚§ãƒ¼ã‚ºãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦ä¿å­˜
        sessionData.phases[`step${i + 1}`] = {
          name: step.name,
          content: result,
          status: 'completed',
          completedAt: new Date().toISOString()
        };
        
        currentWeight += step.weight;
        const progress = Math.round((currentWeight / totalWeight) * 100);
        
        console.log(`âœ… ${step.name} completed (${progress}%)`);
        
      } catch (stepError) {
        console.error(`âŒ Step failed: ${step.name}`, stepError);
        
        sessionData.phases[`step${i + 1}`] = {
          name: step.name,
          status: 'error',
          error: stepError.message,
          failedAt: new Date().toISOString()
        };
        
        // è‡´å‘½çš„ã‚¨ãƒ©ãƒ¼ã§ã¯ãªã„å ´åˆã¯ç¶šè¡Œ
        if (step.weight < 30) {
          console.log(`âš ï¸ Non-critical step failed, continuing...`);
          continue;
        } else {
          throw new AppError(`Critical step failed: ${step.name}`, ErrorTypes.GENERATION_ERROR);
        }
      }
    }

    // å®Œäº†å‡¦ç†
    sessionData.status = 'completed';
    sessionData.completedAt = new Date().toISOString();
    sessionData.context = context;

    console.log('ğŸ‰ Integrated micro generation completed successfully!');

    return res.status(200).json({
      success: true,
      sessionData,
      message: 'ğŸ‰ çµ±åˆãƒã‚¤ã‚¯ãƒ­ç”ŸæˆãŒå®Œäº†ã—ã¾ã—ãŸï¼',
      downloadReady: true,
      generationType: 'integrated_micro'
    });

  } catch (error) {
    console.error('ğŸš¨ Integrated micro generation error:', error);
    return res.status(500).json({
      success: false,
      error: error.message || 'Generation failed',
      details: process.env.NODE_ENV === 'development' ? error.stack : undefined
    });
  }
}