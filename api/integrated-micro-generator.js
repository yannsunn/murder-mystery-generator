/**
 * ğŸ† Professional Murder Mystery Generator - ç‹‚æ°—å±±è„ˆå“è³ªæº–æ‹ 
 * ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«TRPGå“è³ªãƒãƒ¼ãƒ€ãƒ¼ãƒŸã‚¹ãƒ†ãƒªãƒ¼ç”Ÿæˆã‚·ã‚¹ãƒ†ãƒ å®Œå…¨ç‰ˆ
 * å‚è€ƒï¼šã€Œç‹‚æ°—å±±è„ˆã€€é™°è¬€ã®åˆ†æ°´å¶ºã€å•†æ¥­å“è³ªåŸºæº–æº–æ‹ 
 */

import { aiClient } from './utils/ai-client.js';
import { withErrorHandler, AppError, ErrorTypes } from './utils/error-handler.js';
import { setSecurityHeaders } from './security-utils.js';
import { createSecurityMiddleware } from './middleware/rate-limiter.js';
import { createPerformanceMiddleware } from './middleware/performance-monitor.js';
import { createValidationMiddleware } from './middleware/input-validator.js';
import { qualityAssessor } from './utils/quality-assessor.js';
import { parallelEngine, intelligentCache } from './utils/performance-optimizer.js';
import { randomMysteryGenerator } from './utils/random-mystery-generator.js';

export const config = {
  maxDuration: 300, // 5åˆ† - 30åˆ†-1æ™‚é–“é«˜ç²¾åº¦ç”Ÿæˆã®ãŸã‚ååˆ†ãªæ™‚é–“
};

// 30åˆ†-1æ™‚é–“ç†æƒ³çš„ç”Ÿæˆãƒ•ãƒ­ãƒ¼ï¼ˆãƒ©ãƒ³ãƒ€ãƒ â†’æ®µéšçš„â†’å…¨ä½“èª¿æ•´ï¼‰
const INTEGRATED_GENERATION_FLOW = [
  
  // === æ®µéš0: ãƒ©ãƒ³ãƒ€ãƒ å…¨ä½“æ§‹é€ ç”Ÿæˆ ===
  {
    name: 'æ®µéš0: ãƒ©ãƒ³ãƒ€ãƒ å…¨ä½“æ§‹é€ ãƒ»ã‚¢ã‚¦ãƒˆãƒ©ã‚¤ãƒ³',
    weight: 15,
    handler: async (formData, context) => {
      console.log('ğŸ² æ®µéš0: ãƒ©ãƒ³ãƒ€ãƒ å…¨ä½“æ§‹é€ ç”Ÿæˆé–‹å§‹');
      
      const systemPrompt = `ã‚ãªãŸã¯ã€Œç‹‚æ°—å±±è„ˆã€€é™°è¬€ã®åˆ†æ°´å¶ºã€ãƒ¬ãƒ™ãƒ«ã®ãƒãƒ¼ãƒ€ãƒ¼ãƒŸã‚¹ãƒ†ãƒªãƒ¼ã‚¯ãƒªã‚¨ã‚¤ã‚¿ãƒ¼ã§ã™ã€‚
30åˆ†-1æ™‚é–“ã‚»ãƒƒã‚·ãƒ§ãƒ³ç”¨ã®ãƒãƒ¼ãƒ€ãƒ¼ãƒŸã‚¹ãƒ†ãƒªãƒ¼ã®å¤§ã¾ã‹ãªå…¨ä½“æ§‹é€ ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚
ã“ã®æ®µéšã§ã¯ã€å¾Œã§è©³ç´°åŒ–ã•ã‚Œã‚‹ãŸã‚ã®åŸºæœ¬çš„ãªã‚¢ã‚¦ãƒˆãƒ©ã‚¤ãƒ³ã‚’ä½œæˆã—ã¾ã™ã€‚`;
      
      const userPrompt = `
ã€ãƒ©ãƒ³ãƒ€ãƒ å…¨ä½“æ§‹é€ ç”Ÿæˆä¾é ¼ã€‘

å‚åŠ äººæ•°: ${formData.participants}äºº
æ™‚ä»£èƒŒæ™¯: ${formData.era}
èˆå°è¨­å®š: ${formData.setting}
ä¸–ç•Œè¦³: ${formData.worldview || 'ãƒªã‚¢ãƒ«'}
ãƒˆãƒ¼ãƒ³: ${formData.tone}
äº‹ä»¶ç¨®é¡: ${formData.incident_type}
è¤‡é›‘ã•: ${formData.complexity}

ä»¥ä¸‹ã®å½¢å¼ã§å¤§ã¾ã‹ãªå…¨ä½“æ§‹é€ ã‚’ãƒ©ãƒ³ãƒ€ãƒ ç”Ÿæˆã—ã¦ãã ã•ã„ï¼š

## ä½œå“åŸºæœ¬æƒ…å ±ï¼ˆãƒ©ãƒ³ãƒ€ãƒ ç‰ˆï¼‰
**ä½œå“ã‚¿ã‚¤ãƒˆãƒ«**: [ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªã‚¿ã‚¤ãƒˆãƒ«]
**åŸºæœ¬ã‚³ãƒ³ã‚»ãƒ—ãƒˆ**: [ç°¡æ½”ãªã‚³ãƒ³ã‚»ãƒ—ãƒˆ]
**èˆå°è¨­å®š**: [å…·ä½“çš„ãªå ´æ‰€ãƒ»çŠ¶æ³]

## äº‹ä»¶ã®å¤§ã¾ã‹ãªæ§‹é€ ï¼ˆãƒ©ãƒ³ãƒ€ãƒ ç‰ˆï¼‰
**äº‹ä»¶ã®ç¨®é¡**: [å…·ä½“çš„ãªäº‹ä»¶å†…å®¹]
**çŠ¯äººã®æ•°**: [å˜çŠ¯ã¾ãŸã¯å…±çŠ¯]
**åŸºæœ¬çš„ãªå‹•æ©Ÿ**: [ç°¡æ½”ãªå‹•æ©Ÿ]
**ä¸»ãªãƒˆãƒªãƒƒã‚¯**: [ä½¿ç”¨ã•ã‚Œã‚‹ãƒˆãƒªãƒƒã‚¯ã®ç¨®é¡]

## ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®å¤§ã¾ã‹ãªå½¹å‰²ï¼ˆãƒ©ãƒ³ãƒ€ãƒ ç‰ˆï¼‰
${Array.from({length: parseInt(formData.participants)}, (_, i) => `**ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${i + 1}**: [å¤§ã¾ã‹ãªå½¹å‰²ãƒ»ç«‹å ´ãƒ»äº‹ä»¶ã¨ã®é–¢ä¿‚]`).join('\n')}

## é‡è¦ãªè¦ç´ ï¼ˆãƒ©ãƒ³ãƒ€ãƒ ç‰ˆï¼‰
**ä¸»ãªè¨¼æ‹ **: [é‡è¦ãªè¨¼æ‹ ã®ç¨®é¡]
**ã‚­ãƒ¼ã¨ãªã‚‹æ‰‹ãŒã‹ã‚Š**: [è§£æ±ºã®éµã¨ãªã‚‹è¦ç´ ]
**ãƒ¡ã‚¤ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ**: [ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸­ã®ä¸»è¦ãªå‡ºæ¥äº‹]

## å¤§ã¾ã‹ãªè§£æ±ºãƒ•ãƒ­ãƒ¼ï¼ˆãƒ©ãƒ³ãƒ€ãƒ ç‰ˆï¼‰
**ç¬¬1æ®µéš**: [åˆæœŸç™ºè¦‹ãƒ»çŠ¶æ³æŠŠæ¡]
**ç¬¬2æ®µéš**: [è¨¼æ‹ åé›†ãƒ»é–¢ä¿‚æ€§ç†è§£]
**ç¬¬3æ®µéš**: [æ¨ç†ãƒ»çœŸç›¸è§£æ˜]

ã€é‡è¦ã€‘
- ã“ã®æ®µéšã¯ã‚¢ã‚¦ãƒˆãƒ©ã‚¤ãƒ³ã®ã¿ã€è©³ç´°ã¯å¾Œã®æ®µéšã§ä½œæˆ
- 30åˆ†-1æ™‚é–“ã§å®Œçµå¯èƒ½ãªç¯„å›²ã§è¨­å®š
- ãƒ©ãƒ³ãƒ€ãƒ æ€§ã¨é¢ç™½ã•ã‚’é‡è¦–
- å…¨ã¦ã®æ–‡ç« ã‚’å®Œçµã•ã›ã‚‹
`;

      const result = await aiClient.generateWithRetry(systemPrompt, userPrompt);
      console.log('âœ… æ®µéš0: ãƒ©ãƒ³ãƒ€ãƒ å…¨ä½“æ§‹é€ å®Œæˆ');
      return { random_outline: result.content };
    }
  },
  // === æ®µéš1: åŸºæœ¬ã‚³ãƒ³ã‚»ãƒ—ãƒˆç²¾å¯†åŒ– ===
  {
    name: 'æ®µéš1: ã‚³ãƒ³ã‚»ãƒ—ãƒˆç²¾å¯†åŒ–ãƒ»ä¸–ç•Œè¦³è©³ç´°åŒ–',
    weight: 10,
    handler: async (formData, context) => {
      console.log('ğŸ¨ æ®µéš1: ã‚³ãƒ³ã‚»ãƒ—ãƒˆç²¾å¯†åŒ–é–‹å§‹');
      
      const randomOutline = context.random_outline || '';
      
      const systemPrompt = `ã‚ãªãŸã¯ã€Œç‹‚æ°—å±±è„ˆã€€é™°è¬€ã®åˆ†æ°´å¶ºã€ãƒ¬ãƒ™ãƒ«ã®ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ãƒãƒ¼ãƒ€ãƒ¼ãƒŸã‚¹ãƒ†ãƒªãƒ¼ä¼ç”»è€…ã§ã™ã€‚
ãƒ©ãƒ³ãƒ€ãƒ ç”Ÿæˆã•ã‚ŒãŸå¤§ã¾ã‹ãªæ§‹é€ ã‚’åŸºã«ã€è©³ç´°ãªã‚³ãƒ³ã‚»ãƒ—ãƒˆã¨ä¸–ç•Œè¦³ã‚’ç²¾å¯†ã«ä½œæˆã—ã¦ãã ã•ã„ã€‚`;
      
      const userPrompt = `
ã€ã‚³ãƒ³ã‚»ãƒ—ãƒˆç²¾å¯†åŒ–ä¾é ¼ã€‘

ãƒ©ãƒ³ãƒ€ãƒ å…¨ä½“æ§‹é€ : ${randomOutline}

å‚åŠ äººæ•°: ${formData.participants}äºº
ãƒ—ãƒ¬ã‚¤æ™‚é–“: ${getPlayTime(formData.complexity)}
æ™‚ä»£èƒŒæ™¯: ${formData.era}
èˆå°è¨­å®š: ${formData.setting}
ä¸–ç•Œè¦³: ${formData.worldview || 'ãƒªã‚¢ãƒ«'}
ãƒˆãƒ¼ãƒ³: ${formData.tone}
äº‹ä»¶ç¨®é¡: ${formData.incident_type}
è¤‡é›‘ã•: ${formData.complexity}

ã€å•†æ¥­å“è³ªåŸºæº–ã€‘
- ç‹‚æ°—å±±è„ˆãƒ¬ãƒ™ãƒ«ã®æ²¡å…¥æ„Ÿã¨ä¸–ç•Œè¦³æ§‹ç¯‰
- ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«TRPGåˆ¶ä½œåŸºæº–å®Œå…¨æº–æ‹ 
- å‚åŠ è€…ãŒå½¹ã«ãªã‚Šãã‚Œã‚‹æ·±ã„ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¨­å®šåŸºç¤
- ç·»å¯†ãªè¬ã¨è«–ç†çš„è§£æ±ºã®åŸºç›¤
- ç¾éº—ãªé›°å›²æ°—ã¨ãƒ‰ãƒ©ãƒæ€§ã®æ¼”å‡º

ä»¥ä¸‹ã®å½¢å¼ã§ãƒ—ãƒ­å“è³ªã®ä½œå“åŸºç¤ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ï¼š

## ä½œå“ã‚¿ã‚¤ãƒˆãƒ«
[å°è±¡çš„ã§è¦šãˆã‚„ã™ã„ã€å•†æ¥­ä½œå“ãƒ¬ãƒ™ãƒ«ã®å®Œå…¨ã«ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªã‚¿ã‚¤ãƒˆãƒ« - æ—¢å­˜ä½œå“ã¨é‡è¤‡ã—ãªã„ç‹¬å‰µçš„ãªåå‰]

## ä½œå“ã‚³ãƒ³ã‚»ãƒ—ãƒˆ
[500æ–‡å­—ç¨‹åº¦ï¼šä¸–ç•Œè¦³ã€ãƒ†ãƒ¼ãƒã€ç‹¬è‡ªæ€§ã‚’æ˜ç¢ºã«ç¤ºã™ãƒ—ãƒ­å“è³ªã‚³ãƒ³ã‚»ãƒ—ãƒˆ]

## èˆå°è¨­å®šè©³ç´°
### åŸºæœ¬è¨­å®š
[æ™‚ä»£ã€å ´æ‰€ã€çŠ¶æ³ã®è©³ç´°è¨­å®š]

### é›°å›²æ°—ãƒ»ãƒˆãƒ¼ãƒ³è¨­è¨ˆ
[è¦–è¦šçš„ã‚¤ãƒ¡ãƒ¼ã‚¸ã€éŸ³éŸ¿åŠ¹æœã€æ„Ÿæƒ…çš„ãªé›°å›²æ°—ã®è©³ç´°è¨­è¨ˆ]

### ç‹¬è‡ªè¦ç´ ãƒ»å·®åˆ¥åŒ–ãƒã‚¤ãƒ³ãƒˆ
[ä»–ã®ã‚·ãƒŠãƒªã‚ªã¨ã®æ˜ç¢ºãªå·®åˆ¥åŒ–è¦ç´ ]

## ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å½¹è·æ¦‚è¦
[${formData.participants}äººã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å½¹è·ã¨ãã®åŸºæœ¬çš„é–¢ä¿‚æ€§]

## äº‹ä»¶ã®æ ¸å¿ƒ
[ä»Šå›ç™ºç”Ÿã™ã‚‹äº‹ä»¶ã®æ¦‚è¦ã¨é­…åŠ›çš„ãªè¬ã®è¦ç´ ]
[400æ–‡å­—ç¨‹åº¦ã®å¿…è¦ååˆ†ãªä¸–ç•Œè¦³ - çŸ­æ™‚é–“ã§å®Œå…¨ã«ç†è§£ã§ãã‚‹è¨­å®š]

## å°å…¥ã‚·ãƒŠãƒªã‚ªï¼ˆå…¨ä½“é…å¸ƒç”¨ãƒ»å®Œçµç‰ˆï¼‰
[600æ–‡å­—ç¨‹åº¦ã®å®Œç’§ãªå°å…¥ - 5åˆ†ã§èª­ã‚ã¦å³åº§ã«æ²¡å…¥ã§ãã‚‹å†…å®¹]

## 30åˆ†-1æ™‚é–“å®Œçµæ§‹æˆ
ã€å°å…¥ãƒ•ã‚§ãƒ¼ã‚ºï¼ˆ5åˆ†ï¼‰ã€‘ä¸–ç•Œè¦³èª¬æ˜ãƒ»ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç´¹ä»‹ãƒ»äº‹ä»¶ç™ºç”Ÿ
ã€èª¿æŸ»ãƒ•ã‚§ãƒ¼ã‚ºï¼ˆ15-35åˆ†ï¼‰ã€‘è¨¼æ‹ åé›†ãƒ»è¨¼è¨€è´å–ãƒ»æ¨ç†æ§‹ç¯‰
ã€è§£æ±ºãƒ•ã‚§ãƒ¼ã‚ºï¼ˆ10-20åˆ†ï¼‰ã€‘æœ€çµ‚æ¨ç†ãƒ»çœŸç›¸å…¬é–‹ãƒ»å®Œçµ

## è¤‡é›‘ã•ãƒ¬ãƒ™ãƒ«å¯¾å¿œï¼ˆçŸ­æ™‚é–“ç‰¹åŒ–ï¼‰
### ã‚·ãƒ³ãƒ—ãƒ«ç‰ˆï¼ˆ30åˆ†å®Œçµï¼‰
[ã‚·ãƒ³ãƒ—ãƒ«ã§ç¢ºå®Ÿã«30åˆ†ã§å®Œçµã™ã‚‹æ§‹é€ ]

### æ¨™æº–ç‰ˆï¼ˆ45åˆ†å®Œçµï¼‰
[ãƒãƒ©ãƒ³ã‚¹è‰¯ã45åˆ†ã§å®Œçµã™ã‚‹æ§‹é€ ]

### è¤‡é›‘ç‰ˆï¼ˆ60åˆ†å®Œçµï¼‰
[è¤‡é›‘ã ãŒç¢ºå®Ÿã«1æ™‚é–“ã§å®Œçµã™ã‚‹æ§‹é€ ]

## ${formData.tone}ãƒˆãƒ¼ãƒ³å°‚ç”¨æ¼”å‡ºï¼ˆçŸ­æ™‚é–“ç‰¹åŒ–ï¼‰
[30åˆ†-1æ™‚é–“ã§æœ€å¤§åŠ¹æœã‚’ç™ºæ®ã™ã‚‹æ¼”å‡ºæ–¹æ³•]

ã€çµ¶å¯¾è¦æ±‚ã€‘
- å…¨ã¦ã®æ–‡ç« ã¯å®Œçµã—ã€ä¸­é€”åŠç«¯ãªè¡¨ç¾ã¯ä¸€åˆ‡ä½¿ç”¨ã—ãªã„ã“ã¨
- ä½œå“ã‚¿ã‚¤ãƒˆãƒ«ã¯æ—¢å­˜ã®ãƒãƒ¼ãƒ€ãƒ¼ãƒŸã‚¹ãƒ†ãƒªãƒ¼ä½œå“ã¨é‡è¤‡ã—ãªã„å®Œå…¨ã‚ªãƒªã‚¸ãƒŠãƒ«
- æ¯å›ç•°ãªã‚‹ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªã‚¿ã‚¤ãƒˆãƒ«ã‚’ç”Ÿæˆï¼ˆéå»ã®ç”Ÿæˆã‚¿ã‚¤ãƒˆãƒ«ã¨é‡è¤‡ç¦æ­¢ï¼‰
- ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—${Date.now()}ã‚’è€ƒæ…®ã—ãŸå®Œå…¨ã«ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªå‰µä½œ
`;

      const result = await aiClient.generateWithRetry(systemPrompt, userPrompt);
      console.log('âœ… æ®µéš1: åŸºæœ¬ã‚³ãƒ³ã‚»ãƒ—ãƒˆå®Œæˆ');
      return { concept: result.content };
    }
  },
  
  // === æ®µéš2: äº‹ä»¶æ ¸å¿ƒéƒ¨ã®è¨­è¨ˆ ===
  {
    name: 'æ®µéš2: äº‹ä»¶æ ¸å¿ƒãƒ»çŠ¯äººãƒ»å‹•æ©Ÿè¨­å®š',
    weight: 12,
    handler: async (formData, context) => {
      console.log('ğŸ•µï¸ æ®µéš2: äº‹ä»¶æ ¸å¿ƒéƒ¨è©³ç´°è¨­è¨ˆé–‹å§‹');
      
      const randomOutline = context.random_outline || '';
      const concept = context.concept || '';
      const systemPrompt = `ã‚ãªãŸã¯ãƒãƒ¼ãƒ€ãƒ¼ãƒŸã‚¹ãƒ†ãƒªãƒ¼ã®äº‹ä»¶è¨­è¨ˆã®ã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆã§ã™ã€‚
ãƒ©ãƒ³ãƒ€ãƒ ç”Ÿæˆã•ã‚ŒãŸå¤§ã¾ã‹ãªæ§‹é€ ã¨ç²¾å¯†åŒ–ã•ã‚ŒãŸã‚³ãƒ³ã‚»ãƒ—ãƒˆã‚’åŸºã«ã€äº‹ä»¶ã®æ ¸å¿ƒéƒ¨åˆ†ã‚’è©³ç´°ã«è¨­è¨ˆã—ã¦ãã ã•ã„ã€‚
ã“ã®æ®µéšã§ã¯çŠ¯äººã€å‹•æ©Ÿã€çŠ¯è¡Œæ‰‹æ®µã®å…·ä½“çš„ãªè©³ç´°ã‚’ç¢ºå®šã—ã¾ã™ã€‚`;
      
      const userPrompt = `
ã€äº‹ä»¶æ ¸å¿ƒéƒ¨è©³ç´°è¨­è¨ˆä¾é ¼ã€‘

ãƒ©ãƒ³ãƒ€ãƒ å…¨ä½“æ§‹é€ : ${randomOutline}
ç²¾å¯†åŒ–ã‚³ãƒ³ã‚»ãƒ—ãƒˆ: ${concept}
å‚åŠ äººæ•°: ${formData.participants}äºº
è¤‡é›‘ã•: ${formData.complexity}
ãƒˆãƒ¼ãƒ³: ${formData.tone}

ä»¥ä¸‹ã®å½¢å¼ã§äº‹ä»¶ã®æ ¸å¿ƒéƒ¨åˆ†ã‚’è¨­è¨ˆã—ã¦ãã ã•ã„ï¼š

## äº‹ä»¶ã®æ ¸å¿ƒæ§‹é€ 

### çŠ¯äººã®ç‰¹å®š
**çœŸã®çŠ¯äºº**: [ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ç•ªå·ã¾ãŸã¯NPCã‚’æ˜è¨˜]
**çŠ¯äººã®ç‰¹å¾´**: [äººç‰©åƒã¨æ€§æ ¼çš„ç‰¹å¾´]

### æ ¹æœ¬çš„å‹•æ©Ÿ
**ä¸»å‹•æ©Ÿ**: [çŠ¯è¡Œã®æœ€ã‚‚æ·±ã„å‹•æ©Ÿ]
**å‰¯æ¬¡çš„è¦å› **: [çŠ¯è¡Œã‚’å¾ŒæŠ¼ã—ã—ãŸçŠ¶æ³ã‚„æ„Ÿæƒ…]
**éš”ã—ãŸã„ç§˜å¯†**: [çŠ¯äººãŒæœ€ã‚‚éš ã—ãŸã„ã“ã¨]

### çŠ¯è¡Œæ‰‹æ®µãƒ»ãƒˆãƒªãƒƒã‚¯
**åŸºæœ¬çš„ãªæ‰‹æ®µ**: [30åˆ†-1æ™‚é–“ã§ç†è§£ã§ãã‚‹ã‚·ãƒ³ãƒ—ãƒ«ãªæ‰‹æ®µ]
**ä½¿ç”¨ã—ãŸãƒˆãƒªãƒƒã‚¯**: [ç‰¹åˆ¥ãªãƒˆãƒªãƒƒã‚¯ã‚„å·¥ä½œ]
**çŠ¯è¡Œæ™‚åˆ»**: [å…·ä½“çš„ãªæ™‚åˆ»ã¨çŠ¶æ³]

### é‡è¦ãªè¨¼æ‹ 
**ç‰©çš„è¨¼æ‹ **: [ç™ºè¦‹ã•ã‚Œã‚‹é‡è¦ãªç‰©è¨¼]
**çŠ¶æ³è¨¼æ‹ **: [ç¾å ´ã®çŠ¶æ³ã‚„ç—•è·¡]
**è¨¼è¨€è¨¼æ‹ **: [ç›®æ’ƒæƒ…å ±ã‚„é–¢é€£è€…ã®è¨¼è¨€]

### ãƒŸã‚¹ãƒªãƒ¼ãƒ‰è¦ç´ ï¼ˆç°¡æ½”ç‰ˆï¼‰
[çŸ­æ™‚é–“ã§æ•´ç†ã§ãã‚‹ç¨‹åº¦ã®é©åº¦ãªãƒŸã‚¹ãƒªãƒ¼ãƒ‰è¦ç´ ]

ã€é‡è¦ã€‘
- 30åˆ†-1æ™‚é–“ã§ç†è§£ãƒ»è§£æ±ºå¯èƒ½ãªç¯„å›²
- å¾Œã®æ®µéšã§è©³ç´°åŒ–ã•ã‚Œã‚‹ãŸã‚ã€æ ¸å¿ƒéƒ¨åˆ†ã«é›†ä¸­
- å…¨ã¦ã®æ–‡ç« ã‚’å®Œçµã•ã›ã‚‹
`;

      const result = await aiClient.generateWithRetry(systemPrompt, userPrompt);
      console.log('âœ… æ®µéš2: äº‹ä»¶æ ¸å¿ƒéƒ¨å®Œæˆ');
      return { incident_core: result.content };
    }
  },

  // === æ®µéš3: äº‹ä»¶è©³ç´°ãƒ»ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³æ§‹ç¯‰ ===
  {
    name: 'æ®µéš3: äº‹ä»¶è©³ç´°ãƒ»åŸºæœ¬ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³',
    weight: 15,
    handler: async (formData, context) => {
      console.log('â° æ®µéš3: äº‹ä»¶è©³ç´°ãƒ»ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³æ§‹ç¯‰é–‹å§‹');
      
      const concept = context.concept || '';
      const incidentCore = context.incident_core || '';
      const systemPrompt = `ã‚ãªãŸã¯ãƒãƒ¼ãƒ€ãƒ¼ãƒŸã‚¹ãƒ†ãƒªãƒ¼ã®äº‹ä»¶è©³ç´°è¨­è¨ˆã®ã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆã§ã™ã€‚
30åˆ†-1æ™‚é–“ã‚»ãƒƒã‚·ãƒ§ãƒ³ç”¨ã®è©³ç´°ãªäº‹ä»¶ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã¨çŠ¶æ³ã‚’æ®µéšçš„ã«æ§‹ç¯‰ã—ã¦ãã ã•ã„ã€‚
ã“ã®æ®µéšã§ã¯ã€ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç”Ÿæˆã®å‰æ®µéšã¨ã—ã¦äº‹ä»¶ã®è©³ç´°ã‚’ç¢ºå®šã—ã¾ã™ã€‚`;
      
      const userPrompt = `
ã€äº‹ä»¶è©³ç´°ãƒ»ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³æ§‹ç¯‰ä¾é ¼ã€‘

åŸºæœ¬ã‚³ãƒ³ã‚»ãƒ—ãƒˆ: ${concept}
äº‹ä»¶æ ¸å¿ƒéƒ¨: ${incidentCore}
å‚åŠ äººæ•°: ${formData.participants}äºº
è¤‡é›‘ã•: ${formData.complexity}

ä»¥ä¸‹ã®å½¢å¼ã§äº‹ä»¶ã®è©³ç´°ã¨ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚’æ§‹ç¯‰ã—ã¦ãã ã•ã„ï¼š

## äº‹ä»¶ç™ºç”Ÿå‰ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ï¼ˆç°¡æ½”ç‰ˆï¼‰
### é‡è¦å‰å²ï¼ˆäº‹ä»¶1é€±é–“å‰ã€œï¼‰
[äº‹ä»¶ã«ç›´çµã™ã‚‹å¿…è¦æœ€å°é™ã®èƒŒæ™¯äº‹æƒ…]

### äº‹ä»¶å½“æ—¥ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ï¼ˆè©³ç´°ç‰ˆï¼‰
**åˆå‰**:
- [æ™‚åˆ»]: [å‡ºæ¥äº‹ãƒ»äººç‰©ã®è¡Œå‹•]

**åˆå¾Œ**:
- [æ™‚åˆ»]: [å‡ºæ¥äº‹ãƒ»äººç‰©ã®è¡Œå‹•]  

**å¤œé–“**:
- [æ™‚åˆ»]: [äº‹ä»¶ç™ºç”Ÿã¨ãã®å‰å¾Œã®çŠ¶æ³]

## äº‹ä»¶ç¾å ´è©³ç´°
### ç¾å ´ã®çŠ¶æ³
[ç™ºè¦‹æ™‚ã®è©³ç´°ãªç¾å ´çŠ¶æ³ãƒ»è¨¼æ‹ é…ç½®]

### é‡è¦ãªç‰©çš„è¨¼æ‹ 
[ç¾å ´ã§ç™ºè¦‹ã•ã‚Œã‚‹æ±ºå®šçš„è¨¼æ‹ ã®ãƒªã‚¹ãƒˆ]

### è¨¼è¨€ãƒ»ç›®æ’ƒæƒ…å ±
[å„é–¢ä¿‚è€…ã‹ã‚‰ã®é‡è¦ãªè¨¼è¨€ã‚„ç›®æ’ƒæƒ…å ±]

## ã‚¢ãƒªãƒã‚¤ãƒ»è¡Œå‹•ãƒ‘ã‚¿ãƒ¼ãƒ³
### äº‹ä»¶æ™‚åˆ»å‘¨è¾ºã®äººç‰©å‹•å‘
[å„é–¢ä¿‚è€…ã®äº‹ä»¶æ™‚åˆ»å‰å¾Œã®è¡Œå‹•ãƒ»ã‚¢ãƒªãƒã‚¤çŠ¶æ³]

## ${formData.complexity}ãƒ¬ãƒ™ãƒ«å¯¾å¿œèª¿æ•´
### ã‚·ãƒ³ãƒ—ãƒ«ç‰ˆï¼ˆ30åˆ†ï¼‰è¦ç´ 
[30åˆ†ã§è§£æ±ºå¯èƒ½ãªç°¡ç´ åŒ–è¦ç´ ]

### æ¨™æº–ç‰ˆï¼ˆ45åˆ†ï¼‰è¦ç´   
[é©åº¦ãªè¤‡é›‘ã•ã®ä¸­ç´šè¦ç´ ]

### è¤‡é›‘ç‰ˆï¼ˆ60åˆ†ï¼‰è¦ç´ 
[1æ™‚é–“å¿…è¦ãªé«˜åº¦ãªè¦ç´ ]

ã€é‡è¦ã€‘
- å¾Œã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç”Ÿæˆã§æ´»ç”¨ã•ã‚Œã‚‹è©³ç´°æƒ…å ±
- 30åˆ†-1æ™‚é–“ã§ç¢ºå®Ÿã«è§£æ±ºå¯èƒ½ãªæ§‹é€ 
- å…¨ã¦ã®æ–‡ç« ã‚’å®Œçµã•ã›ã‚‹
`;

      const result = await aiClient.generateWithRetry(systemPrompt, userPrompt);
      console.log('âœ… æ®µéš3: äº‹ä»¶è©³ç´°ãƒ»ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³å®Œæˆ');
      return { incident_details: result.content };
    }
  },

  // === æ®µéš4: æ®µéšçš„ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç”Ÿæˆã‚·ã‚¹ãƒ†ãƒ  ===
  {
    name: 'æ®µéš4: æ®µéšçš„ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç”Ÿæˆã‚·ã‚¹ãƒ†ãƒ ',
    weight: 35,
    handler: async (formData, context) => {
      try {
        const randomOutline = context.random_outline || '';
        const concept = context.concept || '';
        const incidentCore = context.incident_core || '';
        const incidentDetails = context.incident_details || '';
        const participantCount = parseInt(formData.participants) || 5;
        
        console.log(`ğŸ‘¥ æ®µéšçš„ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç”Ÿæˆé–‹å§‹: ${participantCount}äºº`);
        
        let allCharacters = [];
        let characterRelationships = '';
        
        // æ®µéš1: å„ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’å€‹åˆ¥ã«ç”Ÿæˆ
        for (let i = 1; i <= participantCount; i++) {
          console.log(`ğŸ­ ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${i}ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç”Ÿæˆä¸­...`);
          
          const systemPrompt = `ã‚ãªãŸã¯ã€Œç‹‚æ°—å±±è„ˆã€€é™°è¬€ã®åˆ†æ°´å¶ºã€ãƒ¬ãƒ™ãƒ«ã®ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ãƒãƒ¼ãƒ€ãƒ¼ãƒŸã‚¹ãƒ†ãƒªãƒ¼ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¨­è¨ˆå°‚é–€å®¶ã§ã™ã€‚
30åˆ†-1æ™‚é–“ã‚»ãƒƒã‚·ãƒ§ãƒ³ç”¨ã®é­…åŠ›çš„ã§è¤‡é›‘ãªã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’ä¸€äººãšã¤ä¸å¯§ã«ä½œæˆã—ã¦ãã ã•ã„ã€‚`;
          
          const userPrompt = `
ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${i}å°‚ç”¨ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ä½œæˆã€‘

ãƒ©ãƒ³ãƒ€ãƒ å…¨ä½“æ§‹é€ : ${randomOutline}
ä½œå“æƒ…å ±: ${concept}
äº‹ä»¶æ ¸å¿ƒ: ${incidentCore}
äº‹ä»¶è©³ç´°: ${incidentDetails}
å‚åŠ äººæ•°: ${participantCount}äººä¸­ã®${i}äººç›®
æ—¢å­˜ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼: ${allCharacters.length > 0 ? allCharacters.map((c, idx) => `ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${idx + 1}: ${c.name || 'æœªè¨­å®š'}`).join(', ') : 'ãªã—'}

ä»¥ä¸‹ã®å½¢å¼ã§ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${i}ã®å®Œå…¨ãªãƒãƒ³ãƒ‰ã‚¢ã‚¦ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„ï¼š

## ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${i}å°‚ç”¨ãƒãƒ³ãƒ‰ã‚¢ã‚¦ãƒˆã€‘

### ã‚ãªãŸã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼
**æ°å**: [ãƒ•ãƒ«ãƒãƒ¼ãƒ  - æ—¢å­˜ã‚­ãƒ£ãƒ©ã¨é‡è¤‡ã—ãªã„ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªåå‰]
**å¹´é½¢**: [å…·ä½“çš„ãªå¹´é½¢]
**è·æ¥­**: [è©³ç´°ãªè·æ¥­ãƒ»ç«‹å ´ãƒ»ç¤¾ä¼šçš„ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹]
**æ€§æ ¼**: [å€‹æ€§çš„ã§è¨˜æ†¶ã«æ®‹ã‚‹æ€§æ ¼ç‰¹å¾´]
**å¤–è¦‹**: [ç‰¹å¾´çš„ãªå¤–è¦‹ã‚„æœè£…]

### ã‚ãªãŸã®èƒŒæ™¯ã¨å‹•æ©Ÿ
[ã“ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®è©³ç´°ãªèƒŒæ™¯ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã€‚äº‹ä»¶ã¨ã®é–¢é€£ã€å‹•æ©Ÿã€éå»ã®çµŒé¨“ã‚’400æ–‡å­—ç¨‹åº¦ã§è©³ç´°ã«èª¬æ˜]

### ã‚ãªãŸã ã‘ãŒçŸ¥ã£ã¦ã„ã‚‹ç§˜å¯†
**é‡è¦ãªç§˜å¯†**: [äº‹ä»¶ã«é–¢é€£ã™ã‚‹æ±ºå®šçš„ãªç§˜å¯†æƒ…å ±]
**éš ã—ãŸã„ã“ã¨**: [ä»–ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«çŸ¥ã‚‰ã‚ŒãŸããªã„ã“ã¨]
**ç‰¹åˆ¥ãªçŸ¥è­˜**: [äº‹ä»¶è§£æ±ºã«é–¢ã‚ã‚‹ç‰¹åˆ¥ãªæƒ…å ±ã‚„çŸ¥è­˜]

### ã‚ãªãŸã®ç›®æ¨™ã¨è¡Œå‹•æŒ‡é‡
**ä¸»ç›®æ¨™**: [ã‚»ãƒƒã‚·ãƒ§ãƒ³ã§é”æˆã—ãŸã„ä¸»ãªç›®æ¨™]
**ç§˜å¯†ã®ç›®æ¨™**: [ä»–ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«çŸ¥ã‚‰ã‚ŒãŸããªã„çœŸã®ç›®çš„]
**è¡Œå‹•æŒ‡é‡**: [ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸­ã®å…·ä½“çš„ãªè¡Œå‹•æ–¹é‡]

### é‡è¦ãªæ‰€æŒå“ãƒ»è¨¼æ‹ 
[æŒã£ã¦ã„ã‚‹é‡è¦ãªã‚¢ã‚¤ãƒ†ãƒ ã€è¨¼æ‹ ã€æ‰‹ãŒã‹ã‚Šã®è©³ç´°ãƒªã‚¹ãƒˆ]

### ä»–ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¨ã®é–¢ä¿‚æ€§ï¼ˆæ—¢çŸ¥ã®å ´åˆï¼‰
${allCharacters.length > 0 ? allCharacters.map((c, idx) => `**ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${idx + 1}(${c.name})ã¨ã®é–¢ä¿‚**: [å…·ä½“çš„ãªé–¢ä¿‚æ€§ã€æ„Ÿæƒ…ã€éå»ã®çµŒç·¯]`).join('\n') : '[ä»–ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãŒæ±ºã¾ã£ãŸå¾Œã§è¨­å®šã•ã‚Œã¾ã™]'}

ã€çµ¶å¯¾è¦æ±‚ã€‘
- æ—¢å­˜ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã¨ã®åå‰é‡è¤‡ç¦æ­¢
- äº‹ä»¶ã¨æœ‰æ„ç¾©ãªé–¢é€£æ€§ã‚’æŒãŸã›ã‚‹
- 30åˆ†-1æ™‚é–“ã§æ¼”ã˜åˆ‡ã‚Œã‚‹ç¨‹åº¦ã®è¤‡é›‘ã•
- å…¨ã¦ã®æ–‡ç« ã‚’å®Œçµã•ã›ã‚‹
`;

          const characterResult = await aiClient.generateWithRetry(systemPrompt, userPrompt);
          
          // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼æƒ…å ±ã‚’æŠ½å‡ºã—ã¦ä¿å­˜
          const nameMatch = characterResult.content.match(/\*\*æ°å\*\*:\s*([^\n]+)/);
          const character = {
            playerId: i,
            name: nameMatch ? nameMatch[1].replace(/\[|\]/g, '').trim() : `ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${i}`,
            handout: characterResult.content
          };
          
          allCharacters.push(character);
          console.log(`âœ… ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${i} (${character.name}) ç”Ÿæˆå®Œäº†`);
        }
        
        // æ®µéš2: å…¨ä½“ã®é–¢ä¿‚æ€§ã‚’èª¿æ•´ã—ã€ã¤ã˜ã¤ã¾ã‚’åˆã‚ã›ã‚‹
        console.log('ğŸ”— å…¨ä½“ã®é–¢ä¿‚æ€§èª¿æ•´ä¸­...');
        
        const relationshipSystemPrompt = `ã‚ãªãŸã¯ãƒãƒ¼ãƒ€ãƒ¼ãƒŸã‚¹ãƒ†ãƒªãƒ¼ã®é–¢ä¿‚æ€§èª¿æ•´ã®ã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆã§ã™ã€‚
å„ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼é–“ã®é–¢ä¿‚æ€§ã‚’èª¿æ•´ã—ã€å…¨ä½“ã®ã¤ã˜ã¤ã¾ã‚’åˆã‚ã›ã¦ãã ã•ã„ã€‚`;
        
        const relationshipUserPrompt = `
ã€é–¢ä¿‚æ€§èª¿æ•´ä¾é ¼ã€‘

ãƒ©ãƒ³ãƒ€ãƒ å…¨ä½“æ§‹é€ : ${randomOutline}
ä½œå“æƒ…å ±: ${concept}
äº‹ä»¶æ ¸å¿ƒ: ${incidentCore}
äº‹ä»¶è©³ç´°: ${incidentDetails}

ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ä¸€è¦§:
${allCharacters.map((c, idx) => `${idx + 1}. ${c.name}`).join('\n')}

ä»¥ä¸‹ã®å½¢å¼ã§å…¨ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼é–“ã®é–¢ä¿‚æ€§ã‚’è¨­å®šã—ã¦ãã ã•ã„ï¼š

## ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼é–¢ä¿‚å›³

${allCharacters.map((c1, i) => 
  allCharacters.map((c2, j) => {
    if (i !== j) {
      return `### ${c1.name} â†’ ${c2.name}\n[å…·ä½“çš„ãªé–¢ä¿‚æ€§ã€æ„Ÿæƒ…ã€éå»ã®çµŒç·¯ã€ç¾åœ¨ã®çŠ¶æ³]`;
    }
    return '';
  }).filter(r => r).join('\n\n')
).join('\n\n')}

## é–¢ä¿‚æ€§ã®ç‰¹å¾´
- ã‚°ãƒ«ãƒ¼ãƒ—å†…ã®åŠ›é–¢ä¿‚
- ç§˜å¯†ã‚’å…±æœ‰ã™ã‚‹é–¢ä¿‚
- å¯¾ç«‹ã—ã¦ã„ã‚‹é–¢ä¿‚
- ã‚¢ãƒªãƒã‚¤ã‚’æä¾›ã—åˆã†é–¢ä¿‚

ã€é‡è¦ã€‘äº‹ä»¶ã®è¤‡é›‘ã•ã¨è¬è§£ãã«é©ã—ãŸçµ¶å¦™ãªãƒãƒ©ãƒ³ã‚¹ã‚’ä¿ã¤ã“ã¨ã€‚
`;

        const relationshipResult = await aiClient.generateWithRetry(relationshipSystemPrompt, relationshipUserPrompt);
        characterRelationships = relationshipResult.content;
        
        // æ®µéš3: å„ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®ãƒãƒ³ãƒ‰ã‚¢ã‚¦ãƒˆã‚’é–¢ä¿‚æ€§æƒ…å ±ã§æ›´æ–°
        console.log('ğŸ”„ ãƒãƒ³ãƒ‰ã‚¢ã‚¦ãƒˆã®é–¢ä¿‚æ€§æƒ…å ±æ›´æ–°ä¸­...');
        
        for (let i = 0; i < allCharacters.length; i++) {
          const character = allCharacters[i];
          const systemPrompt = `ã‚ãªãŸã¯ãƒãƒ¼ãƒ€ãƒ¼ãƒŸã‚¹ãƒ†ãƒªãƒ¼ã®ãƒãƒ³ãƒ‰ã‚¢ã‚¦ãƒˆæ›´æ–°å°‚é–€å®¶ã§ã™ã€‚
æ—¢å­˜ã®ãƒãƒ³ãƒ‰ã‚¢ã‚¦ãƒˆã«é–¢ä¿‚æ€§æƒ…å ±ã‚’çµ±åˆã—ã¦ãã ã•ã„ã€‚`;
          
          const userPrompt = `
ã€ãƒãƒ³ãƒ‰ã‚¢ã‚¦ãƒˆæ›´æ–°ä¾é ¼ã€‘

å¯¾è±¡ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼: ${character.name} (ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${character.playerId})

ç¾åœ¨ã®ãƒãƒ³ãƒ‰ã‚¢ã‚¦ãƒˆ:
${character.handout}

å…¨ä½“ã®é–¢ä¿‚æ€§æƒ…å ±:
${characterRelationships}

ä¸Šè¨˜ã®é–¢ä¿‚æ€§æƒ…å ±ã‚’åŸºã«ã€ã€Œä»–ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¨ã®é–¢ä¿‚æ€§ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’æ›´æ–°ã—ãŸå®Œå…¨ãªãƒãƒ³ãƒ‰ã‚¢ã‚¦ãƒˆã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚

ã€è¦æ±‚ã€‘
- é–¢ä¿‚æ€§æƒ…å ±ã‚’è©³ç´°ã§å…·ä½“çš„ã«è¿½åŠ 
- ä»–ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã¨ã®é¢è­˜ã‚„é–¢ä¿‚ã‚’æ˜ç¢ºåŒ–
- ã‚²ãƒ¼ãƒ ä¸­ã®è¡Œå‹•æŒ‡é‡ã«é–¢ä¿‚æ€§ã‚’åæ˜ 
- å…ƒã®ãƒãƒ³ãƒ‰ã‚¢ã‚¦ãƒˆã®å“è³ªã‚’ç¶­æŒ
`;

          const updatedHandout = await aiClient.generateWithRetry(systemPrompt, userPrompt);
          allCharacters[i].handout = updatedHandout.content;
          console.log(`âœ… ${character.name}ã®ãƒãƒ³ãƒ‰ã‚¢ã‚¦ãƒˆæ›´æ–°å®Œäº†`);
        }
        
        // æœ€çµ‚çµæœã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        const finalCharacterHandouts = allCharacters.map(c => c.handout).join('\n\n---\n\n');
        
        console.log('ğŸ‰ æ®µéšçš„ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç”Ÿæˆå®Œäº†!');
        
        return {
          characters: finalCharacterHandouts,
          character_relationships: characterRelationships,
          character_count: participantCount,
          character_list: allCharacters.map(c => ({ name: c.name, playerId: c.playerId }))
        };
        
      } catch (error) {
        console.error('âŒ æ®µéšçš„ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç”Ÿæˆã‚¨ãƒ©ãƒ¼:', error);
        
        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ã‚·ãƒ³ãƒ—ãƒ«ãªã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç”Ÿæˆ
        const participantCount = parseInt(formData.participants) || 5;
        const fallbackCharacters = generateFallbackCharacters(participantCount);
        
        return { characters: fallbackCharacters };
      }
    }
  },

  // === æ®µéš5: è¨¼æ‹ é…ç½®ãƒ»æ‰‹ãŒã‹ã‚Šè¨­è¨ˆ ===
  {
    name: 'æ®µéš5: è¨¼æ‹ é…ç½®ãƒ»æ‰‹ãŒã‹ã‚Šä½“ç³»åŒ–',
    weight: 18,
    handler: async (formData, context) => {
      console.log('ğŸ” æ®µéš5: è¨¼æ‹ é…ç½®ãƒ»æ‰‹ãŒã‹ã‚Šä½“ç³»åŒ–é–‹å§‹');
      
      const concept = context.concept || '';
      const incidentCore = context.incident_core || '';
      const incidentDetails = context.incident_details || '';
      const characters = context.characters || '';
      
      const systemPrompt = `ã‚ãªãŸã¯ãƒãƒ¼ãƒ€ãƒ¼ãƒŸã‚¹ãƒ†ãƒªãƒ¼ã®è¨¼æ‹ é…ç½®ã¨ãƒ’ãƒ³ãƒˆã‚·ã‚¹ãƒ†ãƒ è¨­è¨ˆã®å°‚é–€å®¶ã§ã™ã€‚
30åˆ†-1æ™‚é–“ã§ç¢ºå®Ÿã«è§£æ±ºå¯èƒ½ãªã€æ®µéšçš„ã§è«–ç†çš„ãªè¨¼æ‹ é…ç½®ã‚·ã‚¹ãƒ†ãƒ ã‚’æ§‹ç¯‰ã—ã¦ãã ã•ã„ã€‚
ã“ã®æ®µéšã§ã¯ã€ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã¨äº‹ä»¶è©³ç´°ã‚’åŸºã«ã—ãŸå…·ä½“çš„ãªè¨¼æ‹ ãƒ»æ‰‹ãŒã‹ã‚Šã®é…ç½®ã‚’è¡Œã„ã¾ã™ã€‚`;
      
      const userPrompt = `
ã€è¨¼æ‹ é…ç½®ãƒ»æ‰‹ãŒã‹ã‚Šä½“ç³»åŒ–ä¾é ¼ã€‘

åŸºæœ¬æƒ…å ±: ${concept}
äº‹ä»¶æ ¸å¿ƒ: ${incidentCore}
äº‹ä»¶è©³ç´°: ${incidentDetails}
ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼æƒ…å ±: ${characters}
è¤‡é›‘ã•ãƒ¬ãƒ™ãƒ«: ${formData.complexity}
ãƒˆãƒ¼ãƒ³: ${formData.tone}
ç‰¹æ®Šè¦ç´ :
- ãƒ¬ãƒƒãƒ‰ãƒ˜ãƒªãƒ³ã‚°: ${formData.red_herring ? 'ã‚ã‚Š' : 'ãªã—'}
- ã©ã‚“ã§ã‚“è¿”ã—: ${formData.twist_ending ? 'ã‚ã‚Š' : 'ãªã—'}
- ç§˜å¯†ã®å½¹å‰²: ${formData.secret_roles ? 'ã‚ã‚Š' : 'ãªã—'}

ä»¥ä¸‹ã®å½¢å¼ã§è¨¼æ‹ é…ç½®ã‚·ã‚¹ãƒ†ãƒ ã‚’æ§‹ç¯‰ã—ã¦ãã ã•ã„ï¼š

ã€çµ¶å¯¾æ¡ä»¶ã€‘
- 30åˆ†-1æ™‚é–“ã§å®Œå…¨è§£æ±ºå¯èƒ½
- æ–‡ç« ã¯å¿…ãšå®Œçµã—ã€åˆ‡ã‚Œã‚„ä¸å®Œå…¨ãªéƒ¨åˆ†ã¯ä¸€åˆ‡ãªã—
- è«–ç†çš„ã§æ¤œè¨¼å¯èƒ½ãªè¬æ§‹é€ 
- ç„¡é§„ãªè¦ç´ ã¯ä¸€åˆ‡æ’é™¤

## äº‹ä»¶ç™ºç”Ÿãƒ»ç™ºè¦‹ã‚·ãƒ¼ãƒ³ï¼ˆå®Œçµç‰ˆï¼‰
- **äº‹ä»¶ç™ºç”Ÿã®ç¬é–“**: [300æ–‡å­—ç¨‹åº¦ã®ç°¡æ½”ã§å®Œç’§ãªçŠ¶æ³èª¬æ˜]
- **ç™ºè¦‹ã‚·ãƒ¼ãƒ³**: [200æ–‡å­—ç¨‹åº¦ã®æ˜ç¢ºãªç™ºè¦‹çŠ¶æ³]
- **åˆæœŸçŠ¶æ³**: [å‚åŠ è€…å…¨å“¡ã®åˆæœŸåå¿œã‚’çŸ­æ™‚é–“ã§æŠŠæ¡]

## çŸ­æ™‚é–“è§£æ±ºæ§‹é€ ï¼ˆ30åˆ†-1æ™‚é–“ç‰¹åŒ–ï¼‰
### ã€å°å…¥æ®µéšï¼ˆ5åˆ†ï¼‰ã€‘äº‹ä»¶ç™ºç”Ÿãƒ»åŸºæœ¬çŠ¶æ³æŠŠæ¡
- æ˜ç¢ºã§ç†è§£ã—ã‚„ã™ã„åˆæœŸæƒ…å ±
- å³åº§ã«èª¿æŸ»ã«å…¥ã‚Œã‚‹çŠ¶æ³è¨­å®š

### ã€èª¿æŸ»æ®µéšï¼ˆ15-35åˆ†ï¼‰ã€‘è¨¼æ‹ åé›†ãƒ»æ¨ç†æ§‹ç¯‰
- åŠ¹ç‡çš„ã«ç™ºè¦‹ã§ãã‚‹æ±ºå®šçš„è¨¼æ‹ 
- çŸ­æ™‚é–“ã§è«–ç†æ§‹ç¯‰å¯èƒ½ãªæ‰‹ãŒã‹ã‚Šé…ç½®

### ã€è§£æ±ºæ®µéšï¼ˆ10-20åˆ†ï¼‰ã€‘çœŸç›¸ç©¶æ˜ãƒ»å®Œçµ
- ç¢ºå®Ÿã«è§£æ±ºã«å°ãæœ€çµ‚è¨¼æ‹ 
- æº€è¶³æ„Ÿã®ã‚ã‚‹å®Œç’§ãªè§£æ±º

## å®Œç’§ãªçœŸç›¸ãƒ»çŠ¯è¡Œæ§‹é€ ï¼ˆçŸ­æ™‚é–“ç‰¹åŒ–ï¼‰
- **çœŸã®çŠ¯äºº**: [çŸ­æ™‚é–“ã§ç†è§£ã§ãã‚‹æ˜ç¢ºãªçŠ¯äººåƒã¨å‹•æ©Ÿ]
- **çŠ¯è¡Œæ‰‹é †**: [ç°¡æ½”ã§è«–ç†çš„ãªçŠ¯è¡Œéç¨‹]
- **ä½¿ç”¨ãƒˆãƒªãƒƒã‚¯**: [çŸ­æ™‚é–“ã§æ¤œè¨¼å¯èƒ½ãªã‚·ãƒ³ãƒ—ãƒ«ã§å·§å¦™ãªãƒˆãƒªãƒƒã‚¯]
- **æ±ºå®šçš„è¨¼æ‹ **: [30åˆ†-1æ™‚é–“ã§ç¢ºå®Ÿã«ç™ºè¦‹ã•ã‚Œã‚‹è¨¼æ‹ ]

## çŸ­æ™‚é–“å¯¾å¿œè¨¼æ‹ ã‚·ã‚¹ãƒ†ãƒ 
### ã€æ®µéšåˆ¥è¨¼æ‹ é…ç½®ã€‘
- å°å…¥æ®µéš: [åŸºæœ¬çš„ãªç‰©çš„è¨¼æ‹ ãƒ»ç¾å ´çŠ¶æ³]
- èª¿æŸ»æ®µéšå‰åŠ: [ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¨¼è¨€ãƒ»åˆæœŸæ‰‹ãŒã‹ã‚Š]
- èª¿æŸ»æ®µéšå¾ŒåŠ: [éš ã•ã‚ŒãŸè¨¼æ‹ ãƒ»é‡è¦ãªçŸ›ç›¾]
- è§£æ±ºæ®µéš: [æ±ºå®šçš„è¨¼æ‹ ãƒ»å®Œå…¨ãªçœŸç›¸]

### ã€ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼åˆ¥é‡è¦æƒ…å ±ã€‘
[å„ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãŒæŒã¤çŸ­æ™‚é–“ã§æ´»ç”¨ã§ãã‚‹é‡è¦æƒ…å ±]

## è¤‡é›‘ã•åˆ¥èª¿æ•´ï¼ˆçŸ­æ™‚é–“ç‰¹åŒ–ï¼‰
### ã‚·ãƒ³ãƒ—ãƒ«ç‰ˆï¼ˆ30åˆ†ï¼‰: [æœ€å°é™ã®è¦ç´ ã§ç¢ºå®Ÿã«è§£æ±º]
### æ¨™æº–ç‰ˆï¼ˆ45åˆ†ï¼‰: [é©åº¦ãªè¤‡é›‘ã•ã§æº€è¶³æ„Ÿã‚ã‚‹è§£æ±º]
### è¤‡é›‘ç‰ˆï¼ˆ60åˆ†ï¼‰: [è¤‡é›‘ã ãŒ1æ™‚é–“ã§ç¢ºå®Ÿã«å®Œçµ]

## ${formData.tone}ãƒˆãƒ¼ãƒ³å°‚ç”¨è¦ç´ ï¼ˆçŸ­æ™‚é–“ç‰¹åŒ–ï¼‰
[30åˆ†-1æ™‚é–“ã§æœ€å¤§åŠ¹æœã‚’ç™ºæ®ã™ã‚‹æ¼”å‡ºæ–¹æ³•]

ã€çµ¶å¯¾è¦æ±‚ã€‘å…¨ã¦ã®æ–‡ç« ã¯å®Œçµã—ã€ä¸­é€”åŠç«¯ã‚„ä¸å®Œå…¨ãªè¡¨ç¾ã¯ä¸€åˆ‡ä½¿ç”¨ã—ãªã„ã“ã¨ã€‚
`;

      const result = await aiClient.generateWithRetry(systemPrompt, userPrompt);
      console.log('âœ… æ®µéš5: è¨¼æ‹ é…ç½®ãƒ»æ‰‹ãŒã‹ã‚Šä½“ç³»åŒ–å®Œæˆ');
      return { evidence_system: result.content };
    }
  },

  // === æ®µéš6: GMé€²è¡Œã‚¬ã‚¤ãƒ‰ä½œæˆ ===
  {
    name: 'æ®µéš6: GMé€²è¡Œã‚¬ã‚¤ãƒ‰ãƒ»ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†',
    weight: 20,
    handler: async (formData, context) => {
      console.log('ğŸ“ æ®µéš6: GMé€²è¡Œã‚¬ã‚¤ãƒ‰ãƒ»ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ä½œæˆé–‹å§‹');
      
      const concept = context.concept || '';
      const incidentCore = context.incident_core || '';
      const incidentDetails = context.incident_details || '';
      const characters = context.characters || '';
      const evidenceSystem = context.evidence_system || '';
      
      const systemPrompt = `ã‚ãªãŸã¯ã€Œç‹‚æ°—å±±è„ˆã€€é™°è¬€ã®åˆ†æ°´å¶ºã€ãƒ¬ãƒ™ãƒ«ã®ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«GMï¼ˆã‚²ãƒ¼ãƒ ãƒã‚¹ã‚¿ãƒ¼ï¼‰ã§ã™ã€‚
30åˆ†-1æ™‚é–“ã‚»ãƒƒã‚·ãƒ§ãƒ³ç”¨ã®å®Œç’§ãªGMé€²è¡Œã‚¬ã‚¤ãƒ‰ã‚’ã€ã“ã‚Œã¾ã§ã®å…¨æ®µéšã®æƒ…å ±ã‚’çµ±åˆã—ã¦ä½œæˆã—ã¦ãã ã•ã„ã€‚
å®Ÿéš›ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³é‹å–¶ã§å³åº§ã«ä½¿ç”¨ã§ãã‚‹å®Ÿç”¨çš„ãªã‚¬ã‚¤ãƒ‰ã«ä»•ä¸Šã’ã¦ãã ã•ã„ã€‚`;
      
      const userPrompt = `
ã€GMé€²è¡Œã‚¬ã‚¤ãƒ‰çµ±åˆä½œæˆä¾é ¼ã€‘

åŸºæœ¬æƒ…å ±: ${concept}
äº‹ä»¶æ ¸å¿ƒ: ${incidentCore}
äº‹ä»¶è©³ç´°: ${incidentDetails}
ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼æƒ…å ±: ${characters}
è¨¼æ‹ ã‚·ã‚¹ãƒ†ãƒ : ${evidenceSystem}
è¤‡é›‘ã•: ${formData.complexity}

ã€è¶…é‡è¦ã€‘30åˆ†-1æ™‚é–“ã§å®Œå…¨ã«å®Œçµã™ã‚‹ã‚»ãƒƒã‚·ãƒ§ãƒ³é€²è¡Œã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚’æ§‹ç¯‰ã—ã¦ãã ã•ã„ã€‚

ã€çµ¶å¯¾æ¡ä»¶ã€‘
- 30åˆ†-1æ™‚é–“ã§ç¢ºå®Ÿã«å®Œçµ
- æ–‡ç« ã¯å¿…ãšå®Œçµã—ã€åˆ‡ã‚Œã‚„ä¸å®Œå…¨ãªéƒ¨åˆ†ã¯ä¸€åˆ‡ãªã—
- åŠ¹ç‡çš„ã§æº€è¶³æ„Ÿã®ã‚ã‚‹é€²è¡Œ
- ç„¡é§„ãªæ™‚é–“ã¯ä¸€åˆ‡æ’é™¤

## äº‹ä»¶ç™ºç”Ÿå‰ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ï¼ˆç°¡æ½”ç‰ˆï¼‰
- **é‡è¦å‰å²**: [äº‹ä»¶ã«ç›´çµã™ã‚‹å¿…è¦æœ€å°é™ã®èƒŒæ™¯]
- **é–¢ä¿‚æ€§**: [çŸ­æ™‚é–“ã§ç†è§£ã§ãã‚‹äººç‰©é–¢ä¿‚]
- **çŠ¯è¡Œæº–å‚™**: [ç°¡æ½”ã§è«–ç†çš„ãªçŠ¯è¡Œæº–å‚™éç¨‹]

## äº‹ä»¶ç™ºç”Ÿã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ï¼ˆå®Œçµç‰ˆï¼‰
- **ç™ºç”Ÿæ™‚åˆ»**: [æ˜ç¢ºãªäº‹ä»¶ç™ºç”Ÿã‚¿ã‚¤ãƒŸãƒ³ã‚°]
- **ç™ºè¦‹çµŒç·¯**: [ç¬¬ä¸€ç™ºè¦‹ã¾ã§ã®ç°¡æ½”ãªçµŒç·¯]
- **åˆæœŸçŠ¶æ³**: [å‚åŠ è€…ãŒå³åº§ã«ç†è§£ã§ãã‚‹çŠ¶æ³]

## 30åˆ†-1æ™‚é–“å®Œå…¨é€²è¡Œè¡¨

### ã€è¤‡é›‘ã•åˆ¥æ™‚é–“æ§‹æˆã€‘

#### ã‚·ãƒ³ãƒ—ãƒ«ç‰ˆï¼ˆ30åˆ†å®Œçµï¼‰
- **å°å…¥ï¼ˆ5åˆ†ï¼‰**: ãƒ«ãƒ¼ãƒ«èª¬æ˜ãƒ»äº‹ä»¶ç™ºç”Ÿãƒ»çŠ¶æ³æŠŠæ¡
- **èª¿æŸ»ï¼ˆ20åˆ†ï¼‰**: è¨¼æ‹ åé›†ãƒ»è¨¼è¨€è´å–ãƒ»æ¨ç†æ§‹ç¯‰
- **è§£æ±ºï¼ˆ5åˆ†ï¼‰**: æœ€çµ‚æ¨ç†ãƒ»çœŸç›¸å…¬é–‹ãƒ»å®Œçµ

#### æ¨™æº–ç‰ˆï¼ˆ45åˆ†å®Œçµï¼‰
- **å°å…¥ï¼ˆ7åˆ†ï¼‰**: ãƒ«ãƒ¼ãƒ«èª¬æ˜ãƒ»ä¸–ç•Œè¦³ãƒ»äº‹ä»¶ç™ºç”Ÿ
- **èª¿æŸ»ï¼ˆ30åˆ†ï¼‰**: è©³ç´°è¨¼æ‹ åé›†ãƒ»ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å°‹å•ãƒ»æ¨ç†
- **è§£æ±ºï¼ˆ8åˆ†ï¼‰**: æ¨ç†ç™ºè¡¨ãƒ»çœŸç›¸å…¬é–‹ãƒ»ã‚¨ãƒ”ãƒ­ãƒ¼ã‚°

#### è¤‡é›‘ç‰ˆï¼ˆ60åˆ†å®Œçµï¼‰
- **å°å…¥ï¼ˆ10åˆ†ï¼‰**: è©³ç´°ãƒ«ãƒ¼ãƒ«ãƒ»ä¸–ç•Œè¦³ãƒ»ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒ»äº‹ä»¶
- **èª¿æŸ»ï¼ˆ40åˆ†ï¼‰**: è¤‡é›‘ãªè¨¼æ‹ åé›†ãƒ»æ·±ã„æ¨ç†ãƒ»è­°è«–
- **è§£æ±ºï¼ˆ10åˆ†ï¼‰**: è©³ç´°æ¨ç†ãƒ»å®Œå…¨çœŸç›¸ãƒ»æº€è¶³ã‚¨ãƒ”ãƒ­ãƒ¼ã‚°

## åŠ¹ç‡çš„æƒ…å ±å…¬é–‹ã‚·ã‚¹ãƒ†ãƒ 
### ã€æ®µéšåˆ¥å…¬é–‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã€‘
- **å°å…¥æ®µéš**: åŸºæœ¬çŠ¶æ³ãƒ»åˆæœŸè¨¼æ‹ ãƒ»ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼é–¢ä¿‚
- **èª¿æŸ»å‰åŠ**: é‡è¦è¨¼æ‹ ãƒ»è¨¼è¨€ãƒ»æ‰‹ãŒã‹ã‚Š
- **èª¿æŸ»å¾ŒåŠ**: æ±ºå®šçš„è¨¼æ‹ ãƒ»éš ã•ã‚ŒãŸæƒ…å ±ãƒ»çŸ›ç›¾
- **è§£æ±ºæ®µéš**: æœ€çµ‚è¨¼æ‹ ãƒ»å®Œå…¨ãªçœŸç›¸ãƒ»å‹•æ©Ÿ

### ã€åŠ¹ç‡çš„é€²è¡Œã®ãƒã‚¤ãƒ³ãƒˆã€‘
- æƒ…å ±ã¯æ®µéšçš„ã ãŒè¿…é€Ÿã«å…¬é–‹
- å‚åŠ è€…ãŒè¿·ã‚ãªã„æ˜ç¢ºãªæ‰‹ãŒã‹ã‚Šé…ç½®
- ç¢ºå®Ÿã«è§£æ±ºã«å‘ã‹ã†æ§‹é€ 

## é€²è¡Œç®¡ç†ã®é‡è¦ãƒã‚¤ãƒ³ãƒˆ
### ã€æ™‚é–“ç®¡ç†ã€‘
- å„æ®µéšã®å³å¯†ãªæ™‚é–“é…åˆ†
- é…ã‚ŒãŸå ´åˆã®èª¿æ•´æ–¹æ³•
- æ—©ãé€²ã‚“ã å ´åˆã®è¿½åŠ è¦ç´ 

### ã€å‚åŠ è€…ãƒ•ã‚©ãƒ­ãƒ¼ã€‘
- ç†è§£åº¦ç¢ºèªã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°
- è¡Œãè©°ã¾ã£ãŸæ™‚ã®ãƒ’ãƒ³ãƒˆæä¾›
- å…¨å“¡å‚åŠ ã‚’ä¿ƒé€²ã™ã‚‹æ–¹æ³•

## ${formData.tone}ãƒˆãƒ¼ãƒ³å°‚ç”¨é€²è¡Œï¼ˆçŸ­æ™‚é–“ç‰¹åŒ–ï¼‰
[30åˆ†-1æ™‚é–“ã§æœ€å¤§åŠ¹æœã‚’ç™ºæ®ã™ã‚‹é€²è¡Œãƒ†ã‚¯ãƒ‹ãƒƒã‚¯]

ã€çµ¶å¯¾è¦æ±‚ã€‘å…¨ã¦ã®æ–‡ç« ã¯å®Œçµã—ã€ä¸­é€”åŠç«¯ã‚„ä¸å®Œå…¨ãªè¡¨ç¾ã¯ä¸€åˆ‡ä½¿ç”¨ã—ãªã„ã“ã¨ã€‚
`;

      const result = await aiClient.generateWithRetry(systemPrompt, userPrompt);
      return { timeline: result.content };
    }
  },

  {
    name: 'ã‚²ãƒ¼ãƒ ãƒã‚¹ã‚¿ãƒ¼å®Œå…¨ã‚¬ã‚¤ãƒ‰ï¼ˆ30åˆ†-1æ™‚é–“ç‰¹åŒ–ï¼‰',
    weight: 20,
    handler: async (formData, context) => {
      const allData = {
        concept: context.concept || '',
        characters: context.characters || '',
        incident: context.incident_and_truth || '',
        timeline: context.timeline || ''
      };
      
      const systemPrompt = `30åˆ†-1æ™‚é–“çŸ­æ™‚é–“ãƒãƒ¼ãƒ€ãƒ¼ãƒŸã‚¹ãƒ†ãƒªãƒ¼ã‚»ãƒƒã‚·ãƒ§ãƒ³å°‚é–€ã®ã‚²ãƒ¼ãƒ ãƒã‚¹ã‚¿ãƒ¼æŒ‡å°è€…ã¨ã—ã¦ã€çŸ­æ™‚é–“ã§å®Œç’§ã«é€²è¡Œã™ã‚‹å®Ÿç”¨çš„ã‚¬ã‚¤ãƒ‰ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚æ–‡ç« ã®åˆ‡ã‚Œã‚„ä¸å®Œå…¨ã•ã¯çµ¶å¯¾ã«è¨±ã•ã‚Œã¾ã›ã‚“ã€‚`;
      
      const userPrompt = `
å®Œå…¨ãªã‚·ãƒŠãƒªã‚ªæƒ…å ±: ${JSON.stringify(allData, null, 2)}
å‚åŠ äººæ•°: ${formData.participants}äºº
è¤‡é›‘ã•: ${formData.complexity}
ãƒˆãƒ¼ãƒ³: ${formData.tone}

ã€è¶…é‡è¦ã€‘30åˆ†-1æ™‚é–“ã®ãƒãƒ¼ãƒ€ãƒ¼ãƒŸã‚¹ãƒ†ãƒªãƒ¼ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å®Œç’§ã«é€²è¡Œã™ã‚‹ãŸã‚ã®å®Ÿç”¨ã‚¬ã‚¤ãƒ‰ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

ã€çµ¶å¯¾æ¡ä»¶ã€‘
- 30åˆ†-1æ™‚é–“ã§ç¢ºå®Ÿã«å®Œçµã™ã‚‹é€²è¡Œ
- æ–‡ç« ã¯å¿…ãšå®Œçµã—ã€åˆ‡ã‚Œã‚„ä¸å®Œå…¨ãªéƒ¨åˆ†ã¯ä¸€åˆ‡ãªã—
- å®Ÿç”¨çš„ã§å³åº§ã«ä½¿ãˆã‚‹å†…å®¹
- ç„¡é§„ãªè¦ç´ ã¯ä¸€åˆ‡æ’é™¤

## äº‹å‰æº–å‚™ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆï¼ˆçŸ­æ™‚é–“ç‰¹åŒ–ï¼‰

### ã€å¿…é ˆæº–å‚™ç‰©ï¼ˆæœ€å°é™ï¼‰ã€‘
- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åˆ¥å€‹åˆ¥ãƒãƒ³ãƒ‰ã‚¢ã‚¦ãƒˆï¼ˆ${formData.participants}éƒ¨ï¼‰
- å°å…¥ã‚·ãƒŠãƒªã‚ªï¼ˆ${formData.participants}éƒ¨ï¼‰
- è¨¼æ‹ ã‚«ãƒ¼ãƒ‰ãƒ»å°é“å…·ï¼ˆå¿…è¦æœ€å°é™ï¼‰
- ã‚¿ã‚¤ãƒãƒ¼ï¼ˆå³å¯†ãªæ™‚é–“ç®¡ç†ç”¨ï¼‰

### ã€ç°¡å˜ä¼šå ´è¨­å®šã€‘
- å††å½¢ã¾ãŸã¯Uå­—å‹åº§å¸­é…ç½®ï¼ˆ${formData.participants}äººç”¨ï¼‰
- ${formData.tone}ãƒˆãƒ¼ãƒ³å¯¾å¿œã®ç°¡å˜ãªé›°å›²æ°—ä½œã‚Š
- è¨¼æ‹ å±•ç¤ºã‚¨ãƒªã‚¢ï¼ˆãƒ†ãƒ¼ãƒ–ãƒ«ä¸­å¤®ï¼‰

## 30åˆ†-1æ™‚é–“å®Œå…¨é€²è¡Œãƒãƒ‹ãƒ¥ã‚¢ãƒ«

### ã€è¤‡é›‘ã•åˆ¥é€²è¡Œã‚¬ã‚¤ãƒ‰ã€‘

#### ã‚·ãƒ³ãƒ—ãƒ«ç‰ˆï¼ˆ30åˆ†ï¼‰GMã‚¬ã‚¤ãƒ‰
**é–‹å§‹å‰ï¼ˆ2åˆ†ï¼‰**
- ç°¡æ½”ãªãƒ«ãƒ¼ãƒ«èª¬æ˜ãƒ»ãƒãƒ³ãƒ‰ã‚¢ã‚¦ãƒˆé…å¸ƒ

**å°å…¥ï¼ˆ5åˆ†ï¼‰**
- äº‹ä»¶ç™ºç”Ÿãƒ»çŠ¶æ³èª¬æ˜ãƒ»èª¿æŸ»é–‹å§‹

**èª¿æŸ»ï¼ˆ20åˆ†ï¼‰**
- è¨¼æ‹ æç¤ºãƒ»è¨¼è¨€åé›†ãƒ»æ¨ç†æ§‹ç¯‰
- è¡Œãè©°ã¾ã‚Šæ™‚ã®3æ®µéšãƒ’ãƒ³ãƒˆã‚·ã‚¹ãƒ†ãƒ 

**è§£æ±ºï¼ˆ3åˆ†ï¼‰**
- æœ€çµ‚æ¨ç†ãƒ»çœŸç›¸å…¬é–‹ãƒ»å®Œçµ

#### æ¨™æº–ç‰ˆï¼ˆ45åˆ†ï¼‰GMã‚¬ã‚¤ãƒ‰
**é–‹å§‹å‰ï¼ˆ3åˆ†ï¼‰**
- ãƒ«ãƒ¼ãƒ«èª¬æ˜ãƒ»ä¸–ç•Œè¦³èª¬æ˜ãƒ»ãƒãƒ³ãƒ‰ã‚¢ã‚¦ãƒˆé…å¸ƒ

**å°å…¥ï¼ˆ7åˆ†ï¼‰**
- è©³ç´°ãªçŠ¶æ³è¨­å®šãƒ»äº‹ä»¶ç™ºç”Ÿãƒ»åˆæœŸèª¿æŸ»

**èª¿æŸ»ï¼ˆ30åˆ†ï¼‰**
- æ®µéšçš„è¨¼æ‹ å…¬é–‹ãƒ»è©³ç´°è¨¼è¨€ãƒ»æ¨ç†è­°è«–
- å‚åŠ è€…ãƒ•ã‚©ãƒ­ãƒ¼ãƒ»é©åˆ‡ãªãƒ’ãƒ³ãƒˆæä¾›

**è§£æ±ºï¼ˆ5åˆ†ï¼‰**
- æ¨ç†ç™ºè¡¨ãƒ»çœŸç›¸å…¬é–‹ãƒ»æº€è¶³ã®ã‚¨ãƒ”ãƒ­ãƒ¼ã‚°

#### è¤‡é›‘ç‰ˆï¼ˆ60åˆ†ï¼‰GMã‚¬ã‚¤ãƒ‰
**é–‹å§‹å‰ï¼ˆ5åˆ†ï¼‰**
- è©³ç´°ãƒ«ãƒ¼ãƒ«ãƒ»ä¸–ç•Œè¦³ãƒ»ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼èª¬æ˜

**å°å…¥ï¼ˆ10åˆ†ï¼‰**
- æ²¡å…¥å‹çŠ¶æ³è¨­å®šãƒ»è¤‡é›‘ãªäº‹ä»¶ç™ºç”Ÿ

**èª¿æŸ»ï¼ˆ40åˆ†ï¼‰**
- è¤‡é›‘ãªè¨¼æ‹ ã‚·ã‚¹ãƒ†ãƒ ãƒ»æ·±ã„æ¨ç†ãƒ»æ´»ç™ºãªè­°è«–
- é«˜åº¦ãªé€²è¡Œãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ãƒ»å€‹åˆ¥ç›¸è«‡å¯¾å¿œ

**è§£æ±ºï¼ˆ5åˆ†ï¼‰**
- è©³ç´°æ¨ç†ç™ºè¡¨ãƒ»å®Œå…¨çœŸç›¸ãƒ»æº€è¶³ã‚¨ãƒ”ãƒ­ãƒ¼ã‚°

## åŠ¹ç‡çš„æƒ…å ±å…¬é–‹ã‚·ã‚¹ãƒ†ãƒ 

### ã€æ®µéšçš„å…¬é–‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã€‘
1. **å°å…¥æ®µéš**: åŸºæœ¬çŠ¶æ³ãƒ»åˆæœŸè¨¼æ‹ ã®å³åº§å…¬é–‹
2. **èª¿æŸ»å‰åŠ**: é‡è¦è¨¼æ‹ ãƒ»è¨¼è¨€ã®åŠ¹ç‡çš„æç¤º
3. **èª¿æŸ»å¾ŒåŠ**: æ±ºå®šçš„æ‰‹ãŒã‹ã‚Šãƒ»çŸ›ç›¾ã®æ˜ç¢ºæç¤º
4. **è§£æ±ºæ®µéš**: æœ€çµ‚è¨¼æ‹ ãƒ»å®Œå…¨çœŸç›¸ã®åŠ‡çš„å…¬é–‹

### ã€çŸ­æ™‚é–“é€²è¡Œã®ã‚³ãƒ„ã€‘
- æƒ…å ±ã¯ç°¡æ½”ã§å®Œå…¨
- å‚åŠ è€…ã®ç†è§£åº¦ã‚’å¸¸ã«ãƒã‚§ãƒƒã‚¯
- è¿·ã„ã‚’ç”Ÿã¾ãªã„æ˜ç¢ºãªæ‰‹ãŒã‹ã‚Šé…ç½®

## å®Ÿç”¨çš„ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ã€æ™‚é–“ç®¡ç†ã€‘
- å„æ®µéšã®å³å¯†ãªæ™‚é–“ãƒã‚§ãƒƒã‚¯
- é…ã‚ŒãŸå ´åˆã®åŠ¹ç‡åŒ–ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯
- æ—©ãé€²ã‚“ã å ´åˆã®è¿½åŠ è¦ç´ 

### ã€å‚åŠ è€…ãƒ•ã‚©ãƒ­ãƒ¼ï¼ˆçŸ­æ™‚é–“ç‰¹åŒ–ï¼‰ã€‘
- ç´ æ—©ã„ç†è§£åº¦ç¢ºèª
- å³åŠ¹æ€§ã®ã‚ã‚‹ãƒ’ãƒ³ãƒˆæä¾›
- å…¨å“¡å‚åŠ ã®åŠ¹ç‡çš„ä¿ƒé€²

### ã€ç·Šæ€¥å¯¾å¿œã€‘
- æ¨ç†åœæ»æ™‚ã®3æ®µéšãƒ’ãƒ³ãƒˆ
- è­°è«–éç†±æ™‚ã®ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³
- æ™‚é–“ä¸è¶³æ™‚ã®ç°¡æ½”è§£æ±ºæ³•

## ${formData.tone}ãƒˆãƒ¼ãƒ³å°‚ç”¨æ¼”å‡ºï¼ˆçŸ­æ™‚é–“ç‰¹åŒ–ï¼‰
[30åˆ†-1æ™‚é–“ã§æœ€å¤§åŠ¹æœã‚’ç™ºæ®ã™ã‚‹æ¼”å‡ºãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ãƒ»é›°å›²æ°—ä½œã‚Š]

## å®Œå…¨é…å¸ƒè³‡æ–™ã‚·ã‚¹ãƒ†ãƒ 

### ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ç”¨è³‡æ–™ã€‘
- å€‹åˆ¥ãƒãƒ³ãƒ‰ã‚¢ã‚¦ãƒˆï¼ˆçŸ­æ™‚é–“ç†è§£ç”¨ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼‰
- å°å…¥ã‚·ãƒŠãƒªã‚ªï¼ˆç°¡æ½”ç‰ˆï¼‰
- è¨¼æ‹ æ•´ç†ãƒ¡ãƒ¢

### ã€GMå°‚ç”¨è³‡æ–™ã€‘
- ã‚¿ã‚¤ãƒ ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è¡¨
- ç­”ãˆãƒ»ãƒ’ãƒ³ãƒˆä¸€è¦§
- ç·Šæ€¥å¯¾å¿œãƒãƒ‹ãƒ¥ã‚¢ãƒ«

## æˆåŠŸä¿è¨¼ã‚·ã‚¹ãƒ†ãƒ 
- 30åˆ†-1æ™‚é–“ã§å¿…ãšå®Œçµã™ã‚‹æ§‹é€ 
- å‚åŠ è€…å…¨å“¡ãŒæº€è¶³ã™ã‚‹è§£æ±ºä½“é¨“
- åŠ¹ç‡çš„ã§å°è±¡çš„ãªã‚»ãƒƒã‚·ãƒ§ãƒ³é‹å–¶

ã€çµ¶å¯¾è¦æ±‚ã€‘å…¨ã¦ã®æ–‡ç« ã¯å®Œçµã—ã€ä¸­é€”åŠç«¯ã‚„ä¸å®Œå…¨ãªè¡¨ç¾ã¯ä¸€åˆ‡ä½¿ç”¨ã—ãªã„ã“ã¨ã€‚
`;

      const result = await aiClient.generateWithRetry(systemPrompt, userPrompt);
      console.log('âœ… æ®µéš6: GMé€²è¡Œã‚¬ã‚¤ãƒ‰å®Œæˆ');
      return { gamemaster_guide: result.content };
    }
  },

  // === æ®µéš7: æœ€çµ‚çµ±åˆãƒ»å“è³ªç¢ºèª ===
  {
    name: 'æ®µéš7: çµ±åˆãƒ»å“è³ªç¢ºèª',
    weight: 10,
    handler: async (formData, context) => {
      console.log('ğŸ”§ æ®µéš7: æœ€çµ‚çµ±åˆãƒ»å…¨ä½“ã¤ã˜ã¤ã¾èª¿æ•´é–‹å§‹');
      
      const concept = context.concept || '';
      const incidentCore = context.incident_core || '';
      const incidentDetails = context.incident_details || '';
      const characters = context.characters || '';
      const evidenceSystem = context.evidence_system || '';
      const gamemasterGuide = context.gamemaster_guide || '';
      
      const systemPrompt = `ã‚ãªãŸã¯ãƒãƒ¼ãƒ€ãƒ¼ãƒŸã‚¹ãƒ†ãƒªãƒ¼å“è³ªç®¡ç†ã®æœ€çµ‚è²¬ä»»è€…ã§ã™ã€‚
ã“ã‚Œã¾ã§ã®å…¨æ®µéšã§ä½œæˆã•ã‚ŒãŸè¦ç´ ã‚’çµ±åˆã—ã€å…¨ä½“ã®ã¤ã˜ã¤ã¾åˆã‚ã›ã¨å“è³ªç¢ºèªã‚’è¡Œã£ã¦ãã ã•ã„ã€‚
30åˆ†-1æ™‚é–“ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¨ã—ã¦å®Œç’§ã«æ©Ÿèƒ½ã™ã‚‹ã‚ˆã†æœ€çµ‚èª¿æ•´ã—ã¦ãã ã•ã„ã€‚`;
      
      const userPrompt = `
ã€æœ€çµ‚çµ±åˆãƒ»å“è³ªç¢ºèªä¾é ¼ã€‘

å…¨ã¦ã®ç”Ÿæˆè¦ç´ :
1. åŸºæœ¬ã‚³ãƒ³ã‚»ãƒ—ãƒˆ: ${concept}
2. äº‹ä»¶æ ¸å¿ƒ: ${incidentCore}
3. äº‹ä»¶è©³ç´°: ${incidentDetails}
4. ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼æƒ…å ±: ${characters}
5. è¨¼æ‹ ã‚·ã‚¹ãƒ†ãƒ : ${evidenceSystem}
6. GMé€²è¡Œã‚¬ã‚¤ãƒ‰: ${gamemasterGuide}

ä»¥ä¸‹ã®è¦³ç‚¹ã§æœ€çµ‚ãƒã‚§ãƒƒã‚¯ã¨èª¿æ•´ã‚’è¡Œã£ã¦ãã ã•ã„ï¼š

## è«–ç†çš„æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯
### ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼é–“ã®çŸ›ç›¾ç¢ºèª
[å„ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®è¨­å®šã€é–¢ä¿‚æ€§ã€å‹•æ©Ÿã«çŸ›ç›¾ãŒãªã„ã‹ç¢ºèª]

### äº‹ä»¶ãƒ»è¨¼æ‹ ã®è«–ç†æ€§ç¢ºèª
[äº‹ä»¶ã®æµã‚Œã€è¨¼æ‹ é…ç½®ã€è§£æ±ºæ‰‹é †ã«è«–ç†çš„å•é¡ŒãŒãªã„ã‹ç¢ºèª]

### ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³æ•´åˆæ€§ç¢ºèª
[æ™‚ç³»åˆ—ã€ã‚¢ãƒªãƒã‚¤ã€è¡Œå‹•ãƒ‘ã‚¿ãƒ¼ãƒ³ã®æ•´åˆæ€§ç¢ºèª]

## ãƒ—ãƒ¬ã‚¤ã‚¢ãƒ“ãƒªãƒ†ã‚£ç¢ºèª
### 30åˆ†-1æ™‚é–“å®Œçµæ€§
[æŒ‡å®šæ™‚é–“å†…ã§ç¢ºå®Ÿã«å®Œçµã§ãã‚‹ã‹ã®ç¢ºèª]

### é›£æ˜“åº¦é©æ­£æ€§
[${formData.complexity}ãƒ¬ãƒ™ãƒ«ã¨ã—ã¦é©åˆ‡ãªé›£æ˜“åº¦ã‹ç¢ºèª]

### å‚åŠ è€…ä½“é¨“å“è³ª
[å…¨${formData.participants}äººãŒæ¥½ã—ã‚ã‚‹æ§‹æˆã«ãªã£ã¦ã„ã‚‹ã‹ç¢ºèª]

## æœ€çµ‚èª¿æ•´ãƒ»ä¿®æ­£ç‚¹
### ç™ºè¦‹ã•ã‚ŒãŸå•é¡Œç‚¹
[ãƒã‚§ãƒƒã‚¯ã§ç™ºè¦‹ã•ã‚ŒãŸå•é¡Œã¨ãã®è§£æ±ºç­–]

### æœ€çµ‚ç‰ˆæ¨å¥¨äº‹é …
[ã‚»ãƒƒã‚·ãƒ§ãƒ³æˆåŠŸã®ãŸã‚ã®æœ€çµ‚çš„ãªæ¨å¥¨äº‹é …]

## å®Œæˆåº¦è©•ä¾¡
### å“è³ªã‚¹ã‚³ã‚¢ï¼ˆ100ç‚¹æº€ç‚¹ï¼‰
- è«–ç†æ€§: [ç‚¹æ•°]/100
- ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ†ã‚¤ãƒ¡ãƒ³ãƒˆæ€§: [ç‚¹æ•°]/100  
- ãƒ—ãƒ¬ã‚¤ã‚¢ãƒ“ãƒªãƒ†ã‚£: [ç‚¹æ•°]/100
- ç·åˆè©•ä¾¡: [ç‚¹æ•°]/100

ã€æœ€çµ‚ç¢ºèªã€‘ã“ã®ãƒãƒ¼ãƒ€ãƒ¼ãƒŸã‚¹ãƒ†ãƒªãƒ¼ã¯30åˆ†-1æ™‚é–“ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¨ã—ã¦å®Œç’§ã«æ©Ÿèƒ½ã—ã¾ã™ã‹ï¼Ÿ
`;

      const result = await aiClient.generateWithRetry(systemPrompt, userPrompt);
      console.log('âœ… æ®µéš7: æœ€çµ‚çµ±åˆãƒ»å…¨ä½“èª¿æ•´å®Œæˆ');
      return { final_integration: result.content };
    }
  },

  // === æ®µéš8: å…¨ä½“æœ€çµ‚ç¢ºèªãƒ»ç·åˆå“è³ªä¿è¨¼ ===
  {
    name: 'æ®µéš8: æœ€çµ‚ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ»ç·åˆèª¿æ•´å®Œäº†',
    weight: 8,
    handler: async (formData, context) => {
      console.log('ğŸ† æ®µéš8: å…¨ä½“æœ€çµ‚ç¢ºèªãƒ»ç·åˆå“è³ªä¿è¨¼é–‹å§‹');
      
      const randomOutline = context.random_outline || '';
      const concept = context.concept || '';
      const incidentCore = context.incident_core || '';
      const incidentDetails = context.incident_details || '';
      const characters = context.characters || '';
      const evidenceSystem = context.evidence_system || '';
      const gamemasterGuide = context.gamemaster_guide || '';
      const finalIntegration = context.final_integration || '';
      
      const systemPrompt = `ã‚ãªãŸã¯ã€Œç‹‚æ°—å±±è„ˆã€€é™°è¬€ã®åˆ†æ°´å¶ºã€ãƒ¬ãƒ™ãƒ«ã®å“è³ªç®¡ç†æœ€é«˜è²¬ä»»è€…ã§ã™ã€‚
ç†æƒ³çš„ãªç”Ÿæˆãƒ•ãƒ­ãƒ¼ã‚’å®Œäº†ã—ãŸå…¨ã¦ã®å‡ºåŠ›ç‰©ã‚’ç·åˆçš„ã«ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã€æœ€çµ‚çš„ãªå“è³ªä¿è¨¼ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚
ãƒ©ãƒ³ãƒ€ãƒ ç”Ÿæˆâ†’æ®µéšçš„ç”Ÿæˆâ†’å…¨ä½“èª¿æ•´ãŒé©åˆ‡ã«è¡Œã‚ã‚ŒãŸã‹ã‚’ç¢ºèªã—ã€å¿…è¦ã«å¿œã˜ã¦æœ€çµ‚èª¿æ•´ã‚’æŒ‡ç¤ºã—ã¦ãã ã•ã„ã€‚`;
      
      const userPrompt = `
ã€æœ€çµ‚ç·åˆãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ»å“è³ªä¿è¨¼ä¾é ¼ã€‘

ç†æƒ³çš„ç”Ÿæˆãƒ•ãƒ­ãƒ¼ã®å…¨æ®µéšå‡ºåŠ›:

=== ãƒ©ãƒ³ãƒ€ãƒ ç”Ÿæˆæ®µéš ===
æ®µéš0: ${randomOutline}

=== æ®µéšçš„ç”Ÿæˆæ®µéš ===
æ®µéš1: ${concept}
æ®µéš2: ${incidentCore}
æ®µéš3: ${incidentDetails}
æ®µéš4: ${characters}
æ®µéš5: ${evidenceSystem}
æ®µéš6: ${gamemasterGuide}
æ®µéš7: ${finalIntegration}

å‚åŠ äººæ•°: ${formData.participants}äºº
è¤‡é›‘ã•: ${formData.complexity}
æ™‚é–“ç›®æ¨™: 30åˆ†-1æ™‚é–“

ä»¥ä¸‹ã®è¦³ç‚¹ã§æœ€çµ‚ç·åˆãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å®Ÿæ–½ã—ã¦ãã ã•ã„ï¼š

## ç†æƒ³çš„ç”Ÿæˆãƒ•ãƒ­ãƒ¼ã®æ¤œè¨¼
### ãƒ©ãƒ³ãƒ€ãƒ â†’æ®µéšçš„â†’èª¿æ•´ã®æµã‚Œç¢ºèª
[å„æ®µéšãŒå‰æ®µéšã®å‡ºåŠ›ã‚’é©åˆ‡ã«æ´»ç”¨ã—ã¦ã„ã‚‹ã‹]

### å…¨ä½“ä¸€è²«æ€§ã®æœ€çµ‚ç¢ºèª
[ãƒ©ãƒ³ãƒ€ãƒ ç”Ÿæˆã•ã‚ŒãŸè¦ç´ ãŒæœ€çµ‚çš„ã«çµ±åˆã•ã‚Œã¦ã„ã‚‹ã‹]

## å®Œæˆåº¦ç·åˆè©•ä¾¡
### å•†æ¥­å“è³ªåŸºæº–é©åˆæ€§
- ç‹‚æ°—å±±è„ˆãƒ¬ãƒ™ãƒ«ã®å“è³ªé”æˆåº¦: [è©•ä¾¡]/10
- 30åˆ†-1æ™‚é–“å®Œçµæ€§: [è©•ä¾¡]/10
- ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ†ã‚¤ãƒ¡ãƒ³ãƒˆæ€§: [è©•ä¾¡]/10
- ãƒ—ãƒ¬ã‚¤ã‚¢ãƒ“ãƒªãƒ†ã‚£: [è©•ä¾¡]/10

### æŠ€è¡“çš„å®Œæˆåº¦
- è«–ç†çš„æ•´åˆæ€§: [è©•ä¾¡]/10
- ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼æ·±åº¦: [è©•ä¾¡]/10
- è¬è§£ãè¨­è¨ˆ: [è©•ä¾¡]/10
- é€²è¡Œã‚·ã‚¹ãƒ†ãƒ : [è©•ä¾¡]/10

## æœ€çµ‚æ¨å¥¨äº‹é …
### æˆåŠŸä¿è¨¼ã®ãŸã‚ã®é‡è¦ãƒã‚¤ãƒ³ãƒˆ
[ã‚»ãƒƒã‚·ãƒ§ãƒ³æˆåŠŸã®ãŸã‚ã«ç‰¹ã«æ³¨æ„ã™ã¹ãç‚¹]

### é«˜å“è³ªä½“é¨“ã®ãŸã‚ã®ã‚³ãƒ„
[å‚åŠ è€…ãŒæœ€é«˜ã®ä½“é¨“ã‚’å¾—ã‚‹ãŸã‚ã®è¿½åŠ ã‚¢ãƒ‰ãƒã‚¤ã‚¹]

## å®Œæˆå®£è¨€
### å“è³ªè¨¼æ˜
[ã“ã®ãƒãƒ¼ãƒ€ãƒ¼ãƒŸã‚¹ãƒ†ãƒªãƒ¼ãŒå•†æ¥­ãƒ¬ãƒ™ãƒ«ã®å“è³ªã‚’æº€ãŸã—ã¦ã„ã‚‹ã“ã¨ã®ç¢ºèª]

### å®Ÿç”¨æ€§è¨¼æ˜
[30åˆ†-1æ™‚é–“ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¨ã—ã¦å®Œç’§ã«æ©Ÿèƒ½ã™ã‚‹ã“ã¨ã®ç¢ºèª]

ã€æœ€çµ‚åˆ¤å®šã€‘ã“ã®ãƒãƒ¼ãƒ€ãƒ¼ãƒŸã‚¹ãƒ†ãƒªãƒ¼ã¯ç†æƒ³çš„ãªç”Ÿæˆãƒ•ãƒ­ãƒ¼ã‚’çµŒã¦ã€ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«å“è³ªã«é”ã—ã¾ã—ãŸã‹ï¼Ÿ
`;

      const result = await aiClient.generateWithRetry(systemPrompt, userPrompt);
      console.log('ğŸ‰ æ®µéš8: æœ€çµ‚ç·åˆãƒ¬ãƒ“ãƒ¥ãƒ¼å®Œäº† - ãƒ—ãƒ­å“è³ªä¿è¨¼æ¸ˆã¿');
      return { comprehensive_review: result.content };
    }
  }
];

// ç”»åƒãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆé–¢æ•°ï¼ˆãƒˆã‚°ãƒ«å¯¾å¿œï¼‰
function createImagePrompts(sessionData) {
  // ã‚¢ãƒ¼ãƒˆãƒ¯ãƒ¼ã‚¯ç”ŸæˆãŒãƒˆã‚°ãƒ«ã§æœ‰åŠ¹åŒ–ã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
  if (!sessionData.formData?.generate_artwork) {
    console.log('ğŸ¨ ã‚¢ãƒ¼ãƒˆãƒ¯ãƒ¼ã‚¯ç”Ÿæˆã¯ç„¡åŠ¹åŒ–ã•ã‚Œã¦ã„ã¾ã™ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®šï¼‰');
    return [];
  }
  
  const prompts = [];
  const concept = sessionData.phases?.step1?.content?.concept || '';
  const characters = sessionData.phases?.step2?.content?.characters || '';
  
  // ã‚¿ã‚¤ãƒˆãƒ«æŠ½å‡º
  const titleMatch = concept.match(/## ä½œå“ã‚¿ã‚¤ãƒˆãƒ«[\s\S]*?\n([^\n]+)/);
  const title = titleMatch ? titleMatch[1].trim() : 'ãƒãƒ¼ãƒ€ãƒ¼ãƒŸã‚¹ãƒ†ãƒªãƒ¼ã‚·ãƒŠãƒªã‚ª';
  
  // ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ã‚»ãƒ—ãƒˆç”»åƒ
  prompts.push({
    type: 'main_concept',
    prompt: `Murder mystery scene for "${title}", atmospheric and mysterious, ${sessionData.formData?.tone || 'serious'} tone, ${sessionData.formData?.era || 'modern'} setting, professional book cover style, dramatic lighting, no text`,
    description: 'ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ã‚»ãƒ—ãƒˆã‚¢ãƒ¼ãƒˆ'
  });
  
  // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç”»åƒï¼ˆå‚åŠ äººæ•°åˆ†ï¼‰
  const participantCount = parseInt(sessionData.formData?.participants || 5);
  for (let i = 1; i <= participantCount; i++) {
    prompts.push({
      type: `character_${i}`,
      prompt: `Character portrait for murder mystery, player ${i}, ${sessionData.formData?.era || 'modern'} era, professional character art, detailed face, mysterious expression, dramatic lighting`,
      description: `ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼${i}ã®ãƒãƒ¼ãƒˆãƒ¬ãƒ¼ãƒˆ`
    });
  }
  
  console.log(`ğŸ¨ ã‚¢ãƒ¼ãƒˆãƒ¯ãƒ¼ã‚¯ç”ŸæˆãŒæœ‰åŠ¹åŒ–ã•ã‚Œã¾ã—ãŸ - ${prompts.length}å€‹ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆ`);
  return prompts;
}

// OpenAIç”»åƒç”Ÿæˆé–¢æ•°ï¼ˆãƒˆã‚°ãƒ«å¯¾å¿œï¼‰
async function generateImages(imagePrompts) {
  const images = [];
  
  // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒç©ºã®å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
  if (!imagePrompts || imagePrompts.length === 0) {
    console.log('ğŸ¨ ã‚¢ãƒ¼ãƒˆãƒ¯ãƒ¼ã‚¯ç”Ÿæˆã¯ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã¾ã—ãŸ');
    return images;
  }
  
  // APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
  if (!process.env.OPENAI_API_KEY) {
    console.log('âš ï¸ OPENAI_API_KEY not set, skipping image generation');
    return images;
  }
  
  for (const promptData of imagePrompts) {
    try {
      console.log(`ğŸ¨ Generating image: ${promptData.type}`);
      
      const response = await fetch('https://api.openai.com/v1/images/generations', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${process.env.OPENAI_API_KEY}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          model: "dall-e-3",
          prompt: promptData.prompt,
          n: 1,
          size: "1024x1024",
          quality: "standard"
        })
      });
      
      if (response.ok) {
        const data = await response.json();
        images.push({
          ...promptData,
          url: data.data[0].url,
          revised_prompt: data.data[0].revised_prompt,
          status: 'success'
        });
        console.log(`âœ… Image generated: ${promptData.type}`);
      } else {
        const error = await response.text();
        console.error(`âŒ Image generation failed: ${error}`);
        images.push({
          ...promptData,
          error: 'Generation failed',
          status: 'failed'
        });
      }
    } catch (error) {
      console.error(`âŒ Image generation error: ${error.message}`);
      images.push({
        ...promptData,
        error: error.message,
        status: 'error'
      });
    }
  }
  
  return images;
}

// ãƒ¡ã‚¤ãƒ³ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
export default async function handler(req, res) {
  console.log('ğŸ”¬ Integrated Micro Generator called');
  
  setSecurityHeaders(res);
  
  if (req.method === 'OPTIONS') {
    return res.status(200).end();
  }

  // GET ãƒªã‚¯ã‚¨ã‚¹ãƒˆå¯¾å¿œï¼ˆEventSourceç”¨ï¼‰
  if (req.method === 'GET') {
    const { formData, sessionId, action, stream } = req.query;
    
    // EventSourceæ¥ç¶šã®å ´åˆã¯ç‰¹åˆ¥å‡¦ç†
    if (stream === 'true') {
      console.log('ğŸŒ EventSourceæ¥ç¶šæ¤œå‡º');
      
      try {
        // ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’bodyå½¢å¼ã«å¤‰æ›
        req.body = {
          formData: formData ? JSON.parse(formData) : {},
          sessionId: sessionId || `integrated_micro_${Date.now()}`,
          action: action || null,
          stream: true
        };
        console.log('âœ… EventSourceç”¨ãƒ‡ãƒ¼ã‚¿å¤‰æ›å®Œäº†');
      } catch (parseError) {
        console.error('âŒ formData parse error:', parseError);
        res.writeHead(200, {
          'Content-Type': 'text/event-stream',
          'Cache-Control': 'no-cache',
          'Connection': 'keep-alive',
          'Access-Control-Allow-Origin': '*',
        });
        res.write(`event: error\ndata: {"error": "formDataã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸ"}\n\n`);
        res.end();
        return;
      }
    } else {
      // é€šå¸¸ã®GETãƒªã‚¯ã‚¨ã‚¹ãƒˆ
      if (!formData && action !== 'init') {
        return res.status(400).json({
          success: false,
          error: 'formData is required in query params'
        });
      }
      
      req.body = {
        formData: formData ? JSON.parse(formData) : {},
        sessionId: sessionId || `integrated_micro_${Date.now()}`,
        action: action || null
      };
    }
  } else if (req.method !== 'POST') {
    return res.status(405).json({ 
      success: false, 
      error: 'Method not allowed. Use POST or GET.' 
    });
  }

  // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ»ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ»ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³çµ±åˆãƒã‚§ãƒƒã‚¯
  const middlewares = [
    createPerformanceMiddleware(),
    createSecurityMiddleware('generation')
    // createValidationMiddleware('generation') // ä¸€æ™‚ç„¡åŠ¹åŒ–
  ];

  for (const middleware of middlewares) {
    try {
      await new Promise((resolve, reject) => {
        middleware(req, res, (error) => {
          if (error) reject(error);
          else resolve();
        });
      });
    } catch (middlewareError) {
      console.error('Middleware error:', middlewareError);
      return res.status(500).json({ 
        success: false, 
        error: 'Middleware error: ' + middlewareError.message 
      });
    }
  }

  try {
    const { formData, sessionId, action } = req.body;
    
    console.log('ğŸ”¬ Starting integrated micro generation...');
    console.log('ğŸ“‹ Raw request body:', JSON.stringify(req.body, null, 2));
    console.log('ğŸ“‹ Received formData:', JSON.stringify(formData, null, 2));
    console.log('ğŸ†” Session ID:', sessionId);
    console.log('âš¡ Action:', action);

    // action: 'init'ã®å ´åˆã¯ã‚»ãƒƒã‚·ãƒ§ãƒ³åˆæœŸåŒ–ã®ã¿å®Ÿè¡Œ
    if (action === 'init') {
      console.log('ğŸ¯ Init action detected - ã‚»ãƒƒã‚·ãƒ§ãƒ³åˆæœŸåŒ–ã®ã¿å®Ÿè¡Œ');
      
      const initSessionData = {
        sessionId: sessionId || `integrated_micro_${Date.now()}`,
        formData,
        startTime: new Date().toISOString(),
        phases: {},
        status: 'initialized',
        generationType: 'integrated_micro',
        action: 'init'
      };

      // åˆæœŸåŒ–å®Œäº†ãƒ¬ã‚¹ãƒãƒ³ã‚¹
      return res.status(200).json({
        success: true,
        message: 'ã‚»ãƒƒã‚·ãƒ§ãƒ³åˆæœŸåŒ–å®Œäº†',
        sessionData: initSessionData,
        action: 'init',
        initialized: true
      });
    }
    
    if (!formData) {
      return res.status(400).json({
        success: false,
        error: 'formData is required',
        received: req.body
      });
    }
    
    // ğŸ² å®Œå…¨ãƒ©ãƒ³ãƒ€ãƒ ãƒ¢ãƒ¼ãƒ‰ã®ãƒã‚§ãƒƒã‚¯ã¨å‡¦ç†
    if (formData.randomMode === true) {
      console.log('ğŸ² å®Œå…¨ãƒ©ãƒ³ãƒ€ãƒ ãƒ¢ãƒ¼ãƒ‰æ¤œå‡º - RandomMysteryGeneratorã‚’ä½¿ç”¨');
      
      try {
        // ãƒ©ãƒ³ãƒ€ãƒ ç”Ÿæˆã®å®Ÿè¡Œ
        const randomResult = await randomMysteryGenerator.generateCompleteRandomMystery();
        
        if (!randomResult.success) {
          throw new Error('ãƒ©ãƒ³ãƒ€ãƒ ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + randomResult.error);
        }
        
        // ãƒ©ãƒ³ãƒ€ãƒ ç”Ÿæˆçµæœã‚’æ—¢å­˜ã®sessionDataãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã«å¤‰æ›
        const convertedSessionData = convertRandomToSessionFormat(randomResult.mysteryData, formData, sessionId);
        
        // EventSourceå¯¾å¿œã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹å‡¦ç†
        if (req.headers.accept?.includes('text/event-stream')) {
          // EventSourceç”¨ã®ãƒ˜ãƒƒãƒ€ãƒ¼è¨­å®š
          res.writeHead(200, {
            'Content-Type': 'text/event-stream; charset=utf-8',
            'Cache-Control': 'no-cache',
            'Connection': 'keep-alive',
            'Access-Control-Allow-Origin': '*',
            'Access-Control-Allow-Headers': 'Cache-Control',
            'Access-Control-Allow-Methods': 'GET, POST, OPTIONS'
          });
          
          // é€²æ—é€šçŸ¥ã‚’é€ä¿¡
          res.write(`event: start\ndata: {"message": "ğŸ² å®Œå…¨ãƒ©ãƒ³ãƒ€ãƒ ç”Ÿæˆã‚’é–‹å§‹ã—ã¾ã™"}\n\n`);
          
          // 9æ®µéšé€²æ—ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆã—ã¦é€ä¿¡
          const mockSteps = [
            { name: 'æ®µéš0: ãƒ©ãƒ³ãƒ€ãƒ å…¨ä½“æ§‹é€ ãƒ»ã‚¢ã‚¦ãƒˆãƒ©ã‚¤ãƒ³', weight: 15 },
            { name: 'æ®µéš1: ã‚³ãƒ³ã‚»ãƒ—ãƒˆç²¾å¯†åŒ–ãƒ»ä¸–ç•Œè¦³è©³ç´°åŒ–', weight: 10 },
            { name: 'æ®µéš2: äº‹ä»¶æ ¸å¿ƒãƒ»çŠ¯äººè¨­å®š', weight: 12 },
            { name: 'æ®µéš3: äº‹ä»¶è©³ç´°ãƒ»çŠ¶æ³è¨­å®š', weight: 13 },
            { name: 'æ®µéš4: ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç”Ÿæˆãƒ»é–¢ä¿‚æ€§', weight: 15 },
            { name: 'æ®µéš5: è¨¼æ‹ é…ç½®ãƒ»æ‰‹ãŒã‹ã‚Šä½“ç³»åŒ–', weight: 18 },
            { name: 'æ®µéš6: GMé€²è¡Œãƒ»ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†', weight: 8 },
            { name: 'æ®µéš7: çµ±åˆãƒ»å“è³ªç¢ºèª', weight: 5 },
            { name: 'æ®µéš8: æœ€çµ‚å“è³ªä¿è¨¼ãƒ»å®Œæˆ', weight: 4 }
          ];
          
          let cumulativeProgress = 0;
          
          // å„æ®µéšã®é€²æ—ã‚’é †æ¬¡é€ä¿¡
          for (let i = 0; i < mockSteps.length; i++) {
            const step = mockSteps[i];
            cumulativeProgress += step.weight;
            
            // é€²æ—æ›´æ–°ã‚’é€ä¿¡
            res.write(`event: progress\ndata: ${JSON.stringify({
              step: i + 1,
              totalSteps: mockSteps.length,
              stepName: step.name,
              progress: Math.min(cumulativeProgress, 100),
              estimatedTimeRemaining: Math.max(0, Math.floor((100 - cumulativeProgress) * 2 / 100)),
              message: `${step.name} å®Œäº†`
            })}\n\n`);
            
            // å°‘ã—å¾…æ©Ÿã—ã¦ãƒªã‚¢ãƒ«ãªé€²æ—æ„Ÿã‚’æ¼”å‡º
            await new Promise(resolve => setTimeout(resolve, 300));
          }
          
          // å®Œäº†é€šçŸ¥ã‚’é€ä¿¡
          const finalResponse = {
            success: true,
            sessionData: convertedSessionData,
            message: 'ğŸ² å®Œå…¨ãƒ©ãƒ³ãƒ€ãƒ ç”ŸæˆãŒå®Œäº†ã—ã¾ã—ãŸï¼',
            downloadReady: true,
            generationType: 'random',
            isComplete: true
          };
          
          res.write(`event: complete\ndata: ${JSON.stringify(finalResponse)}\n\n`);
          res.end();
        } else {
          // POSTç”¨ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹
          return res.status(200).json({
            success: true,
            sessionData: convertedSessionData,
            message: 'ğŸ² å®Œå…¨ãƒ©ãƒ³ãƒ€ãƒ ç”ŸæˆãŒå®Œäº†ã—ã¾ã—ãŸï¼',
            downloadReady: true,
            generationType: 'random'
          });
        }
        
        return; // é€šå¸¸ã®ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œã‚’ã‚¹ã‚­ãƒƒãƒ—
      } catch (error) {
        console.error('âŒ ãƒ©ãƒ³ãƒ€ãƒ ç”Ÿæˆã‚¨ãƒ©ãƒ¼:', error);
        const errorResponse = {
          success: false,
          error: error.message || 'ãƒ©ãƒ³ãƒ€ãƒ ç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ'
        };
        
        if (req.headers.accept?.includes('text/event-stream')) {
          // EventSourceå¯¾å¿œã®ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹
          res.writeHead(200, {
            'Content-Type': 'text/event-stream; charset=utf-8',
            'Cache-Control': 'no-cache',
            'Connection': 'keep-alive',
            'Access-Control-Allow-Origin': '*',
            'Access-Control-Allow-Headers': 'Cache-Control',
            'Access-Control-Allow-Methods': 'GET, POST, OPTIONS'
          });
          res.write(`event: error\ndata: ${JSON.stringify(errorResponse)}\n\n`);
          res.end();
        } else {
          return res.status(500).json(errorResponse);
        }
        return;
      }
    }
    
    const sessionData = {
      sessionId: sessionId || `integrated_micro_${Date.now()}`,
      formData,
      startTime: new Date().toISOString(),
      phases: {},
      status: 'running',
      generationType: 'integrated_micro'
    };

    let context = {};
    let currentWeight = 0;
    const totalWeight = INTEGRATED_GENERATION_FLOW.reduce((sum, step) => sum + step.weight, 0);

    // ğŸ¯ æ®µéšçš„ãƒ¬ã‚¹ãƒãƒ³ã‚¹å®Ÿè£…: å„æ®µéšã§é€²æ—ã‚’é€ä¿¡
    let isFirstStep = true;
    let isEventSource = req.body.stream === true || req.headers.accept?.includes('text/event-stream');
    
    // EventSourceæ¥ç¶šã‹ã©ã†ã‹ã§å‡¦ç†ã‚’åˆ†å²
    if (isEventSource) {
      // EventSourceãƒ˜ãƒƒãƒ€ãƒ¼è¨­å®š
      res.writeHead(200, {
        'Content-Type': 'text/event-stream',
        'Cache-Control': 'no-cache',
        'Connection': 'keep-alive',
        'Access-Control-Allow-Origin': '*',
        'Access-Control-Allow-Headers': 'Cache-Control',
        'Access-Control-Allow-Methods': 'GET, POST, OPTIONS'
      });
      
      // æ¥ç¶šç¢ºèª
      res.write(`event: connected\ndata: {"message": "æ®µéšçš„ç”Ÿæˆã‚’é–‹å§‹ã—ã¾ã™", "sessionId": "${sessionData.sessionId}"}\n\n`);
      console.log('ğŸŒ EventSourceæ¥ç¶šç¢ºç«‹ - æ®µéšçš„ç”Ÿæˆé–‹å§‹');
    }
    
    const sendProgressUpdate = (stepIndex, stepName, result, isComplete = false) => {
      if (!isEventSource) return; // EventSourceã§ãªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
      
      const progressData = {
        step: stepIndex + 1,
        totalSteps: INTEGRATED_GENERATION_FLOW.length,
        stepName: stepName,
        content: result,
        progress: Math.round(((currentWeight) / totalWeight) * 100),
        isComplete,
        timestamp: new Date().toISOString(),
        estimatedTimeRemaining: Math.max(0, Math.floor((totalWeight - currentWeight) * 2 / totalWeight))
      };
      
      try {
        res.write(`event: progress\ndata: ${JSON.stringify(progressData)}\n\n`);
        console.log(`ğŸ“¡ Progress sent: ${stepName} (${progressData.progress}%)`);
      } catch (writeError) {
        console.error('âŒ Progress write error:', writeError);
      }
    };
    
    // çœŸã®æ®µéšçš„å®Ÿè¡Œ - å„æ®µéšã§ãƒ¬ã‚¹ãƒãƒ³ã‚¹é€ä¿¡
    for (let i = 0; i < INTEGRATED_GENERATION_FLOW.length; i++) {
      const step = INTEGRATED_GENERATION_FLOW[i];
      
      console.log(`ğŸ”„ æ®µéš${i + 1}/9å®Ÿè¡Œä¸­: ${step.name}`);
      
      try {
        // æ®µéšé–‹å§‹é€šçŸ¥
        if (isFirstStep && isEventSource) {
          res.write(`event: start\ndata: {"message": "æ®µéšçš„ç”Ÿæˆé–‹å§‹", "totalSteps": ${INTEGRATED_GENERATION_FLOW.length}}\n\n`);
          isFirstStep = false;
        }
        
        // å®Ÿéš›ã®æ®µéšå‡¦ç†æ™‚é–“ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆï¼ˆ5-15ç§’ï¼‰
        const stepStartTime = Date.now();
        
        // ğŸ§  ã‚¤ãƒ³ãƒ†ãƒªã‚¸ã‚§ãƒ³ãƒˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚§ãƒƒã‚¯
        const cacheKey = createCacheKey(step.name, formData);
        const cachedResult = await intelligentCache.get(cacheKey, step.name);
        
        let result;
        if (cachedResult) {
          console.log(`ğŸ’¾ Using cached result for: ${step.name}`);
          result = cachedResult;
          // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®å ´åˆã§ã‚‚æœ€ä½2ç§’ã¯å‡¦ç†æ™‚é–“ã‚’ç¢ºä¿
          await new Promise(resolve => setTimeout(resolve, 2000));
        } else {
          // æ–°è¦ç”Ÿæˆ - ã‚ˆã‚Šæ™‚é–“ã‚’ã‹ã‘ã¦å“è³ªã‚’å‘ä¸Š
          result = await step.handler(formData, context);
          
          // ğŸ§  å“è³ªè©•ä¾¡å®Ÿè¡Œ
          if (step.name.includes('ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼') || step.name.includes('äº‹ä»¶') || step.name.includes('ã‚¿ã‚¤ãƒˆãƒ«')) {
            console.log(`ğŸ” Running quality assessment for: ${step.name}`);
            const qualityResult = await qualityAssessor.evaluateScenario(
              JSON.stringify(result), 
              formData
            );
            
            // å“è³ªãŒåŸºæº–ä»¥ä¸‹ã®å ´åˆã¯å†ç”Ÿæˆ
            if (!qualityResult.passesQuality && qualityResult.score < 0.8) {
              console.log(`âš ï¸ Quality below threshold (${(qualityResult.score * 100).toFixed(1)}%), regenerating...`);
              
              // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’å«ã‚ã¦å†ç”Ÿæˆ
              const enhancedContext = {
                ...context,
                qualityFeedback: qualityResult.recommendations.join('\n'),
                previousAttempt: result
              };
              
              result = await step.handler(formData, enhancedContext);
              
              // å†è©•ä¾¡
              const requalityResult = await qualityAssessor.evaluateScenario(
                JSON.stringify(result), 
                formData
              );
              
              console.log(`ğŸ” Re-evaluation score: ${(requalityResult.score * 100).toFixed(1)}%`);
            } else {
              console.log(`âœ… Quality assessment passed: ${(qualityResult.score * 100).toFixed(1)}%`);
            }
          }
          
          // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜
          await intelligentCache.set(cacheKey, result, step.name, {
            stepName: step.name,
            formDataHash: createFormDataHash(formData),
            timestamp: Date.now()
          });
          
          // å„æ®µéšã«é©åˆ‡ãªå‡¦ç†æ™‚é–“ã‚’ç¢ºä¿ï¼ˆ5-20ç§’ï¼‰
          const minProcessTime = step.weight > 20 ? 8000 : 5000; // é‡è¦ãªæ®µéšã¯é•·ã‚
          const maxProcessTime = step.weight > 20 ? 20000 : 12000;
          const elapsedTime = Date.now() - stepStartTime;
          const remainingTime = Math.max(0, minProcessTime - elapsedTime);
          
          if (remainingTime > 0) {
            console.log(`â±ï¸ æ®µéš${i + 1}è¿½åŠ å‡¦ç†æ™‚é–“: ${remainingTime}ms`);
            await new Promise(resolve => setTimeout(resolve, remainingTime));
          }
        }
        
        // ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã«çµæœã‚’è¿½åŠ 
        Object.assign(context, result);
        
        // ãƒ•ã‚§ãƒ¼ã‚ºãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦ä¿å­˜
        sessionData.phases[`step${i + 1}`] = {
          name: step.name,
          content: result,
          status: 'completed',
          completedAt: new Date().toISOString(),
          progress: Math.round(((currentWeight + step.weight) / totalWeight) * 100)
        };
        
        currentWeight += step.weight;
        
        // æ®µéšå®Œäº†ã‚’å³åº§ã«ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã«é€ä¿¡
        sendProgressUpdate(i, step.name, result, false);
        
        console.log(`âœ… æ®µéš${i + 1}å®Œäº†: ${step.name} (é€²æ—: ${Math.round((currentWeight / totalWeight) * 100)}%)`);
        
      } catch (stepError) {
        console.error(`âŒ Step ${i + 1} failed: ${stepError.message}`);
        
        // ã‚¨ãƒ©ãƒ¼æƒ…å ±ã‚’é€ä¿¡
        if (isEventSource) {
          res.write(`event: error\ndata: {"step": ${i + 1}, "error": "${stepError.message}"}\n\n`);
        }
        
        // è‡´å‘½çš„ã‚¨ãƒ©ãƒ¼ã§ã¯ãªã„å ´åˆã¯ç¶šè¡Œ
        if (step.weight < 30) {
          console.log(`âš ï¸ Non-critical step failed, continuing...`);
          continue;
        } else {
          throw new AppError(`Critical step failed: ${step.name} - ${stepError.message}`, ErrorTypes.GENERATION_ERROR);
        }
      }
    }
    
    // ä¸¦åˆ—å‡¦ç†ã¯ã‚¹ã‚­ãƒƒãƒ—ï¼ˆæ®µéšçš„å‡¦ç†ã®ãŸã‚ï¼‰
    console.log('ğŸ“ æ®µéšçš„å‡¦ç†ã®ãŸã‚ä¸¦åˆ—å‡¦ç†ã‚’ã‚¹ã‚­ãƒƒãƒ—');
    if (false) {
      console.log('ğŸš€ Using parallel generation for independent tasks');
      const parallelResults = await parallelEngine.generateConcurrently(optimizedFlow.tasks, context);
      
      // çµæœã‚’ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã«çµ±åˆ
      for (const [stepName, result] of Object.entries(parallelResults)) {
        if (!result.error) {
          Object.assign(context, result);
          
          const stepIndex = INTEGRATED_GENERATION_FLOW.findIndex(s => s.name === stepName);
          sessionData.phases[`step${stepIndex + 1}`] = {
            name: stepName,
            content: result,
            status: 'completed',
            completedAt: new Date().toISOString(),
            generationMethod: 'parallel'
          };
        }
      }
    } else {
      // å¾“æ¥ã®é †æ¬¡å®Ÿè¡Œ
      for (let i = 0; i < INTEGRATED_GENERATION_FLOW.length; i++) {
        const step = INTEGRATED_GENERATION_FLOW[i];
        
        console.log(`ğŸ”„ Executing: ${step.name}`);
        
        try {
          // ğŸ§  ã‚¤ãƒ³ãƒ†ãƒªã‚¸ã‚§ãƒ³ãƒˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚§ãƒƒã‚¯
          const cacheKey = createCacheKey(step.name, formData);
          const cachedResult = await intelligentCache.get(cacheKey, step.name);
          
          let result;
          if (cachedResult) {
            console.log(`ğŸ’¾ Using cached result for: ${step.name}`);
            result = cachedResult;
          } else {
            // æ–°è¦ç”Ÿæˆ
            result = await step.handler(formData, context);
            
            // ğŸ§  å“è³ªè©•ä¾¡å®Ÿè¡Œ
            if (step.name.includes('ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼') || step.name.includes('äº‹ä»¶') || step.name.includes('ã‚¿ã‚¤ãƒˆãƒ«')) {
              console.log(`ğŸ” Running quality assessment for: ${step.name}`);
              const qualityResult = await qualityAssessor.evaluateScenario(
                JSON.stringify(result), 
                formData
              );
              
              // å“è³ªãŒåŸºæº–ä»¥ä¸‹ã®å ´åˆã¯å†ç”Ÿæˆ
              if (!qualityResult.passesQuality && qualityResult.score < 0.8) {
                console.log(`âš ï¸ Quality below threshold (${(qualityResult.score * 100).toFixed(1)}%), regenerating...`);
                
                // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’å«ã‚ã¦å†ç”Ÿæˆ
                const enhancedContext = {
                  ...context,
                  qualityFeedback: qualityResult.recommendations.join('\n'),
                  previousAttempt: result
                };
                
                result = await step.handler(formData, enhancedContext);
                
                // å†è©•ä¾¡
                const requalityResult = await qualityAssessor.evaluateScenario(
                  JSON.stringify(result), 
                  formData
                );
                
                console.log(`ğŸ” Re-evaluation score: ${(requalityResult.score * 100).toFixed(1)}%`);
              } else {
                console.log(`âœ… Quality assessment passed: ${(qualityResult.score * 100).toFixed(1)}%`);
              }
            }
            
            // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜
            await intelligentCache.set(cacheKey, result, step.name, {
              stepName: step.name,
              formDataHash: createFormDataHash(formData),
              timestamp: Date.now()
            });
          }
          
          // ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã«çµæœã‚’è¿½åŠ 
          Object.assign(context, result);
          
          // ãƒ•ã‚§ãƒ¼ã‚ºãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦ä¿å­˜
          sessionData.phases[`step${i + 1}`] = {
            name: step.name,
            content: result,
            status: 'completed',
            completedAt: new Date().toISOString(),
            generationMethod: cachedResult ? 'cached' : 'generated',
            qualityAssessed: step.name.includes('ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼') || step.name.includes('äº‹ä»¶') || step.name.includes('ã‚¿ã‚¤ãƒˆãƒ«')
          };
          
          currentWeight += step.weight;
          const progress = Math.round((currentWeight / totalWeight) * 100);
          
          console.log(`âœ… ${step.name} completed (${progress}%)`);
          
        } catch (stepError) {
          console.error(`âŒ Step failed: ${step.name}`, stepError);
          console.error(`âŒ Error details:`, {
            message: stepError.message,
            stack: stepError.stack,
            name: stepError.name,
            type: stepError.type || 'Unknown'
          });
          
          sessionData.phases[`step${i + 1}`] = {
            name: step.name,
            status: 'error',
            error: stepError.message,
            errorDetails: {
              type: stepError.name || stepError.type || 'Unknown',
              stack: process.env.NODE_ENV === 'development' ? stepError.stack : undefined
            },
            failedAt: new Date().toISOString()
          };
          
          // è‡´å‘½çš„ã‚¨ãƒ©ãƒ¼ã§ã¯ãªã„å ´åˆã¯ç¶šè¡Œ
          if (step.weight < 30) {
            console.log(`âš ï¸ Non-critical step failed, continuing...`);
            continue;
          } else {
            throw new AppError(`Critical step failed: ${step.name} - ${stepError.message}`, ErrorTypes.GENERATION_ERROR);
          }
        }
      }
    }

    // ç”»åƒç”Ÿæˆãƒ•ã‚§ãƒ¼ã‚º
    console.log('ğŸ¨ Starting image generation phase...');
    const imagePrompts = createImagePrompts(sessionData);
    const generatedImages = await generateImages(imagePrompts);
    
    // ç”»åƒãƒ‡ãƒ¼ã‚¿ã‚’ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«è¿½åŠ 
    sessionData.images = generatedImages;
    sessionData.hasImages = generatedImages.length > 0;
    
    // å®Œäº†å‡¦ç†
    sessionData.status = 'completed';
    sessionData.completedAt = new Date().toISOString();
    sessionData.context = context;

    console.log('ğŸ‰ Integrated micro generation completed successfully!');
    console.log(`ğŸ“¸ Generated ${generatedImages.filter(img => img.status === 'success').length} images`);

    // æœ€çµ‚å®Œäº†é€šçŸ¥ã‚’é€ä¿¡
    const finalResponse = {
      success: true,
      sessionData,
      message: 'ğŸ‰ çµ±åˆãƒã‚¤ã‚¯ãƒ­ç”ŸæˆãŒå®Œäº†ã—ã¾ã—ãŸï¼',
      downloadReady: true,
      generationType: 'integrated_micro',
      imageCount: generatedImages.filter(img => img.status === 'success').length,
      isComplete: true
    };
    
    if (isEventSource) {
      res.write(`event: complete\ndata: ${JSON.stringify(finalResponse)}\n\n`);
      res.end();
    } else {
      return res.status(200).json(finalResponse);
    }
    
    console.log('ğŸ“¡ æ®µéšçš„ç”Ÿæˆå®Œäº† - å…¨9æ®µéšå®Ÿè¡Œæ¸ˆã¿');

  } catch (error) {
    console.error('ğŸš¨ Integrated micro generation error:', error);
    console.error('ğŸš¨ Error stack:', error.stack);
    
    const errorResponse = {
      success: false,
      error: error.message || 'Generation failed',
      errorType: error.name || error.type || 'UnknownError',
      details: process.env.NODE_ENV === 'development' ? error.stack : undefined,
      timestamp: new Date().toISOString()
    };
    
    // EventSourceåˆ¤å®šã‚’å†å®Ÿè¡Œ
    const isEventSourceError = req.body?.stream === true || req.headers.accept?.includes('text/event-stream');
    
    if (isEventSourceError) {
      try {
        res.write(`event: error\ndata: ${JSON.stringify(errorResponse)}\n\n`);
        res.end();
      } catch (writeError) {
        console.error('Error writing to response:', writeError);
      }
    } else {
      return res.status(500).json(errorResponse);
    }
  }
}

// ========== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•° ==========

/**
 * ğŸš€ ç”Ÿæˆãƒ•ãƒ­ãƒ¼æœ€é©åŒ–
 */
async function optimizeGenerationFlow(flow, formData) {
  // ç¾åœ¨ã¯é †æ¬¡å®Ÿè¡Œã‚’ç¶­æŒï¼ˆå°†æ¥ã®æ‹¡å¼µãƒã‚¤ãƒ³ãƒˆï¼‰
  return {
    canParallelize: false,
    tasks: flow,
    reason: 'Sequential execution for content dependency'
  };
}

/**
 * ğŸ”‘ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚­ãƒ¼ç”Ÿæˆ
 */
function createCacheKey(stepName, formData) {
  const relevantFields = {
    participants: formData.participants,
    era: formData.era,
    setting: formData.setting,
    complexity: formData.complexity,
    tone: formData.tone,
    incident_type: formData.incident_type
  };
  
  const dataHash = createFormDataHash(relevantFields);
  return `${stepName}_${dataHash}`;
}

/**
 * ğŸ” ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ãƒãƒƒã‚·ãƒ¥ç”Ÿæˆ
 */
function createFormDataHash(formData) {
  try {
    // ç°¡å˜ã§ç¢ºå®Ÿãªãƒãƒƒã‚·ãƒ¥ç”Ÿæˆ
    const dataString = JSON.stringify(formData, Object.keys(formData).sort());
    let hash = 0;
    for (let i = 0; i < dataString.length; i++) {
      const char = dataString.charCodeAt(i);
      hash = ((hash << 5) - hash) + char;
      hash = hash & hash; // 32bit int
    }
    return Math.abs(hash).toString(16).substring(0, 8);
  } catch (error) {
    console.error('Hash generation error:', error);
    return Date.now().toString(16).substring(0, 8);
  }
}

function getPlayTime(complexity) {
  const timeMap = {
    'simple': '30åˆ†',
    'standard': '45åˆ†', 
    'complex': '60åˆ†'
  };
  return timeMap[complexity] || '45åˆ†';
}

/**
 * ğŸ›¡ï¸ ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç”Ÿæˆ
 */
function generateFallbackCharacters(count) {
  const characters = [];
  const names = ['ç”°ä¸­å¤ªéƒ', 'ä½è—¤èŠ±å­', 'å±±ç”°æ¬¡éƒ', 'éˆ´æœ¨ç¾å’²', 'é«˜æ©‹å¥ä¸€', 'æ¸¡è¾ºç†æµ'];
  const jobs = ['ä¼šç¤¾å“¡', 'å¤§å­¦ç”Ÿ', 'åŒ»å¸«', 'æ•™å¸«', 'å¼è­·å£«', 'è¨˜è€…'];
  
  for (let i = 0; i < count; i++) {
    characters.push(`
## ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${i + 1}ã®ãƒãƒ³ãƒ‰ã‚¢ã‚¦ãƒˆ

### ã‚ãªãŸã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼
æ°å: ${names[i] || `ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${i + 1}`}
å¹´é½¢: ${20 + Math.floor(Math.random() * 40)}æ­³
è·æ¥­: ${jobs[i] || 'ä¼šç¤¾å“¡'}
æ€§æ ¼: çœŸé¢ç›®ã§è²¬ä»»æ„ŸãŒå¼·ã„

### ãƒãƒƒã‚¯ã‚¹ãƒˆãƒ¼ãƒªãƒ¼
åœ°å…ƒå‡ºèº«ã§ã€ç¾åœ¨ã¯éƒ½å¸‚éƒ¨ã§åƒã„ã¦ã„ã‚‹ã€‚å®¶æ—æ€ã„ã§ã€æ­£ç¾©æ„ŸãŒå¼·ã„æ€§æ ¼ã€‚

### ç§˜å¯†æƒ…å ±
- å…¬é–‹æƒ…å ±: ä¿¡é ¼ã§ãã‚‹äººç‰©ã¨ã—ã¦çŸ¥ã‚‰ã‚Œã¦ã„ã‚‹
- ç§˜å¯†: éå»ã«é‡è¦ãªå‡ºæ¥äº‹ã‚’ç›®æ’ƒã—ã¦ã„ã‚‹
- ç›®æ¨™: çœŸå®Ÿã‚’æ˜ã‚‰ã‹ã«ã—ãŸã„

### ä»–ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã¨ã®é–¢ä¿‚
ä»–ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¨ã¯çŸ¥äººã¾ãŸã¯å‹äººé–¢ä¿‚ã€‚
    `);
  }
  
  return characters.join('\n');
}

/**
 * ğŸ² ãƒ©ãƒ³ãƒ€ãƒ ç”Ÿæˆçµæœã‚’æ—¢å­˜ã®sessionDataãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã«å¤‰æ›
 */
function convertRandomToSessionFormat(randomData, formData, sessionId) {
  const { title, genre, setting, plot, characters, clues, files } = randomData;
  
  // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒãƒ³ãƒ‰ã‚¢ã‚¦ãƒˆã®æ§‹ç¯‰
  const characterHandouts = characters.map((char, index) => `
## ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${index + 1}å°‚ç”¨ãƒãƒ³ãƒ‰ã‚¢ã‚¦ãƒˆã€‘

### ã‚ãªãŸã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼
**æ°å**: ${char.name}
**å¹´é½¢**: ${char.age}æ­³
**è·æ¥­**: ${char.profession}
**æ€§æ ¼**: ${char.personality}
**å½¹å‰²**: ${char.role}

### ã‚ãªãŸã®èƒŒæ™¯ã¨å‹•æ©Ÿ
${char.secret || 'ç‰¹ã«ãªã—'}

### ä»–ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¨ã®é–¢ä¿‚æ€§
${char.relationship || 'åˆæœŸæ®µéšã§ã¯ä¸æ˜'}
`).join('\n\n---\n\n');

  // è¨¼æ‹ ã‚·ã‚¹ãƒ†ãƒ ã®æ§‹ç¯‰
  const evidenceSystem = `
## è¨¼æ‹ é…ç½®ãƒ»æ‰‹ãŒã‹ã‚Šä½“ç³»

### é‡è¦ãªè¨¼æ‹ 
${clues.map((clue, i) => `
${i + 1}. **${clue.name}**
   - ç¨®é¡: ${clue.type}
   - ç™ºè¦‹å ´æ‰€: ${clue.location || 'ç¾å ´ä»˜è¿‘'}
   - é‡è¦åº¦: ${clue.importance || 'ä¸­'}
`).join('\n')}

### çœŸç›¸ã¸ã®é“ç­‹
${plot.chapters ? plot.chapters.join('\n\n') : plot.fullStory}
`;

  // sessionDataãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã«å¤‰æ›
  return {
    sessionId: sessionId || `random_${Date.now()}`,
    formData: {
      ...formData,
      generationType: 'random'
    },
    startTime: new Date().toISOString(),
    completedAt: new Date().toISOString(),
    status: 'completed',
    generationType: 'random',
    phases: {
      step0: {
        name: 'ãƒ©ãƒ³ãƒ€ãƒ å…¨ä½“æ§‹é€ ',
        content: {
          randomOutline: `## ä½œå“åŸºæœ¬æƒ…å ±ï¼ˆãƒ©ãƒ³ãƒ€ãƒ ç”Ÿæˆï¼‰\n**ä½œå“ã‚¿ã‚¤ãƒˆãƒ«**: ${title}\n**åŸºæœ¬ã‚³ãƒ³ã‚»ãƒ—ãƒˆ**: ${genre}ã‚’èˆå°ã¨ã—ãŸ${setting}ã®ãƒŸã‚¹ãƒ†ãƒªãƒ¼\n**èˆå°è¨­å®š**: ${setting}`
        },
        status: 'completed'
      },
      step1: {
        name: 'åŸºæœ¬ã‚³ãƒ³ã‚»ãƒ—ãƒˆ',
        content: {
          concept: `## ä½œå“ã‚¿ã‚¤ãƒˆãƒ«\n${title}\n\n## ä½œå“ã‚³ãƒ³ã‚»ãƒ—ãƒˆ\nã‚¸ãƒ£ãƒ³ãƒ«: ${genre}\nèˆå°: ${setting}\n\n${plot.fullStory || ''}`
        },
        status: 'completed'
      },
      step2: {
        name: 'äº‹ä»¶æ ¸å¿ƒ',
        content: {
          incidentCore: `## äº‹ä»¶ã®æ ¸å¿ƒ\nå‹•æ©Ÿ: ${randomData.motive}\nãƒˆãƒªãƒƒã‚¯: ${randomData.trick}\n\nè¢«å®³è€…: ${characters.find(c => c.role === 'è¢«å®³è€…')?.name || 'ä¸æ˜'}\nçŠ¯äºº: ${characters.find(c => c.role === 'çŠ¯äºº')?.name || 'ä¸æ˜'}`
        },
        status: 'completed'
      },
      step3: {
        name: 'äº‹ä»¶è©³ç´°',
        content: {
          incidentDetails: plot.fullStory || 'è©³ç´°ãªãƒ—ãƒ­ãƒƒãƒˆã¯ç”Ÿæˆã•ã‚Œã¾ã—ãŸ'
        },
        status: 'completed'
      },
      step4: {
        name: 'ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç”Ÿæˆ',
        content: {
          characters: characterHandouts,
          character_count: characters.length
        },
        status: 'completed'
      },
      step5: {
        name: 'è¨¼æ‹ é…ç½®',
        content: {
          evidence_system: evidenceSystem
        },
        status: 'completed'
      },
      step6: {
        name: 'GMé€²è¡Œã‚¬ã‚¤ãƒ‰',
        content: {
          gamemaster_guide: files['GMç”¨çœŸç›¸è§£èª¬']?.content || ''
        },
        status: 'completed'
      },
      step7: {
        name: 'é…å¸ƒè³‡æ–™æº–å‚™',
        content: {
          handouts: files['ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å°å…¥']?.content || '',
          downloadableFiles: Object.keys(files).map(key => ({
            name: files[key].filename,
            path: files[key].path,
            content: files[key].content
          }))
        },
        status: 'completed'
      }
    },
    context: randomData,
    files: files,
    images: [],
    hasImages: false
  };
}