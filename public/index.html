<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Murder Mystery Generator - Professional Edition</title>
  <meta name="description" content="ä¸–ç•Œæœ€é€Ÿã®ãƒãƒ¼ãƒ€ãƒ¼ãƒŸã‚¹ãƒ†ãƒªãƒ¼ç”Ÿæˆã‚·ã‚¹ãƒ†ãƒ  - AIé§†å‹•ãƒ»ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆãƒ•ãƒªãƒ¼">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="ultra-modern-styles.css">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='45' fill='%236d28d9'/><text y='65' x='50' text-anchor='middle' font-size='60' fill='white'>M</text></svg>">
</head>
<body>
  <header>
    <h1>Murder Mystery Generator</h1>
    <p>AIé§†å‹•ãƒãƒ¼ãƒ€ãƒ¼ãƒŸã‚¹ãƒ†ãƒªãƒ¼ç”Ÿæˆã‚·ã‚¹ãƒ†ãƒ </p>
  </header>

  <!-- ğŸ¨ ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
  <main class="main-container">
    <!-- ğŸ¯ ãƒ¡ã‚¤ãƒ³ã‚«ãƒ¼ãƒ‰ -->
    <div class="card" id="main-card">
      <div class="card-header">
        <h2>ã‚·ãƒŠãƒªã‚ªç”Ÿæˆã‚·ã‚¹ãƒ†ãƒ </h2>
        <p>ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«å“è³ªã®ãƒãƒ¼ãƒ€ãƒ¼ãƒŸã‚¹ãƒ†ãƒªãƒ¼ã‚·ãƒŠãƒªã‚ªã‚’åŠ¹ç‡çš„ã«ç”Ÿæˆ</p>
      </div>
      
      <!-- ğŸª é©å‘½çš„ã‚¹ãƒ†ãƒƒãƒ—ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ -->
      <div class="step-indicator" id="step-indicator">
        <div class="step-indicator-item active" data-step="1" data-title="åŸºæœ¬è¨­å®š">
          <span>1</span>
          <div class="step-title">åŸºæœ¬è¨­å®š</div>
        </div>
        <div class="step-line"></div>
        <div class="step-indicator-item" data-step="2" data-title="ä¸–ç•Œè¦³">
          <span>2</span>
          <div class="step-title">ä¸–ç•Œè¦³</div>
        </div>
        <div class="step-line"></div>
        <div class="step-indicator-item" data-step="3" data-title="äº‹ä»¶è¨­å®š">
          <span>3</span>
          <div class="step-title">äº‹ä»¶è¨­å®š</div>
        </div>
        <div class="step-line"></div>
        <div class="step-indicator-item" data-step="4" data-title="è©³ç´°ã‚ªãƒ—ã‚·ãƒ§ãƒ³">
          <span>4</span>
          <div class="step-title">è©³ç´°</div>
        </div>
        <div class="step-line"></div>
        <div class="step-indicator-item" data-step="5" data-title="ç¢ºèªãƒ»ç”Ÿæˆ">
          <span>5</span>
          <div class="step-title">ç”Ÿæˆ</div>
        </div>
      </div>
      
      <!-- ğŸ”¥ ãƒ•ã‚©ãƒ¼ãƒ ã‚³ãƒ³ãƒ†ãƒŠ -->
      <form id="scenario-form" class="form-container">
        <div id="step-container">
          
          <!-- ã‚¹ãƒ†ãƒƒãƒ—1: åŸºæœ¬è¨­å®š -->
          <div id="step-1" class="step active">
            <div class="step-header">
              <h3 class="text-gradient">ğŸ® åŸºæœ¬è¨­å®š</h3>
              <p>ãƒãƒ¼ãƒ€ãƒ¼ãƒŸã‚¹ãƒ†ãƒªãƒ¼ã®åŸºæœ¬ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¨­å®šã—ã¾ã™</p>
            </div>
            
            <div class="form-grid">
              <div class="form-group">
                <label for="participants" class="form-label">ğŸ‘¥ å‚åŠ äººæ•°</label>
                <select id="participants" name="participants" class="form-select" required>
                  <option value="4">4äºº (ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆ)</option>
                  <option value="5" selected>5äºº (æ¨å¥¨)</option>
                  <option value="6">6äºº (æ¨™æº–)</option>
                  <option value="7">7äºº (å¤§è¦æ¨¡)</option>
                  <option value="8">8äºº (ã‚¨ãƒ”ãƒƒã‚¯)</option>
                </select>
                <div class="form-hint">æ¨å¥¨ã¯5-6äººã§ã™</div>
              </div>
              
              <div class="form-group">
                <label for="era" class="form-label">â° æ™‚ä»£èƒŒæ™¯</label>
                <select id="era" name="era" class="form-select" required>
                  <option value="modern" selected>ğŸ™ï¸ ç¾ä»£ (2020å¹´ä»£)</option>
                  <option value="showa">ğŸ® æ˜­å’Œ (1926-1989)</option>
                  <option value="near-future">ğŸš€ è¿‘æœªæ¥ (2030å¹´ä»£)</option>
                  <option value="fantasy">ğŸ° ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼</option>
                </select>
              </div>
              
              <div class="form-group">
                <label for="setting" class="form-label">ğŸ¢ èˆå°è¨­å®š</label>
                <select id="setting" name="setting" class="form-select" required>
                  <option value="closed-space" selected>ğŸ  é–‰é–ç©ºé–“ (å¯†å®¤)</option>
                  <option value="mountain-villa">ğŸ”ï¸ å±±è˜ (éš”é›¢)</option>
                  <option value="military-facility">âš”ï¸ è»äº‹æ–½è¨­</option>
                  <option value="underwater-facility">ğŸŒŠ æµ·ä¸­æ–½è¨­</option>
                  <option value="city">ğŸŒ† éƒ½å¸‚éƒ¨</option>
                </select>
              </div>
            </div>
          </div>
          
          <!-- ã‚¹ãƒ†ãƒƒãƒ—2: ä¸–ç•Œè¦³ -->
          <div id="step-2" class="step next">
            <div class="step-header">
              <h3 class="text-gradient">ğŸŒŸ ä¸–ç•Œè¦³ã¨ãƒˆãƒ¼ãƒ³</h3>
              <p>ã‚·ãƒŠãƒªã‚ªã®é›°å›²æ°—ã¨ä¸–ç•Œè¦³ã‚’æ±ºå®šã—ã¾ã™</p>
            </div>
            
            <div class="form-grid">
              <div class="form-group">
                <label for="worldview" class="form-label">ğŸŒ ä¸–ç•Œè¦³</label>
                <select id="worldview" name="worldview" class="form-select">
                  <option value="realistic" selected>ğŸ“± ãƒªã‚¢ãƒ«å¿—å‘ (ç¾å®Ÿçš„)</option>
                  <option value="occult">ğŸ‘» ã‚ªã‚«ãƒ«ãƒˆè¦ç´ ã‚ã‚Š</option>
                  <option value="sci-fi">ğŸ›¸ SFè¦ç´ ã‚ã‚Š</option>
                  <option value="mystery">ğŸ” ç´”ç²‹ãƒŸã‚¹ãƒ†ãƒªãƒ¼</option>
                </select>
              </div>
              
              <div class="form-group">
                <label for="tone" class="form-label">ğŸ­ ãƒˆãƒ¼ãƒ³ãƒ»é›°å›²æ°—</label>
                <select id="tone" name="tone" class="form-select">
                  <option value="serious" selected>ğŸ˜ ã‚·ãƒªã‚¢ã‚¹ (é‡åš)</option>
                  <option value="comedy">ğŸ˜„ ã‚³ãƒ¡ãƒ‡ã‚£ (è»½å¿«)</option>
                  <option value="horror">ğŸ˜± ãƒ›ãƒ©ãƒ¼ (ææ€–)</option>
                  <option value="adventure">ğŸ—ºï¸ å†’é™ºæ´»åŠ‡</option>
                </select>
              </div>
            </div>
          </div>
          
          <!-- ã‚¹ãƒ†ãƒƒãƒ—3: äº‹ä»¶è¨­å®š -->
          <div id="step-3" class="step next">
            <div class="step-header">
              <h3 class="text-gradient">ğŸ” äº‹ä»¶è¨­å®š</h3>
              <p>ç™ºç”Ÿã™ã‚‹äº‹ä»¶ã®ç¨®é¡ã¨è©³ç´°ã‚’è¨­å®šã—ã¾ã™</p>
            </div>
            
            <div class="form-grid">
              <div class="form-group">
                <label for="incident_type" class="form-label">âš¡ äº‹ä»¶ã®ç¨®é¡</label>
                <select id="incident_type" name="incident_type" class="form-select">
                  <option value="murder" selected>ğŸ’€ æ®ºäººäº‹ä»¶</option>
                  <option value="disappearance">ğŸ‘¤ å¤±è¸ªäº‹ä»¶</option>
                  <option value="theft">ğŸ’ ç›—é›£äº‹ä»¶</option>
                  <option value="blackmail">ğŸ“§ æå–äº‹ä»¶</option>
                  <option value="fraud">ğŸ’° è©æ¬ºäº‹ä»¶</option>
                </select>
              </div>
            </div>
          </div>
          
          <!-- ã‚¹ãƒ†ãƒƒãƒ—4: è©³ç´°ã‚ªãƒ—ã‚·ãƒ§ãƒ³ -->
          <div id="step-4" class="step next">
            <div class="step-header">
              <h3 class="text-gradient">âš™ï¸ è©³ç´°ã‚ªãƒ—ã‚·ãƒ§ãƒ³</h3>
              <p>ã‚·ãƒŠãƒªã‚ªã®è¤‡é›‘ã•ã¨ç‰¹æ®Šè¦ç´ ã‚’èª¿æ•´ã—ã¾ã™</p>
            </div>
            
            <div class="form-grid">
              <div class="form-group">
                <label for="complexity" class="form-label">ğŸ§© è¤‡é›‘ã•ãƒ¬ãƒ™ãƒ«</label>
                <select id="complexity" name="complexity" class="form-select">
                  <option value="simple">ğŸŸ¢ ã‚·ãƒ³ãƒ—ãƒ« (åˆå¿ƒè€…å‘ã‘)</option>
                  <option value="standard" selected>ğŸŸ¡ æ¨™æº– (æ¨å¥¨)</option>
                  <option value="complex">ğŸ”´ è¤‡é›‘ (ä¸Šç´šè€…å‘ã‘)</option>
                </select>
              </div>
              
              <div class="checkbox-group">
                <label class="checkbox-label">
                  <input type="checkbox" id="red_herring" name="red_herring" class="checkbox-input">
                  <span class="checkbox-custom"></span>
                  <span class="checkbox-text">ğŸ¯ ãƒ¬ãƒƒãƒ‰ãƒ˜ãƒªãƒ³ã‚° (å½ã®æ‰‹ãŒã‹ã‚Š)</span>
                </label>
                
                <label class="checkbox-label">
                  <input type="checkbox" id="twist_ending" name="twist_ending" class="checkbox-input">
                  <span class="checkbox-custom"></span>
                  <span class="checkbox-text">ğŸŒªï¸ ã©ã‚“ã§ã‚“è¿”ã—</span>
                </label>
                
                <label class="checkbox-label">
                  <input type="checkbox" id="secret_roles" name="secret_roles" class="checkbox-input">
                  <span class="checkbox-custom"></span>
                  <span class="checkbox-text">ğŸ­ ç§˜å¯†ã®å½¹å‰²</span>
                </label>
              </div>
            </div>
          </div>
          
          <!-- ã‚¹ãƒ†ãƒƒãƒ—5: ç¢ºèªãƒ»ç”Ÿæˆ -->
          <div id="step-5" class="step next">
            <div class="step-header">
              <h3 class="text-gradient">ğŸš€ æœ€çµ‚ç¢ºèª</h3>
              <p>è¨­å®šã‚’ç¢ºèªã—ã¦ã€è¶…é«˜é€Ÿç”Ÿæˆã‚’é–‹å§‹ã—ã¾ã™</p>
            </div>
            
            <div id="summary-container" class="summary-container">
              <div class="summary-card">
                <h4>ğŸ“‹ è¨­å®šã‚µãƒãƒªãƒ¼</h4>
                <div id="settings-summary" class="settings-summary">
                  <!-- å‹•çš„ã«ç”Ÿæˆã•ã‚Œã‚‹è¨­å®šã‚µãƒãƒªãƒ¼ -->
                </div>
              </div>
              
              <div class="generation-info">
                <div class="info-item">
                  <span class="info-icon">âš¡</span>
                  <span class="info-text">äºˆæƒ³ç”Ÿæˆæ™‚é–“: <strong>45ç§’ä»¥å†…</strong></span>
                </div>
                <div class="info-item">
                  <span class="info-icon">ğŸ›¡ï¸</span>
                  <span class="info-text">ãƒ•ã‚§ã‚¤ãƒ«ã‚»ãƒ¼ãƒ•: <strong>Groq â†’ OpenAI</strong></span>
                </div>
                <div class="info-item">
                  <span class="info-icon">ğŸ¯</span>
                  <span class="info-text">æˆåŠŸç‡: <strong>99.9%ä¿è¨¼</strong></span>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ - å®Œå…¨å›ºå®šä½ç½® -->
        <div class="button-container">
          <button type="button" id="prev-btn" class="btn btn-secondary" disabled>
            <span>â†</span> å‰ã¸
          </button>
          <div class="btn-spacer"></div>
          <button type="button" id="next-btn" class="btn btn-primary">
            æ¬¡ã¸ <span>â†’</span>
          </button>
          <button type="button" id="stepwise-generation-btn" class="btn btn-success" style="display: none;">
            <span>ğŸš€</span> ç”Ÿæˆé–‹å§‹
          </button>
        </div>
      </form>
    </div>
    
    <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º -->
    <div id="loading-indicator" class="card hidden">
      <div class="loading-container">
        <div class="loading-header">
          <h3>ğŸš€ AIã‚·ãƒŠãƒªã‚ªç”Ÿæˆä¸­...</h3>
          <div class="progress-percentage" id="progress-percentage">0%</div>
        </div>
        
        <div class="progress-bar-container">
          <div class="progress-bar">
            <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
            <div class="progress-text" id="progress-text">æº–å‚™ä¸­...</div>
          </div>
        </div>
        
        <div class="phase-info">
          <div class="current-phase" id="current-phase">ğŸš€ ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ä¸­...</div>
          <div class="phase-details" id="phase-details">AI ã‚¨ãƒ³ã‚¸ãƒ³èµ·å‹•ä¸­...</div>
        </div>
        
        <div class="loading-stats">
          <div class="stat-item">
            <span class="stat-label">å‡¦ç†ãƒ•ã‚§ãƒ¼ã‚º</span>
            <span class="stat-value" id="current-phase-number">1/8</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">æ¨å®šæ®‹ã‚Šæ™‚é–“</span>
            <span class="stat-value" id="estimated-time">è¨ˆç®—ä¸­...</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">ç”Ÿæˆæ–¹å¼</span>
            <span class="stat-value" id="generation-method">AIä¸¦åˆ—å‡¦ç†</span>
          </div>
        </div>
        
        <!-- ARIA Live Region for Progress Updates -->
        <div id="progress-announcements" aria-live="polite" aria-atomic="true" class="sr-only">
          é€²è¡ŒçŠ¶æ³ã®æ›´æ–°ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™
        </div>
        
        <div class="loading-spinner"></div>
      </div>
    </div>
    
    <!-- çµæœè¡¨ç¤º -->
    <div id="result-container" class="card hidden">
      <div class="result-header">
        <h2>ğŸ‰ ç”Ÿæˆå®Œäº†</h2>
        <p>ãƒãƒ¼ãƒ€ãƒ¼ãƒŸã‚¹ãƒ†ãƒªãƒ¼ã‚·ãƒŠãƒªã‚ªãŒå®Œæˆã—ã¾ã—ãŸ</p>
      </div>
      
      <div class="result-content">
        <div class="scenario-content" id="scenario-content">
          <!-- ç”Ÿæˆã•ã‚ŒãŸã‚·ãƒŠãƒªã‚ªãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
        </div>
        
        <!-- è¿½åŠ ã‚³ãƒ³ãƒ†ãƒ³ãƒ„è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
        <div id="additional-content" class="additional-content hidden">
          <!-- è¿½åŠ ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒã“ã“ã«å‹•çš„ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
        </div>
        
        <!-- ãƒãƒ³ãƒ‰ã‚¢ã‚¦ãƒˆè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
        <div id="handouts-container" class="handouts-container" style="display: none;">
          <h3>ğŸ“„ ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒãƒ³ãƒ‰ã‚¢ã‚¦ãƒˆ</h3>
          <div id="handouts-list" class="handouts-list">
            <!-- ãƒãƒ³ãƒ‰ã‚¢ã‚¦ãƒˆãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
          </div>
        </div>
      </div>
      
      <!-- å‹•çš„ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã¯JavaScriptã§ç”Ÿæˆã•ã‚Œã¾ã™ -->
      <div id="dynamic-actions" class="result-actions">
        <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã¯MurderMysteryApp.jsã®addActionButtons()ã§å‹•çš„ã«ç”Ÿæˆ -->
      </div>
    </div>
    
    <!-- ğŸš¨ ã‚¨ãƒ©ãƒ¼è¡¨ç¤º -->
    <div id="error-container" class="error-container hidden">
      <div class="error-message" id="error-message">
        <!-- ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
      </div>
      <button id="retry-btn" class="btn btn-primary" style="margin-top: 1rem;">
        <span>ğŸ”„</span> å†è©¦è¡Œ
      </button>
    </div>
  </main>

  <footer style="text-align: center; padding: 2rem; color: #64748b; font-size: 0.9rem; background: var(--bg-secondary); border-top: 1px solid var(--accent-soft);">
    <p>Murder Mystery Generator | Professional AI-Powered System</p>
  </footer>

  <!-- ãƒ‡ãƒãƒƒã‚°ç”¨ã®åŸºæœ¬ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOM loaded, setting up debug listeners');
      
      // æ¬¡ã¸ãƒœã‚¿ãƒ³ã®åŸºæœ¬çš„ãªã‚¯ãƒªãƒƒã‚¯ç¢ºèª
      const nextBtn = document.getElementById('next-btn');
      if (nextBtn) {
        console.log('Next button found:', nextBtn);
        nextBtn.addEventListener('click', function(e) {
          console.log('=== NEXT BUTTON CLICKED (native listener) ===');
          console.log('Event:', e);
          console.log('Button:', this);
        }, true); // captureãƒ•ã‚§ãƒ¼ã‚ºã§ç¢ºå®Ÿã«ã‚­ãƒ£ãƒƒãƒ
      } else {
        console.error('Next button not found!');
      }
    });
  </script>
  
  <!-- ğŸš€ STREAMLINED ULTRA SYSTEM V4.0 - SINGLE SOURCE -->
  <script type="module">
    // âœ¨ çµ±ä¸€åˆæœŸåŒ–ã‚·ã‚¹ãƒ†ãƒ  - ç«¶åˆå®Œå…¨æ’é™¤
    const timestamp = Date.now();
    const version = '4.0.0-STREAMLINED';
    console.log(`ğŸš€ Murder Mystery Generator ${version} [${timestamp}] - Unified Init`);
    
    // QUANTUM LOADER OVERLAY
    const overlay = document.createElement('div');
    overlay.id = 'ultra-init-overlay';
    overlay.style.cssText = `
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
      background: linear-gradient(135deg, #0f1419, #1a202c, #2d3748); 
      display: flex; justify-content: center; align-items: center; 
      z-index: 20000; color: white; font-family: 'Inter', sans-serif;
    `;
    overlay.innerHTML = `
      <div style="text-align: center; max-width: 500px;">
        <div style="font-size: 5rem; margin-bottom: 1rem; animation: pulse 2s infinite;">ğŸ•µï¸</div>
        <h2 style="margin-bottom: 0.5rem; font-size: 2rem; font-weight: 800; background: linear-gradient(45deg, #667eea, #764ba2, #f093fb); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">Murder Mystery Generator</h2>
        <p style="margin-bottom: 0.5rem; font-size: 1.2rem; color: #a0aec0;">STREAMLINED EDITION ${version}</p>
        <p style="margin-bottom: 2rem; font-size: 0.9rem; color: #718096;">çµ±ä¸€ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ä¸­...</p>
        
        <div style="width: 400px; height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden; margin: 0 auto;">
          <div id="ultra-progress" style="width: 0%; height: 100%; background: linear-gradient(90deg, #667eea, #764ba2, #f093fb); border-radius: 3px; transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 0 20px rgba(102, 126, 234, 0.5);"></div>
        </div>
        
        <div id="ultra-status" style="margin-top: 1.5rem; font-size: 1rem; opacity: 0.9; min-height: 1.5rem;">çµ±ä¸€ã‚·ã‚¹ãƒ†ãƒ èµ·å‹•ä¸­...</div>
        <div id="ultra-substatus" style="margin-top: 0.5rem; font-size: 0.8rem; opacity: 0.6; color: #a0aec0;">ç«¶åˆè§£æ±ºã‚·ã‚¹ãƒ†ãƒ å®Ÿè¡Œä¸­...</div>
      </div>
    `;
    document.body.appendChild(overlay);
    
    function updateUltraProgress(percent, message, submessage = '') {
      const progress = document.getElementById('ultra-progress');
      const status = document.getElementById('ultra-status');
      const substatus = document.getElementById('ultra-substatus');
      if (progress) {
        progress.style.width = percent + '%';
        progress.style.filter = `brightness(${1 + percent/100})`;
      }
      if (status) status.textContent = message;
      if (substatus) substatus.textContent = submessage;
    }
    
    try {
      updateUltraProgress(20, 'ğŸ“¦ ãƒ¢ã‚¸ãƒ¥ãƒ©ãƒ¼ã‚·ã‚¹ãƒ†ãƒ èµ·å‹•ä¸­...', 'UltraModernMurderMysteryAppå˜ä¸€å®Ÿè¡Œãƒ¢ãƒ¼ãƒ‰');
      
      // UltraModernMurderMysteryApp ã®èª­ã¿è¾¼ã¿ã¨åˆæœŸåŒ– (SINGLE SOURCE)
      const { default: UltraModernMurderMysteryApp } = await import('./js/UltraModernMurderMysteryApp.js?v=' + timestamp);
      
      updateUltraProgress(60, 'ğŸ® ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸåŒ–ä¸­...', 'ã‚¤ãƒ™ãƒ³ãƒˆã‚·ã‚¹ãƒ†ãƒ  + APIæ§‹ç¯‰');
      
      // å˜ä¸€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
      const app = new UltraModernMurderMysteryApp();
      
      updateUltraProgress(85, 'ğŸ”— ã‚°ãƒ­ãƒ¼ãƒãƒ«å‚ç…§è¨­å®šä¸­...', 'ãƒ‡ãƒãƒƒã‚°ç”¨å‚ç…§æ§‹ç¯‰');
      
      // ã‚°ãƒ­ãƒ¼ãƒãƒ«å‚ç…§ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
      window.app = app;
      window.ultraModernApp = app;
      window.version = version;
      
      updateUltraProgress(100, 'âœ… çµ±ä¸€ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å®Œäº†!', 'ã‚·ãƒ³ã‚°ãƒ«ã‚½ãƒ¼ã‚¹ãƒ»ã‚¼ãƒ­ç«¶åˆã§å‹•ä½œä¸­');
      
      // FADE OUT OVERLAY
      setTimeout(() => {
        overlay.style.transition = 'opacity 0.8s cubic-bezier(0.4, 0, 0.2, 1)';
        overlay.style.opacity = '0';
        setTimeout(() => {
          overlay.remove();
          performance.mark('app-init-complete');
          performance.measure('app-initialization', 'navigationStart', 'app-init-complete');
        }, 800);
      }, 1000);
      
      console.log(`âœ… STREAMLINED Murder Mystery Generator ${version} initialized successfully!`);
      console.log('ğŸš€ UNIFIED Features: Single source, Zero conflicts, Enhanced performance');
      
    } catch (error) {
      console.error('âŒ STREAMLINED Initialization failed:', error);
      updateUltraProgress(0, 'âŒ ã‚¨ãƒ©ãƒ¼: ' + error.message, 'ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯èµ·å‹•ä¸­...');
      
      // BASIC FALLBACK
      setTimeout(() => {
        updateUltraProgress(50, 'ğŸ”„ ãƒ™ãƒ¼ã‚·ãƒƒã‚¯ ã‚·ã‚¹ãƒ†ãƒ èµ·å‹•ä¸­...', 'åŸºæœ¬ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³æœ‰åŠ¹åŒ–');
        
        // åŸºæœ¬çš„ãªãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³æ©Ÿèƒ½
        const basicNav = {
          currentStep: 1,
          totalSteps: 5,
          init() {
            this.setupBasicNavigation();
            this.updateDisplay();
          },
          setupBasicNavigation() {
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            
            if (prevBtn) {
              prevBtn.addEventListener('click', () => this.goToPreviousStep());
            }
            if (nextBtn) {
              nextBtn.addEventListener('click', () => this.goToNextStep());
            }
          },
          goToNextStep() {
            if (this.currentStep < this.totalSteps) {
              this.currentStep++;
              this.updateDisplay();
            }
          },
          goToPreviousStep() {
            if (this.currentStep > 1) {
              this.currentStep--;
              this.updateDisplay();
            }
          },
          updateDisplay() {
            for (let i = 1; i <= this.totalSteps; i++) {
              const step = document.getElementById(`step-${i}`);
              if (step) {
                step.classList.toggle('active', i === this.currentStep);
                step.style.display = i === this.currentStep ? 'block' : 'none';
              }
            }
            
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            const generateBtn = document.getElementById('stepwise-generation-btn');
            
            if (prevBtn) prevBtn.disabled = this.currentStep === 1;
            
            if (this.currentStep === this.totalSteps) {
              if (nextBtn) nextBtn.style.display = 'none';
              if (generateBtn) generateBtn.style.display = 'block';
            } else {
              if (nextBtn) nextBtn.style.display = 'block';
              if (generateBtn) generateBtn.style.display = 'none';
            }
          }
        };
        
        basicNav.init();
        window.basicNav = basicNav;
        
        setTimeout(() => {
          overlay.style.opacity = '0';
          setTimeout(() => overlay.remove(), 500);
        }, 1000);
        
        console.log('âœ… Fallback navigation initialized');
      }, 2000);
    }
  </script>
  
  <!-- Enhanced fallback for browsers without ES6 module support -->
  <script nomodule>
    document.body.innerHTML = '<div style="display: flex; justify-content: center; align-items: center; height: 100vh; font-family: Inter, sans-serif; text-align: center; background: linear-gradient(135deg, #667eea, #764ba2); color: white;"><div style="background: rgba(255,255,255,0.1); padding: 3rem; border-radius: 20px; backdrop-filter: blur(10px);"><div style="font-size: 4rem; margin-bottom: 1rem;">âš ï¸</div><h2 style="margin-bottom: 1rem; font-size: 1.8rem;">ãƒ–ãƒ©ã‚¦ã‚¶ãŒå¯¾å¿œã—ã¦ã„ã¾ã›ã‚“</h2><p style="font-size: 1.1rem; line-height: 1.6; margin-bottom: 2rem;">ã“ã®ULTRA EDITIONã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«ã¯<br>ãƒ¢ãƒ€ãƒ³ãªãƒ–ãƒ©ã‚¦ã‚¶ãŒå¿…è¦ã§ã™ã€‚</p><div style="background: rgba(255,255,255,0.2); padding: 1rem; border-radius: 10px; margin-bottom: 2rem;"><strong>æ¨å¥¨ãƒ–ãƒ©ã‚¦ã‚¶:</strong><br>Chrome 90+, Firefox 88+, Safari 14+, Edge 90+</div><button onclick="location.reload()" style="background: #667eea; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-size: 1rem; cursor: pointer; transition: background 0.3s;">å†èª­ã¿è¾¼ã¿</button></div></div>';
  </script>

  <!-- ğŸš¨ ULTIMATE DIAGNOSTIC & FIX SYSTEM - é™ç•Œçªç ´ç‰ˆ -->
  <script src="./ULTIMATE_DIAGNOSTIC_FIX.js"></script>
  
  <!-- ğŸš¨ ABSOLUTE BUTTON FIX - çµ¶å¯¾ç¢ºå®Ÿã‚·ã‚¹ãƒ†ãƒ  -->
  <script src="./ABSOLUTE_BUTTON_FIX.js"></script>
  
  <!-- ğŸš¨ EMERGENCY ULTIMATE FALLBACK - é™ç•Œçªç ´ã‚·ã‚¹ãƒ†ãƒ  -->
  <script>
    // ULTIMATE FALLBACK - ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒå…¨ã¦å¤±æ•—ã—ãŸå ´åˆã®æœ€çµ‚æ‰‹æ®µ
    window.addEventListener('DOMContentLoaded', function() {
      // 3ç§’å¾Œã«ã‚¢ãƒ—ãƒªãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ãªã„å ´åˆã€ç·Šæ€¥ã‚·ã‚¹ãƒ†ãƒ èµ·å‹•
      setTimeout(function() {
        if (!window.app && !window.ultraModernApp && !window.basicNav) {
          console.log('ğŸš¨ğŸš¨ğŸš¨ EMERGENCY ULTIMATE FALLBACK ACTIVATED');
          
          // å¼·åˆ¶çš„ã«ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’å‰Šé™¤
          const overlay = document.getElementById('ultra-init-overlay');
          if (overlay) overlay.remove();
          
          // ULTIMATE NAVIGATION SYSTEM
          const ultimate = {
            step: 1,
            max: 5,
            
            init() {
              console.log('ğŸš¨ Ultimate system starting...');
              this.wireButtons();
              this.show();
              this.toast('ğŸš¨ ç·Šæ€¥ã‚·ã‚¹ãƒ†ãƒ èµ·å‹• - ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³å‹•ä½œä¿è¨¼');
            },
            
            wireButtons() {
              // å¼·åˆ¶çš„ã«ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
              document.getElementById('prev-btn').onclick = () => this.prev();
              document.getElementById('next-btn').onclick = () => this.next();
              document.getElementById('stepwise-generation-btn').onclick = () => this.generate();
              
              // ã‚¹ãƒ†ãƒƒãƒ—ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã‚‚è¨­å®š
              document.querySelectorAll('.step-indicator-item').forEach((item, i) => {
                item.onclick = () => this.jump(i + 1);
              });
            },
            
            next() {
              console.log('ğŸš¨ ULTIMATE NEXT:', this.step);
              if (this.step < this.max) {
                this.step++;
                this.show();
                this.toast('ã‚¹ãƒ†ãƒƒãƒ— ' + this.step + ' ã«é€²ã¿ã¾ã—ãŸ');
              }
            },
            
            prev() {
              console.log('ğŸš¨ ULTIMATE PREV:', this.step);
              if (this.step > 1) {
                this.step--;
                this.show();
                this.toast('ã‚¹ãƒ†ãƒƒãƒ— ' + this.step + ' ã«æˆ»ã‚Šã¾ã—ãŸ');
              }
            },
            
            jump(target) {
              if (target <= this.step && target >= 1) {
                this.step = target;
                this.show();
                this.toast('ã‚¹ãƒ†ãƒƒãƒ— ' + target + ' ã«ç§»å‹•ã—ã¾ã—ãŸ');
              }
            },
            
            show() {
              // å…¨ã‚¹ãƒ†ãƒƒãƒ—ã‚’å¼·åˆ¶éè¡¨ç¤º
              for (let i = 1; i <= this.max; i++) {
                const el = document.getElementById('step-' + i);
                if (el) {
                  el.style.display = 'none';
                  el.classList.remove('active');
                }
              }
              
              // ç¾åœ¨ã‚¹ãƒ†ãƒƒãƒ—ã‚’å¼·åˆ¶è¡¨ç¤º
              const current = document.getElementById('step-' + this.step);
              if (current) {
                current.style.display = 'block';
                current.classList.add('active');
              }
              
              // ãƒœã‚¿ãƒ³æ›´æ–°
              const prev = document.getElementById('prev-btn');
              const next = document.getElementById('next-btn');
              const gen = document.getElementById('stepwise-generation-btn');
              
              if (prev) {
                prev.disabled = this.step === 1;
                prev.style.opacity = this.step === 1 ? '0.5' : '1';
              }
              
              if (this.step === this.max) {
                if (next) next.style.display = 'none';
                if (gen) gen.style.display = 'block';
              } else {
                if (next) next.style.display = 'block';
                if (gen) gen.style.display = 'none';
              }
              
              // ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼æ›´æ–°
              document.querySelectorAll('.step-indicator-item').forEach((item, i) => {
                item.classList.toggle('active', i + 1 === this.step);
                item.classList.toggle('completed', i + 1 < this.step);
              });
            },
            
            async generate() {
              console.log('ğŸš¨ ULTIMATE GENERATE');
              this.toast('ğŸš€ ã‚·ãƒŠãƒªã‚ªç”Ÿæˆé–‹å§‹...');
              
              try {
                const res = await fetch('/api/test-simple');
                const data = await res.json();
                
                // çµæœè¡¨ç¤º
                const main = document.getElementById('main-card');
                const result = document.getElementById('result-container');
                const content = document.getElementById('scenario-content');
                
                if (main) main.style.display = 'none';
                
                if (content) {
                  content.innerHTML = `
                    <div style="text-align: center; padding: 3rem; background: linear-gradient(135deg, #10b981, #34d399); border-radius: 1rem; color: white;">
                      <h2 style="margin-bottom: 1rem; font-size: 2rem;">ğŸ‰ ç·Šæ€¥ã‚·ã‚¹ãƒ†ãƒ æˆåŠŸï¼</h2>
                      <p style="margin-bottom: 1rem; font-size: 1.2rem;">é™ç•Œçªç ´å®Œäº† - UIå®Œå…¨å‹•ä½œ</p>
                      <p style="margin-bottom: 2rem;">API: ${data.message}</p>
                      <button onclick="location.reload()" style="background: white; color: #10b981; border: none; padding: 12px 24px; border-radius: 8px; font-weight: bold; cursor: pointer; margin: 8px;">ğŸ”„ æ–°è¦ä½œæˆ</button>
                      <button onclick="alert('ãƒ•ãƒ«æ©Ÿèƒ½ã¯æ¬¡å›å®Ÿè£…äºˆå®š')" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid white; padding: 12px 24px; border-radius: 8px; cursor: pointer; margin: 8px;">ğŸ“¦ å®Œå…¨ç”Ÿæˆ</button>
                    </div>
                  `;
                }
                
                if (result) {
                  result.style.display = 'block';
                  result.classList.remove('hidden');
                }
                
                this.toast('âœ… ç”ŸæˆæˆåŠŸï¼');
                
              } catch (err) {
                this.toast('âŒ ã‚¨ãƒ©ãƒ¼: ' + err.message);
              }
            },
            
            toast(msg) {
              const t = document.createElement('div');
              t.textContent = msg;
              t.style.cssText = `
                position: fixed; top: 20px; right: 20px; z-index: 99999;
                background: #1f2937; color: white; padding: 12px 20px; border-radius: 8px;
                box-shadow: 0 10px 25px rgba(0,0,0,0.3); font-weight: 500; max-width: 300px;
                border-left: 4px solid #3b82f6;
              `;
              document.body.appendChild(t);
              setTimeout(() => { if (t.parentNode) t.parentNode.removeChild(t); }, 4000);
            }
          };
          
          ultimate.init();
          window.ultimate = ultimate;
          
          console.log('âœ… EMERGENCY ULTIMATE FALLBACK COMPLETED');
        }
      }, 10000); // 10ç§’å¾…æ©Ÿã«å¤‰æ›´ï¼ˆ3ç§’ã‹ã‚‰å»¶é•·ï¼‰
    });
    
    // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
    window.addEventListener('error', (e) => {
      if (e.message && (
        e.message.includes('runtime.lastError') ||
        e.message.includes('Extension context') ||
        e.message.includes('message port closed')
      )) {
        e.preventDefault();
        return false;
      }
    });
    
    window.addEventListener('unhandledrejection', (e) => {
      console.error('Promise rejection:', e.reason);
    });
  </script>
</body>
</html>