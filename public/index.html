<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Murder Mystery Generator - Professional Edition</title>
  <meta name="description" content="ä¸–ç•Œæœ€é€Ÿã®ãƒãƒ¼ãƒ€ãƒ¼ãƒŸã‚¹ãƒ†ãƒªãƒ¼ç”Ÿæˆã‚·ã‚¹ãƒ†ãƒ  - AIé§†å‹•ãƒ»ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆãƒ•ãƒªãƒ¼">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="simple-modern-style.css">
  <link rel="stylesheet" href="ultra-enhanced-animations.css">
  <link rel="stylesheet" href="ultra-smooth-navigation.css">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='45' fill='%236d28d9'/><text y='65' x='50' text-anchor='middle' font-size='60' fill='white'>M</text></svg>">
</head>
<body>
  <header>
    <h1>Murder Mystery Generator</h1>
    <p>AIé§†å‹•ãƒãƒ¼ãƒ€ãƒ¼ãƒŸã‚¹ãƒ†ãƒªãƒ¼ç”Ÿæˆã‚·ã‚¹ãƒ†ãƒ </p>
  </header>

  <!-- ğŸ¨ ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
  <main class="main-container">
    <!-- ğŸ¯ ãƒ¡ã‚¤ãƒ³ã‚«ãƒ¼ãƒ‰ -->
    <div class="card" id="main-card">
      <div class="card-header">
        <h2>ã‚·ãƒŠãƒªã‚ªç”Ÿæˆã‚·ã‚¹ãƒ†ãƒ </h2>
        <p>ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«å“è³ªã®ãƒãƒ¼ãƒ€ãƒ¼ãƒŸã‚¹ãƒ†ãƒªãƒ¼ã‚·ãƒŠãƒªã‚ªã‚’åŠ¹ç‡çš„ã«ç”Ÿæˆ</p>
      </div>
      
      <!-- ğŸª é©å‘½çš„ã‚¹ãƒ†ãƒƒãƒ—ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ -->
      <div class="step-indicator" id="step-indicator">
        <div class="step-indicator-item active" data-step="1" data-title="åŸºæœ¬è¨­å®š">
          <span>1</span>
          <div class="step-title">åŸºæœ¬è¨­å®š</div>
        </div>
        <div class="step-line"></div>
        <div class="step-indicator-item" data-step="2" data-title="ä¸–ç•Œè¦³">
          <span>2</span>
          <div class="step-title">ä¸–ç•Œè¦³</div>
        </div>
        <div class="step-line"></div>
        <div class="step-indicator-item" data-step="3" data-title="äº‹ä»¶è¨­å®š">
          <span>3</span>
          <div class="step-title">äº‹ä»¶è¨­å®š</div>
        </div>
        <div class="step-line"></div>
        <div class="step-indicator-item" data-step="4" data-title="è©³ç´°ã‚ªãƒ—ã‚·ãƒ§ãƒ³">
          <span>4</span>
          <div class="step-title">è©³ç´°</div>
        </div>
        <div class="step-line"></div>
        <div class="step-indicator-item" data-step="5" data-title="ç¢ºèªãƒ»ç”Ÿæˆ">
          <span>5</span>
          <div class="step-title">ç”Ÿæˆ</div>
        </div>
      </div>
      
      <!-- ğŸ”¥ ãƒ•ã‚©ãƒ¼ãƒ ã‚³ãƒ³ãƒ†ãƒŠ -->
      <form id="scenario-form" class="form-container">
        <div id="step-container">
          
          <!-- ã‚¹ãƒ†ãƒƒãƒ—1: åŸºæœ¬è¨­å®š -->
          <div id="step-1" class="step active">
            <div class="step-header">
              <h3 class="text-gradient">ğŸ® åŸºæœ¬è¨­å®š</h3>
              <p>ãƒãƒ¼ãƒ€ãƒ¼ãƒŸã‚¹ãƒ†ãƒªãƒ¼ã®åŸºæœ¬ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¨­å®šã—ã¾ã™</p>
            </div>
            
            <div class="form-grid">
              <div class="form-group">
                <label for="participants" class="form-label">ğŸ‘¥ å‚åŠ äººæ•°</label>
                <select id="participants" name="participants" class="form-select">
                  <option value="4">4äºº (ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆ)</option>
                  <option value="5" selected>5äºº (æ¨å¥¨)</option>
                  <option value="6">6äºº (æ¨™æº–)</option>
                  <option value="7">7äºº (å¤§è¦æ¨¡)</option>
                  <option value="8">8äºº (ã‚¨ãƒ”ãƒƒã‚¯)</option>
                </select>
                <div class="form-hint">æ¨å¥¨ã¯5-6äººã§ã™</div>
              </div>
              
              <div class="form-group">
                <label for="era" class="form-label">â° æ™‚ä»£èƒŒæ™¯</label>
                <select id="era" name="era" class="form-select">
                  <option value="modern" selected>ğŸ™ï¸ ç¾ä»£ (2020å¹´ä»£)</option>
                  <option value="showa">ğŸ® æ˜­å’Œ (1926-1989)</option>
                  <option value="near-future">ğŸš€ è¿‘æœªæ¥ (2030å¹´ä»£)</option>
                  <option value="fantasy">ğŸ° ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼</option>
                </select>
              </div>
              
              <div class="form-group">
                <label for="setting" class="form-label">ğŸ¢ èˆå°è¨­å®š</label>
                <select id="setting" name="setting" class="form-select">
                  <option value="closed-space" selected>ğŸ  é–‰é–ç©ºé–“ (å¯†å®¤)</option>
                  <option value="mountain-villa">ğŸ”ï¸ å±±è˜ (éš”é›¢)</option>
                  <option value="military-facility">âš”ï¸ è»äº‹æ–½è¨­</option>
                  <option value="underwater-facility">ğŸŒŠ æµ·ä¸­æ–½è¨­</option>
                  <option value="city">ğŸŒ† éƒ½å¸‚éƒ¨</option>
                </select>
              </div>
            </div>
          </div>
          
          <!-- ã‚¹ãƒ†ãƒƒãƒ—2: ä¸–ç•Œè¦³ -->
          <div id="step-2" class="step next">
            <div class="step-header">
              <h3 class="text-gradient">ğŸŒŸ ä¸–ç•Œè¦³ã¨ãƒˆãƒ¼ãƒ³</h3>
              <p>ã‚·ãƒŠãƒªã‚ªã®é›°å›²æ°—ã¨ä¸–ç•Œè¦³ã‚’æ±ºå®šã—ã¾ã™</p>
            </div>
            
            <div class="form-grid">
              <div class="form-group">
                <label for="worldview" class="form-label">ğŸŒ ä¸–ç•Œè¦³</label>
                <select id="worldview" name="worldview" class="form-select">
                  <option value="realistic" selected>ğŸ“± ãƒªã‚¢ãƒ«å¿—å‘ (ç¾å®Ÿçš„)</option>
                  <option value="occult">ğŸ‘» ã‚ªã‚«ãƒ«ãƒˆè¦ç´ ã‚ã‚Š</option>
                  <option value="sci-fi">ğŸ›¸ SFè¦ç´ ã‚ã‚Š</option>
                  <option value="mystery">ğŸ” ç´”ç²‹ãƒŸã‚¹ãƒ†ãƒªãƒ¼</option>
                </select>
              </div>
              
              <div class="form-group">
                <label for="tone" class="form-label">ğŸ­ ãƒˆãƒ¼ãƒ³ãƒ»é›°å›²æ°—</label>
                <select id="tone" name="tone" class="form-select">
                  <option value="serious" selected>ğŸ˜ ã‚·ãƒªã‚¢ã‚¹ (é‡åš)</option>
                  <option value="comedy">ğŸ˜„ ã‚³ãƒ¡ãƒ‡ã‚£ (è»½å¿«)</option>
                  <option value="horror">ğŸ˜± ãƒ›ãƒ©ãƒ¼ (ææ€–)</option>
                  <option value="adventure">ğŸ—ºï¸ å†’é™ºæ´»åŠ‡</option>
                </select>
              </div>
            </div>
          </div>
          
          <!-- ã‚¹ãƒ†ãƒƒãƒ—3: äº‹ä»¶è¨­å®š -->
          <div id="step-3" class="step next">
            <div class="step-header">
              <h3 class="text-gradient">ğŸ” äº‹ä»¶è¨­å®š</h3>
              <p>ç™ºç”Ÿã™ã‚‹äº‹ä»¶ã®ç¨®é¡ã¨è©³ç´°ã‚’è¨­å®šã—ã¾ã™</p>
            </div>
            
            <div class="form-grid">
              <div class="form-group">
                <label for="incident_type" class="form-label">âš¡ äº‹ä»¶ã®ç¨®é¡</label>
                <select id="incident_type" name="incident_type" class="form-select">
                  <option value="murder" selected>ğŸ’€ æ®ºäººäº‹ä»¶</option>
                  <option value="disappearance">ğŸ‘¤ å¤±è¸ªäº‹ä»¶</option>
                  <option value="theft">ğŸ’ ç›—é›£äº‹ä»¶</option>
                  <option value="blackmail">ğŸ“§ æå–äº‹ä»¶</option>
                  <option value="fraud">ğŸ’° è©æ¬ºäº‹ä»¶</option>
                </select>
              </div>
            </div>
          </div>
          
          <!-- ã‚¹ãƒ†ãƒƒãƒ—4: è©³ç´°ã‚ªãƒ—ã‚·ãƒ§ãƒ³ -->
          <div id="step-4" class="step next">
            <div class="step-header">
              <h3 class="text-gradient">âš™ï¸ è©³ç´°ã‚ªãƒ—ã‚·ãƒ§ãƒ³</h3>
              <p>ã‚·ãƒŠãƒªã‚ªã®è¤‡é›‘ã•ã¨ç‰¹æ®Šè¦ç´ ã‚’èª¿æ•´ã—ã¾ã™</p>
            </div>
            
            <div class="form-grid">
              <div class="form-group">
                <label for="complexity" class="form-label">ğŸ§© è¤‡é›‘ã•ãƒ¬ãƒ™ãƒ«</label>
                <select id="complexity" name="complexity" class="form-select">
                  <option value="simple">ğŸŸ¢ ã‚·ãƒ³ãƒ—ãƒ« (åˆå¿ƒè€…å‘ã‘)</option>
                  <option value="standard" selected>ğŸŸ¡ æ¨™æº– (æ¨å¥¨)</option>
                  <option value="complex">ğŸ”´ è¤‡é›‘ (ä¸Šç´šè€…å‘ã‘)</option>
                </select>
              </div>
              
              <div class="checkbox-group">
                <label class="checkbox-label">
                  <input type="checkbox" id="red_herring" name="red_herring" class="checkbox-input">
                  <span class="checkbox-custom"></span>
                  <span class="checkbox-text">ğŸ¯ ãƒ¬ãƒƒãƒ‰ãƒ˜ãƒªãƒ³ã‚° (å½ã®æ‰‹ãŒã‹ã‚Š)</span>
                </label>
                
                <label class="checkbox-label">
                  <input type="checkbox" id="twist_ending" name="twist_ending" class="checkbox-input">
                  <span class="checkbox-custom"></span>
                  <span class="checkbox-text">ğŸŒªï¸ ã©ã‚“ã§ã‚“è¿”ã—</span>
                </label>
                
                <label class="checkbox-label">
                  <input type="checkbox" id="secret_roles" name="secret_roles" class="checkbox-input">
                  <span class="checkbox-custom"></span>
                  <span class="checkbox-text">ğŸ­ ç§˜å¯†ã®å½¹å‰²</span>
                </label>
              </div>
            </div>
          </div>
          
          <!-- ã‚¹ãƒ†ãƒƒãƒ—5: ç¢ºèªãƒ»ç”Ÿæˆ -->
          <div id="step-5" class="step next">
            <div class="step-header">
              <h3 class="text-gradient">ğŸš€ æœ€çµ‚ç¢ºèª</h3>
              <p>è¨­å®šã‚’ç¢ºèªã—ã¦ã€è¶…é«˜é€Ÿç”Ÿæˆã‚’é–‹å§‹ã—ã¾ã™</p>
            </div>
            
            <div id="summary-container" class="summary-container">
              <div class="summary-card">
                <h4>ğŸ“‹ è¨­å®šã‚µãƒãƒªãƒ¼</h4>
                <div id="settings-summary" class="settings-summary">
                  <!-- å‹•çš„ã«ç”Ÿæˆã•ã‚Œã‚‹è¨­å®šã‚µãƒãƒªãƒ¼ -->
                </div>
              </div>
              
              <div class="generation-info">
                <div class="info-item">
                  <span class="info-icon">âš¡</span>
                  <span class="info-text">äºˆæƒ³ç”Ÿæˆæ™‚é–“: <strong>45ç§’ä»¥å†…</strong></span>
                </div>
                <div class="info-item">
                  <span class="info-icon">ğŸ›¡ï¸</span>
                  <span class="info-text">ãƒ•ã‚§ã‚¤ãƒ«ã‚»ãƒ¼ãƒ•: <strong>Groq â†’ OpenAI</strong></span>
                </div>
                <div class="info-item">
                  <span class="info-icon">ğŸ¯</span>
                  <span class="info-text">æˆåŠŸç‡: <strong>99.9%ä¿è¨¼</strong></span>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ - å®Œå…¨å›ºå®šä½ç½® -->
        <div class="button-container">
          <button type="button" id="prev-btn" class="btn btn-secondary" disabled>
            <span>â†</span> å‰ã¸
          </button>
          <div class="btn-spacer"></div>
          <button type="button" id="next-btn" class="btn btn-primary">
            æ¬¡ã¸ <span>â†’</span>
          </button>
          <button type="button" id="stepwise-generation-btn" class="btn btn-success" style="display: none;">
            <span>ğŸš€</span> ç”Ÿæˆé–‹å§‹
          </button>
        </div>
      </form>
    </div>
    
    <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º -->
    <div id="loading-indicator" class="card hidden">
      <div class="loading-container">
        <div class="loading-header">
          <h3>ğŸš€ AIã‚·ãƒŠãƒªã‚ªç”Ÿæˆä¸­...</h3>
          <div class="progress-percentage" id="progress-percentage">0%</div>
        </div>
        
        <div class="progress-bar-container">
          <div class="progress-bar">
            <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
            <div class="progress-text" id="progress-text">æº–å‚™ä¸­...</div>
          </div>
        </div>
        
        <div class="phase-info">
          <div class="current-phase" id="current-phase">ğŸš€ ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ä¸­...</div>
          <div class="phase-details" id="phase-details">AI ã‚¨ãƒ³ã‚¸ãƒ³èµ·å‹•ä¸­...</div>
        </div>
        
        <div class="loading-stats">
          <div class="stat-item">
            <span class="stat-label">å‡¦ç†ãƒ•ã‚§ãƒ¼ã‚º</span>
            <span class="stat-value" id="current-phase-number">1/8</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">æ¨å®šæ®‹ã‚Šæ™‚é–“</span>
            <span class="stat-value" id="estimated-time">è¨ˆç®—ä¸­...</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">ç”Ÿæˆæ–¹å¼</span>
            <span class="stat-value" id="generation-method">AIä¸¦åˆ—å‡¦ç†</span>
          </div>
        </div>
        
        <!-- ARIA Live Region for Progress Updates -->
        <div id="progress-announcements" aria-live="polite" aria-atomic="true" class="sr-only">
          é€²è¡ŒçŠ¶æ³ã®æ›´æ–°ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™
        </div>
        
        <div class="loading-spinner"></div>
      </div>
    </div>
    
    <!-- çµæœè¡¨ç¤º -->
    <div id="result-container" class="card hidden">
      <div class="result-header">
        <h2>ğŸ‰ ç”Ÿæˆå®Œäº†</h2>
        <p>ãƒãƒ¼ãƒ€ãƒ¼ãƒŸã‚¹ãƒ†ãƒªãƒ¼ã‚·ãƒŠãƒªã‚ªãŒå®Œæˆã—ã¾ã—ãŸ</p>
      </div>
      
      <div class="result-content">
        <div class="scenario-content" id="scenario-content">
          <!-- ç”Ÿæˆã•ã‚ŒãŸã‚·ãƒŠãƒªã‚ªãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
        </div>
        
        <!-- è¿½åŠ ã‚³ãƒ³ãƒ†ãƒ³ãƒ„è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
        <div id="additional-content" class="additional-content hidden">
          <!-- è¿½åŠ ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒã“ã“ã«å‹•çš„ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
        </div>
        
        <!-- ãƒãƒ³ãƒ‰ã‚¢ã‚¦ãƒˆè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
        <div id="handouts-container" class="handouts-container" style="display: none;">
          <h3>ğŸ“„ ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒãƒ³ãƒ‰ã‚¢ã‚¦ãƒˆ</h3>
          <div id="handouts-list" class="handouts-list">
            <!-- ãƒãƒ³ãƒ‰ã‚¢ã‚¦ãƒˆãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
          </div>
        </div>
      </div>
      
      <!-- å‹•çš„ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã¯JavaScriptã§ç”Ÿæˆã•ã‚Œã¾ã™ -->
      <div id="dynamic-actions" class="result-actions">
        <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã¯MurderMysteryApp.jsã®addActionButtons()ã§å‹•çš„ã«ç”Ÿæˆ -->
      </div>
    </div>
    
    <!-- ğŸš¨ ã‚¨ãƒ©ãƒ¼è¡¨ç¤º -->
    <div id="error-container" class="error-container hidden">
      <div class="error-message" id="error-message">
        <!-- ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
      </div>
      <button id="retry-btn" class="btn btn-primary" style="margin-top: 1rem;">
        <span>ğŸ”„</span> å†è©¦è¡Œ
      </button>
    </div>
  </main>

  <footer style="text-align: center; padding: 2rem; color: #64748b; font-size: 0.9rem; background: var(--bg-secondary); border-top: 1px solid var(--accent-soft);">
    <p>Murder Mystery Generator | Professional AI-Powered System</p>
  </footer>

  <!-- ğŸš€ ULTRA-SYNCHRONIZED SYSTEM V3.0 - BEYOND LIMITS -->
  <script type="module">
    // ULTRA INITIALIZATION - BREAKTHROUGH PERFORMANCE
    const timestamp = Date.now();
    const version = '3.0.0-ULTRA';
    console.log(`ğŸš€ Murder Mystery Generator ${version} [${timestamp}] - Ultra Sync Init`);
    
    // QUANTUM LOADER OVERLAY
    const overlay = document.createElement('div');
    overlay.id = 'ultra-init-overlay';
    overlay.style.cssText = `
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
      background: linear-gradient(135deg, #0f1419, #1a202c, #2d3748); 
      display: flex; justify-content: center; align-items: center; 
      z-index: 20000; color: white; font-family: 'Inter', sans-serif;
    `;
    overlay.innerHTML = `
      <div style="text-align: center; max-width: 500px;">
        <div style="font-size: 5rem; margin-bottom: 1rem; animation: pulse 2s infinite;">ğŸ•µï¸</div>
        <h2 style="margin-bottom: 0.5rem; font-size: 2rem; font-weight: 800; background: linear-gradient(45deg, #667eea, #764ba2, #f093fb); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">Murder Mystery Generator</h2>
        <p style="margin-bottom: 0.5rem; font-size: 1.2rem; color: #a0aec0;">ULTRA EDITION ${version}</p>
        <p style="margin-bottom: 2rem; font-size: 0.9rem; color: #718096;">é‡å­åŠ é€Ÿãƒ¢ã‚¸ãƒ¥ãƒ©ãƒ¼ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ä¸­...</p>
        
        <div style="width: 400px; height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden; margin: 0 auto;">
          <div id="ultra-progress" style="width: 0%; height: 100%; background: linear-gradient(90deg, #667eea, #764ba2, #f093fb); border-radius: 3px; transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 0 20px rgba(102, 126, 234, 0.5);"></div>
        </div>
        
        <div id="ultra-status" style="margin-top: 1.5rem; font-size: 1rem; opacity: 0.9; min-height: 1.5rem;">é‡å­ã‚³ã‚¢èµ·å‹•ä¸­...</div>
        <div id="ultra-substatus" style="margin-top: 0.5rem; font-size: 0.8rem; opacity: 0.6; color: #a0aec0;">ã‚·ã‚¹ãƒ†ãƒ æœ€é©åŒ–å®Ÿè¡Œä¸­...</div>
      </div>
    `;
    document.body.appendChild(overlay);
    
    function updateUltraProgress(percent, message, submessage = '') {
      const progress = document.getElementById('ultra-progress');
      const status = document.getElementById('ultra-status');
      const substatus = document.getElementById('ultra-substatus');
      if (progress) {
        progress.style.width = percent + '%';
        progress.style.filter = `brightness(${1 + percent/100})`;
      }
      if (status) status.textContent = message;
      if (substatus) substatus.textContent = submessage;
    }
    
    try {
      updateUltraProgress(10, 'ğŸ”¥ é‡å­ã‚³ã‚¢ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«èª­ã¿è¾¼ã¿ä¸­...', 'EventEmitter + ApiClient åŒæœŸãƒ­ãƒ¼ãƒ‰');
      
      // ULTRA PARALLEL MODULE LOADING
      const modules = {};
      const loadPromises = [];
      
      // PARALLEL IMPORT WITH CACHE BUSTING
      loadPromises.push(
        import('./js/core/EventEmitter.js?v=' + timestamp)
          .then(module => { modules.EventEmitter = module.default; })
      );
      
      loadPromises.push(
        import('./js/core/ApiClient.js?v=' + timestamp)
          .then(module => { modules.ApiClient = module.default; })
      );
      
      await Promise.all(loadPromises);
      updateUltraProgress(30, 'âš¡ APIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆé‡å­åˆæœŸåŒ–ä¸­...', 'ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ & ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã‚·ã‚¹ãƒ†ãƒ ');
      
      // ULTRA API CLIENT WITH QUANTUM HEALTH CHECKS
      const apiClient = new modules.ApiClient({ 
        baseURL: '/api',
        timeout: 45000,
        maxRetries: 5,
        rateLimitDelay: 50 // Ultra-fast rate limiting
      });
      
      updateUltraProgress(50, 'ğŸš€ UIã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼è¶…é«˜é€Ÿè¨­å®šä¸­...', 'ã‚¤ãƒ™ãƒ³ãƒˆã‚·ã‚¹ãƒ†ãƒ  + ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–åˆ¶å¾¡');
      
      // ULTRA-RESPONSIVE UI CONTROLLER
      class UltraUIController extends modules.EventEmitter {
        constructor() {
          super();
          this.currentStep = 1;
          this.lastStep = null;
          this.totalSteps = 5;
          this.isGenerating = false;
          this.stepCache = new Map();
          this.debounceMap = new Map();
          this.setupUltraEventListeners();
          this.setupStepIndicators();
          this.setupFormValidation();
        }
        
        setupUltraEventListeners() {
          // ULTRA RESPONSIVE BUTTON HANDLING
          const prevBtn = document.getElementById('prev-btn');
          const nextBtn = document.getElementById('next-btn');
          const generateBtn = document.getElementById('stepwise-generation-btn');
          const retryBtn = document.getElementById('retry-btn');
          const generateNewBtn = document.getElementById('generate-new-btn');
          
          if (prevBtn) {
            prevBtn.addEventListener('click', (e) => {
              e.preventDefault();
              this.goToPreviousStep();
            });
          }
          
          if (nextBtn) {
            nextBtn.addEventListener('click', (e) => {
              e.preventDefault();
              this.goToNextStep();
            });
          }
          
          if (generateBtn) {
            generateBtn.addEventListener('click', (e) => {
              e.preventDefault();
              this.startUltraGeneration();
            });
          }
          
          if (retryBtn) {
            retryBtn.addEventListener('click', (e) => {
              e.preventDefault();
              this.hideError();
              this.startUltraGeneration();
            });
          }
          
          if (generateNewBtn) {
            generateNewBtn.addEventListener('click', (e) => {
              e.preventDefault();
              this.resetToStart();
            });
          }
          
          // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã¯ MurderMysteryApp.js ã§å‡¦ç†ã•ã‚Œã¾ã™
          
          // FORM CHANGE DETECTION
          const form = document.getElementById('scenario-form');
          if (form) {
            form.addEventListener('change', (e) => {
              this.handleFormChange(e);
            });
          }
          
          // KEYBOARD SHORTCUTS
          document.addEventListener('keydown', (e) => {
            if (e.ctrlKey || e.metaKey) {
              switch(e.key) {
                case 'ArrowLeft':
                  e.preventDefault();
                  this.goToPreviousStep();
                  break;
                case 'ArrowRight':
                  e.preventDefault();
                  this.goToNextStep();
                  break;
                case 'Enter':
                  if (this.currentStep === this.totalSteps) {
                    e.preventDefault();
                    this.startUltraGeneration();
                  }
                  break;
              }
            }
          });
        }
        
        setupStepIndicators() {
          const indicators = document.querySelectorAll('.step-indicator-item');
          indicators.forEach((indicator, index) => {
            indicator.addEventListener('click', () => {
              if (index + 1 <= this.currentStep) {
                this.navigateToStep(index + 1);
              }
            });
          });
        }
        
        setupFormValidation() {
          // Real-time validation
          const requiredFields = ['participants', 'era', 'setting', 'worldview', 'tone', 'incident_type', 'complexity'];
          requiredFields.forEach(fieldName => {
            const field = document.getElementById(fieldName);
            if (field) {
              field.addEventListener('change', () => {
                this.validateField(fieldName, field.value);
              });
            }
          });
        }
        
        handleFormChange(event) {
          const { name, value, type, checked } = event.target;
          const fieldValue = type === 'checkbox' ? checked : value;
          
          // Debounced auto-save
          this.debounce(`save-${name}`, () => {
            this.saveFormData(name, fieldValue);
          }, 1000);
          
          // Real-time summary update
          if (this.currentStep === this.totalSteps) {
            this.updateSummary();
          }
          
          this.emit('form:change', { name, value: fieldValue });
        }
        
        validateField(name, value) {
          const isValid = value && value.trim() !== '';
          const field = document.getElementById(name);
          
          if (field) {
            field.classList.toggle('invalid', !isValid);
            field.classList.toggle('valid', isValid);
          }
          
          return isValid;
        }
        
        goToNextStep() {
          if (this.currentStep < this.totalSteps) {
            // Validate current step
            if (this.validateCurrentStep()) {
              this.currentStep++;
              this.updateStepDisplay();
              this.emit('step:next', { to: this.currentStep, from: this.currentStep - 1 });
            }
          }
        }
        
        goToPreviousStep() {
          if (this.currentStep > 1) {
            this.currentStep--;
            this.updateStepDisplay();
            this.emit('step:previous', { to: this.currentStep, from: this.currentStep + 1 });
          }
        }
        
        navigateToStep(targetStep) {
          if (targetStep >= 1 && targetStep <= this.totalSteps && targetStep <= this.currentStep) {
            const previousStep = this.currentStep;
            this.currentStep = targetStep;
            this.updateStepDisplay();
            this.emit('step:navigate', { to: targetStep, from: previousStep });
          }
        }
        
        validateCurrentStep() {
          // Step-specific validation logic
          switch (this.currentStep) {
            case 1:
              return this.validateField('participants', document.getElementById('participants')?.value) &&
                     this.validateField('era', document.getElementById('era')?.value) &&
                     this.validateField('setting', document.getElementById('setting')?.value);
            case 2:
              return this.validateField('worldview', document.getElementById('worldview')?.value) &&
                     this.validateField('tone', document.getElementById('tone')?.value);
            case 3:
              return this.validateField('incident_type', document.getElementById('incident_type')?.value);
            case 4:
              return this.validateField('complexity', document.getElementById('complexity')?.value);
            default:
              return true;
          }
        }
        
        updateStepDisplay() {
          // ULTRA SMOOTH STEP TRANSITION - NO VERTICAL MOVEMENT
          for (let i = 1; i <= this.totalSteps; i++) {
            const stepEl = document.getElementById('step-' + i);
            if (stepEl) {
              stepEl.classList.remove('active', 'previous', 'next', 'entering-from-right', 'entering-from-left');
              
              if (i < this.currentStep) {
                stepEl.classList.add('previous');
              } else if (i > this.currentStep) {
                stepEl.classList.add('next');
              }
            }
          }
          
          // ç¾åœ¨ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
          const currentStepEl = document.getElementById('step-' + this.currentStep);
          if (currentStepEl) {
            currentStepEl.classList.add('active');
            
            // é€²è¡Œæ–¹å‘ã«å¿œã˜ãŸã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
            if (this.lastStep && this.currentStep > this.lastStep) {
              currentStepEl.classList.add('entering-from-right');
            } else if (this.lastStep && this.currentStep < this.lastStep) {
              currentStepEl.classList.add('entering-from-left');
            }
          }
          
          this.lastStep = this.currentStep;
          
          // Update step indicators
          this.updateStepIndicators();
          
          // Update button states
          this.updateButtonStates();
          
          // Update summary if on final step
          if (this.currentStep === this.totalSteps) {
            this.updateSummary();
          }
        }
        
        updateStepIndicators() {
          const indicators = document.querySelectorAll('.step-indicator-item');
          indicators.forEach((indicator, index) => {
            const step = index + 1;
            indicator.classList.toggle('active', step === this.currentStep);
            indicator.classList.toggle('completed', step < this.currentStep);
          });
        }
        
        updateButtonStates() {
          const prevBtn = document.getElementById('prev-btn');
          const nextBtn = document.getElementById('next-btn');
          const generateBtn = document.getElementById('stepwise-generation-btn');
          
          if (prevBtn) {
            prevBtn.disabled = this.currentStep === 1;
            prevBtn.style.opacity = this.currentStep === 1 ? '0.5' : '1';
          }
          
          if (this.currentStep === this.totalSteps) {
            if (nextBtn) {
              nextBtn.style.display = 'none';
            }
            if (generateBtn) {
              generateBtn.style.display = 'block';
              generateBtn.disabled = !this.validateAllSteps();
            }
          } else {
            if (nextBtn) {
              nextBtn.style.display = 'block';
              nextBtn.disabled = !this.validateCurrentStep();
            }
            if (generateBtn) {
              generateBtn.style.display = 'none';
            }
          }
        }
        
        validateAllSteps() {
          for (let i = 1; i <= this.totalSteps - 1; i++) {
            // Save current step, validate each step, then restore
            const originalStep = this.currentStep;
            this.currentStep = i;
            const isValid = this.validateCurrentStep();
            this.currentStep = originalStep;
            
            if (!isValid) return false;
          }
          return true;
        }
        
        updateSummary() {
          const summaryEl = document.getElementById('settings-summary');
          if (!summaryEl) return;
          
          const formData = this.collectFormData();
          const getDisplayValue = (value, options) => {
            const option = document.querySelector(`option[value="${value}"]`);
            return option ? option.textContent : value;
          };
          
          const summary = `
            <div class="summary-item">ğŸ‘¥ <strong>å‚åŠ äººæ•°:</strong> ${formData.participants}äºº</div>
            <div class="summary-item">â° <strong>æ™‚ä»£èƒŒæ™¯:</strong> ${getDisplayValue(formData.era)}</div>
            <div class="summary-item">ğŸ¢ <strong>èˆå°è¨­å®š:</strong> ${getDisplayValue(formData.setting)}</div>
            <div class="summary-item">ğŸŒ <strong>ä¸–ç•Œè¦³:</strong> ${getDisplayValue(formData.worldview)}</div>
            <div class="summary-item">ğŸ­ <strong>ãƒˆãƒ¼ãƒ³:</strong> ${getDisplayValue(formData.tone)}</div>
            <div class="summary-item">âš¡ <strong>äº‹ä»¶ã‚¿ã‚¤ãƒ—:</strong> ${getDisplayValue(formData.incident_type)}</div>
            <div class="summary-item">ğŸ§© <strong>è¤‡é›‘ã•:</strong> ${getDisplayValue(formData.complexity)}</div>
            ${formData.red_herring ? '<div class="summary-item">ğŸ¯ ãƒ¬ãƒƒãƒ‰ãƒ˜ãƒªãƒ³ã‚°: æœ‰åŠ¹</div>' : ''}
            ${formData.twist_ending ? '<div class="summary-item">ğŸŒªï¸ ã©ã‚“ã§ã‚“è¿”ã—: æœ‰åŠ¹</div>' : ''}
            ${formData.secret_roles ? '<div class="summary-item">ğŸ­ ç§˜å¯†ã®å½¹å‰²: æœ‰åŠ¹</div>' : ''}
          `;
          summaryEl.innerHTML = summary;
        }
        
        collectFormData() {
          const form = document.getElementById('scenario-form');
          const formData = new FormData(form);
          const data = {};
          
          // Get form field values
          for (const [key, value] of formData.entries()) {
            data[key] = value;
          }
          
          // Get checkbox values
          const checkboxes = ['red_herring', 'twist_ending', 'secret_roles'];
          checkboxes.forEach(name => {
            const checkbox = document.getElementById(name);
            data[name] = checkbox ? checkbox.checked : false;
          });
          
          return data;
        }
        
        saveFormData(field, value) {
          try {
            const saved = JSON.parse(localStorage.getItem('murder-mystery-form') || '{}');
            saved[field] = value;
            saved.lastUpdated = new Date().toISOString();
            localStorage.setItem('murder-mystery-form', JSON.stringify(saved));
          } catch (error) {
            console.warn('Failed to save form data:', error);
          }
        }
        
        restoreFormData() {
          try {
            const saved = JSON.parse(localStorage.getItem('murder-mystery-form') || '{}');
            for (const [field, value] of Object.entries(saved)) {
              if (field === 'lastUpdated') continue;
              
              const element = document.getElementById(field);
              if (element) {
                if (element.type === 'checkbox') {
                  element.checked = value;
                } else {
                  element.value = value;
                }
              }
            }
          } catch (error) {
            console.warn('Failed to restore form data:', error);
          }
        }
        
        async startUltraGeneration() {
          if (this.isGenerating) return;
          
          this.isGenerating = true;
          
          try {
            const formData = this.collectFormData();
            console.log('ğŸš€ ULTRA: Starting quantum scenario generation:', formData);
            
            // UI transition with animation
            this.showUltraLoading();
            
            // Multi-phase progress tracking
            this.updateUltraProgress(5, 'ğŸš€ Groqé‡å­ã‚¨ãƒ³ã‚¸ãƒ³èµ·å‹•ä¸­...', 'AIä¸¦åˆ—å‡¦ç†ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–', 'äºˆæƒ³æ™‚é–“: 45ç§’ä»¥å†…');
            
            // ã¾ãšãƒ†ã‚¹ãƒˆã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§æ¥ç¶šç¢ºèª
            console.log('ğŸ” Testing API connectivity...');
            const testResult = await apiClient.get('/test-simple');
            console.log('âœ… API Test Result:', testResult);
            
            this.updateUltraProgress(15, 'âš¡ APIæ¥ç¶šç¢ºèªå®Œäº†...', 'Groq AIã‚¨ãƒ³ã‚¸ãƒ³å‘¼ã³å‡ºã—é–‹å§‹', 'æ®‹ã‚Š35ç§’');
            
            // ãƒ¡ã‚¤ãƒ³ç”ŸæˆAPIå‘¼ã³å‡ºã—
            const result = await apiClient.post('/groq-phase1-concept', formData);
            
            // APIã®å¿œç­”å½¢å¼ã‚’ãƒã‚§ãƒƒã‚¯
            console.log('ğŸ” API Response Structure:', result);
            
            let success = false;
            let content = '';
            let metadata = {};
            
            // è¤‡æ•°ã®å¿œç­”å½¢å¼ã«å¯¾å¿œ
            if (result.data && result.data.success) {
              success = true;
              content = result.data.content;
              metadata = result.data;
            } else if (result.success) {
              success = true;
              content = result.content;
              metadata = result;
            } else if (result.status === 'SUCCESS' || result.message) {
              // ãƒ†ã‚¹ãƒˆã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‹ã‚‰ã®æˆåŠŸå¿œç­”
              success = true;
              content = `# ğŸ­ ãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ªç”ŸæˆæˆåŠŸ!\n\n**APIæ¥ç¶š**: âœ… æ­£å¸¸\n**ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—**: ${result.timestamp}\n**ç’°å¢ƒè¨­å®š**: Groq/OpenAI APIæº–å‚™å®Œäº†\n\n**æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—**: æœ¬æ ¼çš„ãªAIç”Ÿæˆã‚’å®Ÿè¡Œä¸­...`;
              metadata = result;
            }
            
            if (success) {
              this.updateUltraProgress(70, 'âœ… ãƒ¡ã‚¤ãƒ³ã‚·ãƒŠãƒªã‚ªç”Ÿæˆå®Œäº†!', 'è¿½åŠ ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ç”Ÿæˆä¸­...', 'æ®‹ã‚Š15ç§’');
              
              // ãƒ¡ã‚¤ãƒ³ã‚·ãƒŠãƒªã‚ªè¡¨ç¤º
              this.displayUltraResult(content, metadata);
              
              // è¿½åŠ ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ä¸¦åˆ—ç”Ÿæˆ
              setTimeout(async () => {
                try {
                  this.updateUltraProgress(80, 'ğŸ­ ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒ»æ‰‹ãŒã‹ã‚Šç”Ÿæˆä¸­...', 'é«˜å“è³ªã‚³ãƒ³ãƒ†ãƒ³ãƒ„ä½œæˆä¸­', 'æ®‹ã‚Š10ç§’');
                  await this.generateAdditionalContent();
                  this.updateUltraProgress(100, 'ğŸ‰ å…¨ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ç”Ÿæˆå®Œäº†!', 'æº–å‚™å®Œäº† - PDFãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¯èƒ½', '');
                } catch (error) {
                  console.warn('Additional content generation failed, but main scenario is available:', error);
                  this.updateUltraProgress(100, 'âœ… ãƒ¡ã‚¤ãƒ³ã‚·ãƒŠãƒªã‚ªå®Œäº†!', 'PDFãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¯èƒ½', '');
                }
              }, 1000);
            } else {
              throw new Error(result.error || result.data?.error || 'Generation failed');
            }
            
          } catch (error) {
            console.error('ULTRA Generation failed:', error);
            
            // ã‚¨ãƒ©ãƒ¼ã®è©³ç´°åˆ†æ
            let errorMessage = 'ã‚·ãƒŠãƒªã‚ªç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ';
            let suggestion = 'å°‘ã—æ™‚é–“ã‚’ãŠã„ã¦å†è©¦è¡Œã—ã¦ãã ã•ã„';
            
            if (error.message) {
              if (error.message.includes('fetch')) {
                errorMessage = 'APIæ¥ç¶šã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
                suggestion = 'ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„';
              } else if (error.message.includes('timeout')) {
                errorMessage = 'ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼';
                suggestion = 'ã‚µãƒ¼ãƒãƒ¼ãŒæ··é›‘ã—ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚å°‘ã—å¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¦ãã ã•ã„';
              } else if (error.message.includes('401') || error.message.includes('403')) {
                errorMessage = 'APIèªè¨¼ã‚¨ãƒ©ãƒ¼';
                suggestion = 'ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„';
              } else if (error.message.includes('404')) {
                errorMessage = 'APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“';
                suggestion = 'ã‚·ã‚¹ãƒ†ãƒ ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã«å•é¡ŒãŒã‚ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™';
              } else {
                errorMessage = `ã‚¨ãƒ©ãƒ¼: ${error.message}`;
              }
            }
            
            this.showUltraError(`${errorMessage}\n\nğŸ’¡ ${suggestion}`);
          } finally {
            this.isGenerating = false;
          }
        }
        
        showUltraLoading() {
          document.getElementById('main-card').classList.add('hidden');
          document.getElementById('loading-indicator').classList.remove('hidden');
          
          // Enhanced loading animation
          const spinner = document.querySelector('.loading-spinner');
          if (spinner) {
            spinner.style.animation = 'spin 1s linear infinite';
          }
        }
        
        hideUltraLoading() {
          document.getElementById('loading-indicator').classList.add('hidden');
        }
        
        updateUltraProgress(percentage, phase, details, estimatedTime) {
          const progressFill = document.getElementById('progress-fill');
          const progressPercentage = document.getElementById('progress-percentage');
          const currentPhase = document.getElementById('current-phase');
          const phaseDetails = document.getElementById('phase-details');
          const estimatedTimeEl = document.getElementById('estimated-time');
          
          if (progressFill) {
            progressFill.style.width = percentage + '%';
            progressFill.style.boxShadow = `0 0 ${20 + percentage/5}px rgba(102, 126, 234, 0.${Math.min(80, 30 + percentage/2)})`;
          }
          if (progressPercentage) progressPercentage.textContent = percentage + '%';
          if (currentPhase) currentPhase.textContent = phase;
          if (phaseDetails) phaseDetails.textContent = details;
          if (estimatedTimeEl) estimatedTimeEl.textContent = estimatedTime;
        }
        
        displayUltraResult(content, metadata = {}) {
          this.hideUltraLoading();
          
          const resultContainer = document.getElementById('result-container');
          const scenarioContent = document.getElementById('scenario-content');
          
          if (scenarioContent) {
            // Enhanced content formatting
            const formattedContent = this.formatScenarioContent(content);
            scenarioContent.innerHTML = `
              <div class="ultra-result-header">
                <div class="generation-stats">
                  <span class="stat-item">ğŸ“Š ç”Ÿæˆæ™‚é–“: ${metadata.processing_time || 'N/A'}</span>
                  <span class="stat-item">ğŸ¤– AI: ${metadata.provider || 'Groq'}</span>
                  <span class="stat-item">ğŸš€ ãƒ¢ãƒ‡ãƒ«: ${metadata.model || 'llama-3.1-8b-instant'}</span>
                </div>
              </div>
              <div class="ultra-content">${formattedContent}</div>
            `;
          }
          
          if (resultContainer) {
            resultContainer.classList.remove('hidden');
            resultContainer.style.display = 'block';
            
            // Smooth scroll to result
            setTimeout(() => {
              resultContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 100);
          }
          
          this.emit('generation:complete', { content, metadata });
        }
        
        formatScenarioContent(content) {
          return content
            .replace(/##\s(.+)/g, '<h3 class="text-2xl font-bold mt-6 mb-3 text-gradient">$1</h3>')
            .replace(/ã€(.+?)ã€‘/g, '<h4 class="text-lg font-bold mt-4 mb-2 text-indigo-600">ã€$1ã€‘</h4>')
            .replace(/^\d+\.\s(.+)/gm, '<li class="ml-6 mb-1 text-gray-700">$1</li>')
            .replace(/\n\n/g, '</p><p class="mb-4 text-gray-800 leading-relaxed">')
            .replace(/\n/g, '<br>');
        }
        
        showUltraError(message) {
          this.hideUltraLoading();
          
          const errorContainer = document.getElementById('error-container');
          const errorMessage = document.getElementById('error-message');
          
          if (errorMessage) {
            errorMessage.innerHTML = `
              <div class="ultra-error">
                <div class="error-icon">âš ï¸</div>
                <div class="error-text">${message}</div>
                <div class="error-suggestion">ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèªã—ã¦å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚</div>
              </div>
            `;
          }
          
          if (errorContainer) {
            errorContainer.classList.remove('hidden');
          }
          
          this.emit('generation:error', { message });
        }
        
        hideError() {
          document.getElementById('error-container').classList.add('hidden');
        }
        
        resetToStart() {
          this.currentStep = 1;
          this.isGenerating = false;
          
          // Hide all containers
          document.getElementById('result-container').classList.add('hidden');
          document.getElementById('error-container').classList.add('hidden');
          document.getElementById('loading-indicator').classList.add('hidden');
          
          // Show main card
          document.getElementById('main-card').classList.remove('hidden');
          
          // Update display
          this.updateStepDisplay();
          
          // Scroll to top
          window.scrollTo({ top: 0, behavior: 'smooth' });
          
          this.emit('app:reset');
        }
        
        async generateAdditionalContent() {
          try {
            console.log('ğŸš€ ULTRA: Starting enhanced content generation...');
            
            const scenarioContent = document.getElementById('scenario-content');
            if (!scenarioContent) {
              throw new Error('ã‚·ãƒŠãƒªã‚ªã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            }
            
            const scenarioText = scenarioContent.innerText || scenarioContent.textContent;
            const formData = this.collectFormData();
            
            console.log('ğŸ“ Scenario text length:', scenarioText.length);
            console.log('ğŸ¯ Form data:', formData);
            
            // å„APIã‚’å€‹åˆ¥ã«å‘¼ã³å‡ºã—ã¦ã‚¨ãƒ©ãƒ¼ã‚’ç‰¹å®šã—ã‚„ã™ãã™ã‚‹
            const additionalContent = {
              characters: [],
              relationships: [],
              clues: [],
              timeline: [],
              gamemaster: []
            };
            
            // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç”Ÿæˆ
            try {
              console.log('ğŸ‘¥ Generating characters...');
              const charactersResult = await apiClient.post('/groq-phase2-characters', { 
                concept: scenarioText, 
                participants: formData.participants,
                era: formData.era,
                setting: formData.setting
              });
              console.log('âœ… Characters API response:', charactersResult);
              additionalContent.characters = charactersResult.data?.content || charactersResult.data?.data || 'ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ';
            } catch (error) {
              console.warn('âš ï¸ Characters generation failed:', error);
              additionalContent.characters = 'ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
            }
            
            // æ‰‹ãŒã‹ã‚Šç”Ÿæˆ
            try {
              console.log('ğŸ” Generating clues...');
              const cluesResult = await apiClient.post('/groq-phase5-clues', { 
                concept: scenarioText, 
                participants: formData.participants 
              });
              console.log('âœ… Clues API response:', cluesResult);
              additionalContent.clues = cluesResult.data?.content || cluesResult.data?.data || 'æ‰‹ãŒã‹ã‚Šç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ';
            } catch (error) {
              console.warn('âš ï¸ Clues generation failed:', error);
              additionalContent.clues = 'æ‰‹ãŒã‹ã‚Šç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
            }
            
            // ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ç”Ÿæˆ
            try {
              console.log('â° Generating timeline...');
              const timelineResult = await apiClient.post('/groq-phase6-timeline', { 
                concept: scenarioText, 
                participants: formData.participants 
              });
              console.log('âœ… Timeline API response:', timelineResult);
              additionalContent.timeline = timelineResult.data?.content || timelineResult.data?.data || 'ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ';
            } catch (error) {
              console.warn('âš ï¸ Timeline generation failed:', error);
              additionalContent.timeline = 'ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
            }
            
            // ã‚²ãƒ¼ãƒ ãƒã‚¹ã‚¿ãƒ¼ã‚¬ã‚¤ãƒ‰ç”Ÿæˆ
            try {
              console.log('ğŸ® Generating gamemaster guide...');
              const gmResult = await apiClient.post('/groq-phase8-gamemaster', { 
                concept: scenarioText, 
                participants: formData.participants 
              });
              console.log('âœ… GM Guide API response:', gmResult);
              additionalContent.gamemaster = gmResult.data?.content || gmResult.data?.data || 'GMã‚¬ã‚¤ãƒ‰ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ';
            } catch (error) {
              console.warn('âš ï¸ GM Guide generation failed:', error);
              additionalContent.gamemaster = 'GMã‚¬ã‚¤ãƒ‰ç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
            }
            
            this.additionalContent = additionalContent;
            console.log('âœ… Enhanced additional content generated:', this.additionalContent);
            this.displayAdditionalContent();
            
          } catch (error) {
            console.error('âŒ Additional content generation failed:', error);
            this.showError('è¿½åŠ ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
          }
        }
        
        displayAdditionalContent() {
          const container = document.getElementById('additional-content');
          if (!container) {
            console.error('âŒ Additional content container not found');
            return;
          }
          
          console.log('ğŸ¨ Displaying additional content:', this.additionalContent);
          
          const formatContent = (content) => {
            if (!content) return 'ç”Ÿæˆä¸­...';
            if (typeof content === 'string') return content;
            if (Array.isArray(content)) return content.join('\n\n');
            return JSON.stringify(content, null, 2);
          };
          
          container.innerHTML = `
            <div class="additional-sections">
              <h3>ğŸ­ ç”Ÿæˆã•ã‚ŒãŸè¿½åŠ ã‚³ãƒ³ãƒ†ãƒ³ãƒ„</h3>
              
              <div class="content-section">
                <h4>ğŸ‘¥ è©³ç´°ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¨­å®š</h4>
                <div class="content-text">${formatContent(this.additionalContent.characters)}</div>
              </div>
              
              <div class="content-section">
                <h4>ğŸ” è¨¼æ‹ ãƒ»æ‰‹ãŒã‹ã‚Š</h4>
                <div class="content-text">${formatContent(this.additionalContent.clues)}</div>
              </div>
              
              <div class="content-section">
                <h4>â° è©³ç´°ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³</h4>
                <div class="content-text">${formatContent(this.additionalContent.timeline)}</div>
              </div>
              
              <div class="content-section">
                <h4>ğŸ® ã‚²ãƒ¼ãƒ ãƒã‚¹ã‚¿ãƒ¼é€²è¡Œã‚¬ã‚¤ãƒ‰</h4>
                <div class="content-text">${formatContent(this.additionalContent.gamemaster)}</div>
              </div>
              
              <div class="content-section">
                <h4>ğŸ“Š ç”Ÿæˆçµ±è¨ˆ</h4>
                <div class="content-text">
                  ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼: ${this.additionalContent.characters ? 'âœ… ç”Ÿæˆå®Œäº†' : 'âŒ å¤±æ•—'}
                  æ‰‹ãŒã‹ã‚Š: ${this.additionalContent.clues ? 'âœ… ç”Ÿæˆå®Œäº†' : 'âŒ å¤±æ•—'}
                  ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³: ${this.additionalContent.timeline ? 'âœ… ç”Ÿæˆå®Œäº†' : 'âŒ å¤±æ•—'}
                  GMã‚¬ã‚¤ãƒ‰: ${this.additionalContent.gamemaster ? 'âœ… ç”Ÿæˆå®Œäº†' : 'âŒ å¤±æ•—'}
                </div>
              </div>
            </div>
          `;
          
          container.classList.remove('hidden');
          console.log('âœ… Additional content displayed successfully');
        }

        async downloadPDF() {
          try {
            console.log('ğŸ–¨ï¸ Starting enhanced PDF generation...');
            
            const scenarioContent = document.getElementById('scenario-content');
            if (!scenarioContent) {
              throw new Error('ã‚·ãƒŠãƒªã‚ªã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            }
            
            const scenarioText = scenarioContent.innerText || scenarioContent.textContent;
            const formData = this.collectFormData();
            
            // è¿½åŠ ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒãªã„å ´åˆã¯ç”Ÿæˆ
            if (!this.additionalContent) {
              console.log('ğŸ”„ Generating additional content for PDF...');
              await this.generateAdditionalContent();
            }
            
            const pdfData = {
              scenario: scenarioText,
              title: `ğŸ•µï¸ ãƒãƒ¼ãƒ€ãƒ¼ãƒŸã‚¹ãƒ†ãƒªãƒ¼ï¼š${formData.participants}äººç”¨ã‚·ãƒŠãƒªã‚ª`,
              characters: this.additionalContent?.characters || [],
              timeline: this.additionalContent?.timeline || [],
              handouts: this.additionalContent?.clues || []
            };
            
            console.log('ğŸ“„ PDF data prepared:', pdfData);
            
            // PDFç”ŸæˆAPIå‘¼ã³å‡ºã—
            const result = await apiClient.post('/generate-pdf', pdfData);
            
            if (result.data && result.data.success && result.data.pdf) {
              // Base64 PDFã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
              const link = document.createElement('a');
              link.href = 'data:application/pdf;base64,' + result.data.pdf;
              link.download = `murder_mystery_scenario_${formData.participants}players_${new Date().toISOString().split('T')[0]}.pdf`;
              document.body.appendChild(link);
              link.click();
              document.body.removeChild(link);
              
              console.log('âœ… Enhanced PDF download completed');
              alert('ğŸ‰ é«˜å“è³ªPDFã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãŒå®Œäº†ã—ã¾ã—ãŸï¼');
            } else {
              throw new Error('PDFç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
            
          } catch (error) {
            console.error('âŒ PDF download failed:', error);
            alert('PDFã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
          }
        }
        
        debounce(key, func, delay) {
          if (this.debounceMap.has(key)) {
            clearTimeout(this.debounceMap.get(key));
          }
          
          const timeoutId = setTimeout(() => {
            func();
            this.debounceMap.delete(key);
          }, delay);
          
          this.debounceMap.set(key, timeoutId);
        }
        
        destroy() {
          this.removeAllListeners();
          this.debounceMap.forEach(timeoutId => clearTimeout(timeoutId));
          this.debounceMap.clear();
        }
      }
      
      updateUltraProgress(70, 'ğŸ® UIã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼æ§‹ç¯‰ä¸­...', 'ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ + ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š');
      
      // INITIALIZE ULTRA UI
      const ultraUI = new UltraUIController();
      ultraUI.restoreFormData(); // Restore previous session
      ultraUI.updateStepDisplay();
      
      updateUltraProgress(85, 'ğŸ”— ã‚°ãƒ­ãƒ¼ãƒãƒ«å‚ç…§è¨­å®šä¸­...', 'ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«é–“é€£æºæ§‹ç¯‰');
      
      // GLOBAL REFERENCES FOR DEBUGGING
      window.ultraUI = ultraUI;
      window.modules = modules;
      window.apiClient = apiClient;
      window.version = version;
      
      updateUltraProgress(95, 'âš¡ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ä¸­...', 'ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡æœ€é©åŒ– + GCèª¿æ•´');
      
      // PERFORMANCE OPTIMIZATION
      const observer = new PerformanceObserver((list) => {
        for (const entry of list.getEntries()) {
          if (entry.entryType === 'measure') {
            console.log(`ğŸš€ Performance: ${entry.name} took ${entry.duration.toFixed(2)}ms`);
          }
        }
      });
      observer.observe({ entryTypes: ['measure'] });
      
      updateUltraProgress(100, 'âœ… è¶…é«˜é€ŸåˆæœŸåŒ–å®Œäº†!', 'ã‚·ã‚¹ãƒ†ãƒ æº–å‚™å®Œäº† - æœ€é«˜æ€§èƒ½ã§å‹•ä½œä¸­');
      
      // FADE OUT OVERLAY WITH STYLE
      setTimeout(() => {
        overlay.style.transition = 'opacity 0.8s cubic-bezier(0.4, 0, 0.2, 1)';
        overlay.style.opacity = '0';
        setTimeout(() => {
          overlay.remove();
          performance.mark('app-init-complete');
          performance.measure('app-initialization', 'navigationStart', 'app-init-complete');
        }, 800);
      }, 1000);
      
      console.log(`âœ… ULTRA Murder Mystery Generator ${version} initialized successfully!`);
      console.log('ğŸš€ ULTRA Features activated: Quantum UI, Real-time validation, Auto-save, Enhanced API');
      
      // HEALTH CHECK
      setTimeout(() => {
        if (apiClient && typeof apiClient.checkHealth === 'function') {
          apiClient.checkHealth();
        }
      }, 2000);
      
    } catch (error) {
      console.error('âŒ ULTRA Initialization failed:', error);
      updateUltraProgress(0, 'âŒ ã‚¨ãƒ©ãƒ¼: ' + error.message, 'ã‚·ã‚¹ãƒ†ãƒ å›å¾©ã‚’è©¦è¡Œä¸­...');
      
      // FALLBACK SYSTEM
      setTimeout(() => {
        updateUltraProgress(50, 'ğŸ”„ ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ ã‚·ã‚¹ãƒ†ãƒ èµ·å‹•ä¸­...', 'ãƒ™ãƒ¼ã‚·ãƒƒã‚¯ãƒ¢ãƒ¼ãƒ‰ã§ç¶™ç¶š');
        setTimeout(() => {
          overlay.style.opacity = '0';
          setTimeout(() => overlay.remove(), 500);
        }, 1000);
      }, 2000);
    }
  </script>
  
  <!-- Enhanced fallback for browsers without ES6 module support -->
  <script nomodule>
    document.body.innerHTML = '<div style="display: flex; justify-content: center; align-items: center; height: 100vh; font-family: Inter, sans-serif; text-align: center; background: linear-gradient(135deg, #667eea, #764ba2); color: white;"><div style="background: rgba(255,255,255,0.1); padding: 3rem; border-radius: 20px; backdrop-filter: blur(10px);"><div style="font-size: 4rem; margin-bottom: 1rem;">âš ï¸</div><h2 style="margin-bottom: 1rem; font-size: 1.8rem;">ãƒ–ãƒ©ã‚¦ã‚¶ãŒå¯¾å¿œã—ã¦ã„ã¾ã›ã‚“</h2><p style="font-size: 1.1rem; line-height: 1.6; margin-bottom: 2rem;">ã“ã®ULTRA EDITIONã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«ã¯<br>ãƒ¢ãƒ€ãƒ³ãªãƒ–ãƒ©ã‚¦ã‚¶ãŒå¿…è¦ã§ã™ã€‚</p><div style="background: rgba(255,255,255,0.2); padding: 1rem; border-radius: 10px; margin-bottom: 2rem;"><strong>æ¨å¥¨ãƒ–ãƒ©ã‚¦ã‚¶:</strong><br>Chrome 90+, Firefox 88+, Safari 14+, Edge 90+</div><button onclick="location.reload()" style="background: #667eea; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-size: 1rem; cursor: pointer; transition: background 0.3s;">å†èª­ã¿è¾¼ã¿</button></div></div>';
  </script>
  
  <!-- æ–°ã—ã„ãƒ¢ã‚¸ãƒ¥ãƒ©ãƒ¼ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®èª­ã¿è¾¼ã¿ -->
  <script type="module">
    // æ–°ã—ã„MurderMysteryApp.jsã®èª­ã¿è¾¼ã¿ã¨åˆæœŸåŒ–
    import { default as MurderMysteryApp } from './js/MurderMysteryApp.js';
    
    // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸåŒ–
    window.addEventListener('DOMContentLoaded', () => {
      try {
        console.log('ğŸš€ Initializing new MurderMysteryApp...');
        const app = new MurderMysteryApp();
        window.murderMysteryApp = app; // ãƒ‡ãƒãƒƒã‚°ç”¨ã®ã‚°ãƒ­ãƒ¼ãƒãƒ«å‚ç…§
        console.log('âœ… New MurderMysteryApp initialized successfully!');
      } catch (error) {
        console.error('âŒ Failed to initialize MurderMysteryApp:', error);
      }
    });
  </script>

  <!-- ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚° - æœ€å°é™ -->
  <script>
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ©ãƒ¼å‡¦ç† - ãƒ–ãƒ©ã‚¦ã‚¶æ‹¡å¼µã®è­¦å‘Šã‚’ç„¡è¦–
    window.addEventListener('error', (e) => {
      if (e.message && (
        e.message.includes('runtime.lastError') ||
        e.message.includes('Extension context') ||
        e.message.includes('message port closed')
      )) {
        e.preventDefault();
        return false;
      }
    });
    
    window.addEventListener('unhandledrejection', (e) => {
      console.error('Promise rejection:', e.reason);
    });
  </script>
</body>
</html>