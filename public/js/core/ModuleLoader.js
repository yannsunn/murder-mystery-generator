/**
 * ModuleLoader - ES6„É¢„Ç∏„É•„Éº„É´ÂãïÁöÑ„É≠„Éº„Éá„Ç£„É≥„Ç∞„Ç∑„Çπ„ÉÜ„É†
 * ‰æùÂ≠òÈñ¢‰øÇËß£Ê±∫„ÄÅÈÅÖÂª∂Ë™≠„ÅøËæº„Åø„ÄÅ„Ç®„É©„Éº„Éè„É≥„Éâ„É™„É≥„Ç∞
 */
class ModuleLoader {
  constructor(options = {}) {
    this.baseUrl = options.baseUrl || '/js';
    this.timeout = options.timeout || 10000;
    this.cache = new Map();
    this.loadingPromises = new Map();
    this.dependencies = new Map();
    this.loadOrder = [];
    this.retryCount = options.retryCount || 3;
    this.retryDelay = options.retryDelay || 1000;
    
    this.setupModuleMap();
  }

  /**
   * „É¢„Ç∏„É•„Éº„É´„Éû„ÉÉ„Éó„ÅÆË®≠ÂÆö
   */
  setupModuleMap() {
    this.moduleMap = {
      // „Ç≥„Ç¢„É¢„Ç∏„É•„Éº„É´
      'EventEmitter': `${this.baseUrl}/core/EventEmitter.js`,
      'StateManager': `${this.baseUrl}/core/StateManager.js`,
      'Logger': `${this.baseUrl}/core/Logger.js`,
      'ApiClient': `${this.baseUrl}/core/ApiClient.js`,
      'TypeSystem': `${this.baseUrl}/core/TypeSystem.js`,
      'PerformanceOptimizer': `${this.baseUrl}/core/PerformanceOptimizer.js`,
      
      // „Ç≥„É≥„Éù„Éº„Éç„É≥„Éà
      'StepManager': `${this.baseUrl}/components/StepManager.js`,
      'UIController': `${this.baseUrl}/components/UIController.js`,
      
      // „Çµ„Éº„Éì„Çπ
      'ScenarioGenerator': `${this.baseUrl}/services/ScenarioGenerator.js`,
      
      // „ÉÜ„Çπ„Éà
      'TestFramework': `${this.baseUrl}/test/TestFramework.js`,
      
      // „É°„Ç§„É≥„Ç¢„Éó„É™
      'MurderMysteryApp': `${this.baseUrl}/MurderMysteryApp.js`
    };

    // ‰æùÂ≠òÈñ¢‰øÇÂÆöÁæ©
    this.dependencies.set('StateManager', ['EventEmitter']);
    this.dependencies.set('Logger', []);
    this.dependencies.set('ApiClient', ['EventEmitter']);
    this.dependencies.set('TypeSystem', []);
    this.dependencies.set('PerformanceOptimizer', []);
    this.dependencies.set('StepManager', ['EventEmitter']);
    this.dependencies.set('UIController', ['EventEmitter', 'PerformanceOptimizer']);
    this.dependencies.set('ScenarioGenerator', ['EventEmitter', 'ApiClient']);
    this.dependencies.set('TestFramework', []);
    this.dependencies.set('MurderMysteryApp', [
      'EventEmitter', 
      'StateManager', 
      'Logger', 
      'ApiClient', 
      'TypeSystem',
      'PerformanceOptimizer',
      'StepManager', 
      'UIController', 
      'ScenarioGenerator'
    ]);
  }

  /**
   * „É¢„Ç∏„É•„Éº„É´„ÇíÂãïÁöÑ„Å´Ë™≠„ÅøËæº„Åø
   */
  async loadModule(moduleName, options = {}) {
    try {
      // „Ç≠„É£„ÉÉ„Ç∑„É•„ÉÅ„Çß„ÉÉ„ÇØ
      if (this.cache.has(moduleName) && !options.forceReload) {
        return this.cache.get(moduleName);
      }

      // Êó¢„Å´Ë™≠„ÅøËæº„Åø‰∏≠„ÅÆÂ†¥Âêà„ÅØÂæÖÊ©ü
      if (this.loadingPromises.has(moduleName)) {
        return await this.loadingPromises.get(moduleName);
      }

      // Ë™≠„ÅøËæº„ÅøÈñãÂßã
      const loadingPromise = this.executeModuleLoad(moduleName, options);
      this.loadingPromises.set(moduleName, loadingPromise);

      const module = await loadingPromise;
      
      // „Ç≠„É£„ÉÉ„Ç∑„É•„Å´‰øùÂ≠ò
      this.cache.set(moduleName, module);
      this.loadingPromises.delete(moduleName);
      
      return module;

    } catch (error) {
      this.loadingPromises.delete(moduleName);
      throw new Error(`Failed to load module "${moduleName}": ${error.message}`);
    }
  }

  /**
   * ÂÆüÈöõ„ÅÆ„É¢„Ç∏„É•„Éº„É´Ë™≠„ÅøËæº„ÅøÂÆüË°å
   */
  async executeModuleLoad(moduleName, options) {
    const url = this.moduleMap[moduleName];
    if (!url) {
      throw new Error(`Module "${moduleName}" not found in module map`);
    }

    // ‰æùÂ≠òÈñ¢‰øÇ„ÅÆËß£Ê±∫
    await this.resolveDependencies(moduleName);

    // „Çø„Ç§„É†„Ç¢„Ç¶„Éà‰ªò„Åçimport
    const module = await this.importWithTimeout(url, this.timeout);

    // „É¢„Ç∏„É•„Éº„É´Ê§úË®º
    this.validateModule(module, moduleName);

    // Ë™≠„ÅøËæº„ÅøÈ†ÜÂ∫èË®òÈå≤
    if (!this.loadOrder.includes(moduleName)) {
      this.loadOrder.push(moduleName);
    }

    console.log(`‚úÖ Module loaded: ${moduleName}`);
    return module;
  }

  /**
   * ‰æùÂ≠òÈñ¢‰øÇ„ÅÆËß£Ê±∫
   */
  async resolveDependencies(moduleName) {
    const deps = this.dependencies.get(moduleName) || [];
    
    if (deps.length === 0) {
      return;
    }

    console.log(`üì¶ Resolving dependencies for ${moduleName}:`, deps);

    // ‰æùÂ≠òÈñ¢‰øÇ„Çí‰∏¶ÂàóË™≠„ÅøËæº„Åø
    const dependencyPromises = deps.map(dep => this.loadModule(dep));
    await Promise.all(dependencyPromises);

    console.log(`‚úÖ Dependencies resolved for ${moduleName}`);
  }

  /**
   * „Çø„Ç§„É†„Ç¢„Ç¶„Éà‰ªò„Åçimport
   */
  async importWithTimeout(url, timeout) {
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), timeout);

    try {
      // ES6 dynamic import with retry logic
      let lastError;
      
      for (let attempt = 1; attempt <= this.retryCount; attempt++) {
        try {
          // „É™„Éà„É©„Ç§ÊôÇ„ÅÆÈÅÖÂª∂
          if (attempt > 1) {
            await this.sleep(this.retryDelay * attempt);
            console.log(`üîÑ Retrying module import (${attempt}/${this.retryCount}): ${url}`);
          }

          const module = await import(url);
          clearTimeout(timeoutId);
          return module;

        } catch (error) {
          lastError = error;
          console.warn(`‚ùå Import attempt ${attempt} failed:`, error.message);
        }
      }

      throw lastError;

    } catch (error) {
      clearTimeout(timeoutId);
      
      if (error.name === 'AbortError' || error.message.includes('timeout')) {
        throw new Error(`Module import timeout: ${url}`);
      }
      
      throw error;
    }
  }

  /**
   * „É¢„Ç∏„É•„Éº„É´Ê§úË®º
   */
  validateModule(module, moduleName) {
    if (!module) {
      throw new Error(`Module "${moduleName}" is empty or undefined`);
    }

    // „Éá„Éï„Ç©„É´„Éà„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Åæ„Åü„ÅØÂêçÂâç‰ªò„Åç„Ç®„ÇØ„Çπ„Éù„Éº„Éà„ÅÆÁ¢∫Ë™ç
    if (!module.default && !Object.keys(module).length) {
      throw new Error(`Module "${moduleName}" has no exports`);
    }

    // „Ç≥„É≥„Çπ„Éà„É©„ÇØ„ÇøÈñ¢Êï∞„ÅÆÂ†¥Âêà„ÅÆÊ§úË®º
    const ModuleClass = module.default || module[moduleName];
    if (typeof ModuleClass === 'function') {
      // „Éó„É≠„Éà„Çø„Ç§„Éó„ÉÅ„Çß„ÉÉ„ÇØ„Åß„ÇØ„É©„Çπ„Åã„Å©„ÅÜ„ÅãÁ¢∫Ë™ç
      if (ModuleClass.prototype && ModuleClass.prototype.constructor === ModuleClass) {
        console.log(`üìã Validated class module: ${moduleName}`);
      }
    }
  }

  /**
   * Ë§áÊï∞„É¢„Ç∏„É•„Éº„É´„ÅÆ‰∏¶ÂàóË™≠„ÅøËæº„Åø
   */
  async loadModules(moduleNames, options = {}) {
    const { parallel = true, failFast = false } = options;

    if (parallel) {
      const promises = moduleNames.map(name => this.loadModule(name));
      
      if (failFast) {
        return await Promise.all(promises);
      } else {
        return await Promise.allSettled(promises);
      }
    } else {
      // È†ÜÊ¨°Ë™≠„ÅøËæº„Åø
      const results = [];
      for (const moduleName of moduleNames) {
        try {
          const module = await this.loadModule(moduleName);
          results.push({ status: 'fulfilled', value: module });
        } catch (error) {
          results.push({ status: 'rejected', reason: error });
          if (failFast) {
            throw error;
          }
        }
      }
      return results;
    }
  }

  /**
   * „Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥ÂÖ®‰Ωì„ÅÆÂàùÊúüÂåñ
   */
  async initializeApp(config = {}) {
    console.log('üöÄ Initializing Murder Mystery Application...');
    
    try {
      // 1. „Çª„Ç≠„É•„É™„ÉÜ„Ç£„É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£ÔºàÊó¢Â≠ò„Çπ„ÇØ„É™„Éó„ÉàÔºâ
      await this.loadLegacyScript('/security-utils.js');
      
      // 2. „Ç≥„Ç¢„É¢„Ç∏„É•„Éº„É´„ÅÆË™≠„ÅøËæº„Åø
      console.log('üì¶ Loading core modules...');
      const coreModules = ['EventEmitter', 'StateManager', 'Logger', 'ApiClient'];
      await this.loadModules(coreModules, { parallel: true, failFast: true });

      // 3. „Ç≥„É≥„Éù„Éº„Éç„É≥„Éà„É¢„Ç∏„É•„Éº„É´„ÅÆË™≠„ÅøËæº„Åø
      console.log('üß© Loading component modules...');
      const componentModules = ['StepManager', 'UIController'];
      await this.loadModules(componentModules, { parallel: true, failFast: true });

      // 4. „Çµ„Éº„Éì„Çπ„É¢„Ç∏„É•„Éº„É´„ÅÆË™≠„ÅøËæº„Åø
      console.log('‚öôÔ∏è Loading service modules...');
      const serviceModules = ['ScenarioGenerator'];
      await this.loadModules(serviceModules, { parallel: true, failFast: true });

      // 5. „É°„Ç§„É≥„Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥„ÅÆË™≠„ÅøËæº„Åø
      console.log('üéØ Loading main application...');
      const appModule = await this.loadModule('MurderMysteryApp');
      const MurderMysteryApp = appModule.default || appModule.MurderMysteryApp;

      // 6. „Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥„Ç§„É≥„Çπ„Çø„É≥„Çπ‰ΩúÊàê
      console.log('üé≠ Creating application instance...');
      const app = new MurderMysteryApp(config);

      // 7. „Ç∞„É≠„Éº„Éê„É´ÂèÇÁÖßË®≠ÂÆö
      window.app = app;
      window.moduleLoader = this;

      console.log('‚úÖ Murder Mystery Application initialized successfully!');
      console.log('üìä Module load order:', this.loadOrder);
      
      return app;

    } catch (error) {
      console.error('‚ùå Application initialization failed:', error);
      this.showInitializationError(error);
      throw error;
    }
  }

  /**
   * „É¨„Ç¨„Ç∑„Éº„Çπ„ÇØ„É™„Éó„Éà„ÅÆË™≠„ÅøËæº„Åø
   */
  async loadLegacyScript(src) {
    return new Promise((resolve, reject) => {
      const script = document.createElement('script');
      script.src = src;
      script.onload = resolve;
      script.onerror = reject;
      document.head.appendChild(script);
    });
  }

  /**
   * ÂàùÊúüÂåñ„Ç®„É©„ÉºË°®Á§∫
   */
  showInitializationError(error) {
    const errorDiv = document.createElement('div');
    errorDiv.style.cssText = `
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #fee;
      border: 2px solid #f00;
      border-radius: 8px;
      padding: 20px;
      max-width: 500px;
      z-index: 10000;
      font-family: monospace;
    `;
    
    errorDiv.innerHTML = `
      <h3 style="color: #d00; margin: 0 0 10px 0;">‚ö†Ô∏è „Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥ÂàùÊúüÂåñ„Ç®„É©„Éº</h3>
      <p style="margin: 0 0 10px 0;">${error.message}</p>
      <details style="margin-top: 10px;">
        <summary style="cursor: pointer;">Ë©≥Á¥∞„ÇíË°®Á§∫</summary>
        <pre style="margin: 10px 0 0 0; font-size: 12px; overflow: auto;">${error.stack}</pre>
      </details>
      <button onclick="location.reload()" style="
        margin-top: 15px;
        padding: 8px 16px;
        background: #007cba;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      ">„Éö„Éº„Ç∏„ÇíÂÜçË™≠„ÅøËæº„Åø</button>
    `;

    document.body.appendChild(errorDiv);
  }

  /**
   * „Éó„É™„É≠„Éº„ÉâÊ©üËÉΩ
   */
  async preloadModules(moduleNames) {
    console.log('‚ö° Preloading modules:', moduleNames);
    
    const promises = moduleNames.map(async (moduleName) => {
      try {
        await this.loadModule(moduleName);
        console.log(`‚úÖ Preloaded: ${moduleName}`);
      } catch (error) {
        console.warn(`‚ö†Ô∏è Preload failed: ${moduleName}`, error.message);
      }
    });

    await Promise.allSettled(promises);
  }

  /**
   * „É¢„Ç∏„É•„Éº„É´„ÅÆ„Éõ„ÉÉ„Éà„É™„É≠„Éº„ÉâÔºàÈñãÁô∫Áî®Ôºâ
   */
  async reloadModule(moduleName) {
    if (process?.env?.NODE_ENV !== 'development') {
      console.warn('Hot reload is only available in development mode');
      return;
    }

    console.log(`üîÑ Hot reloading module: ${moduleName}`);
    
    // „Ç≠„É£„ÉÉ„Ç∑„É•„Çí„ÇØ„É™„Ç¢
    this.cache.delete(moduleName);
    
    // ‰æùÂ≠òÈñ¢‰øÇ„ÅÆ„ÅÇ„Çã„É¢„Ç∏„É•„Éº„É´„ÇÇ„ÇØ„É™„Ç¢
    for (const [name, deps] of this.dependencies) {
      if (deps.includes(moduleName)) {
        this.cache.delete(name);
        console.log(`üîÑ Also clearing dependent module: ${name}`);
      }
    }

    // ÂÜçË™≠„ÅøËæº„Åø
    return await this.loadModule(moduleName, { forceReload: true });
  }

  /**
   * „É¢„Ç∏„É•„Éº„É´Áµ±Ë®àÊÉÖÂ†±
   */
  getModuleStats() {
    return {
      totalModules: Object.keys(this.moduleMap).length,
      loadedModules: this.cache.size,
      loadOrder: [...this.loadOrder],
      cacheHitRate: this.cache.size / Math.max(this.loadOrder.length, 1),
      dependencies: Object.fromEntries(this.dependencies)
    };
  }

  /**
   * „Ç≠„É£„ÉÉ„Ç∑„É•ÁÆ°ÁêÜ
   */
  clearCache(moduleName = null) {
    if (moduleName) {
      this.cache.delete(moduleName);
      console.log(`üóëÔ∏è Cleared cache for: ${moduleName}`);
    } else {
      this.cache.clear();
      this.loadOrder.length = 0;
      console.log('üóëÔ∏è Cleared all module cache');
    }
  }

  /**
   * „É¢„Ç∏„É•„Éº„É´‰æùÂ≠òÈñ¢‰øÇ„Ç∞„É©„Éï„ÅÆÂèØË¶ñÂåñÔºà„Éá„Éê„ÉÉ„Ç∞Áî®Ôºâ
   */
  getDependencyGraph() {
    const graph = {};
    
    for (const [module, deps] of this.dependencies) {
      graph[module] = {
        dependencies: deps,
        loaded: this.cache.has(module),
        url: this.moduleMap[module]
      };
    }
    
    return graph;
  }

  /**
   * „É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£„É°„ÇΩ„ÉÉ„Éâ
   */
  sleep(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
  }

  /**
   * „É°„É¢„É™‰ΩøÁî®Èáè„ÉÅ„Çß„ÉÉ„ÇØ
   */
  checkMemoryUsage() {
    if ('memory' in performance) {
      const memory = performance.memory;
      return {
        used: `${(memory.usedJSHeapSize / 1024 / 1024).toFixed(2)} MB`,
        total: `${(memory.totalJSHeapSize / 1024 / 1024).toFixed(2)} MB`,
        limit: `${(memory.jsHeapSizeLimit / 1024 / 1024).toFixed(2)} MB`,
        modules: this.cache.size
      };
    }
    return { error: 'Memory API not available' };
  }

  /**
   * „ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó
   */
  destroy() {
    this.clearCache();
    this.loadingPromises.clear();
    console.log('üóëÔ∏è ModuleLoader destroyed');
  }
}

// „Ç∞„É≠„Éº„Éê„É´Âà©Áî®ÂèØËÉΩ„Å´„Åô„Çã
window.ModuleLoader = ModuleLoader;

export default ModuleLoader;