/**
 * ü¶¥ Skeleton Loading UI System
 * „Çπ„Ç±„É´„Éà„É≥„É≠„Éº„Éá„Ç£„É≥„Ç∞„Å®„Éó„É≠„Ç∞„É¨„ÉÉ„Ç∑„ÉñUIÂº∑Âåñ
 */

class SkeletonLoader {
  constructor() {
    this.activeSkeletons = new Map();
    this.animations = {
      pulse: 'skeleton-pulse',
      shimmer: 'skeleton-shimmer',
      wave: 'skeleton-wave'
    };
    
    this.injectStyles();
  }

  /**
   * „Çπ„Ç±„É´„Éà„É≥„É≠„Éº„Éá„Ç£„É≥„Ç∞Áî®CSS„Çπ„Çø„Ç§„É´Ê≥®ÂÖ•
   */
  injectStyles() {
    if (document.getElementById('skeleton-styles')) return;

    const style = document.createElement('style');
    style.id = 'skeleton-styles';
    style.textContent = `
      .skeleton {
        background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
        background-size: 200% 100%;
        border-radius: 4px;
        position: relative;
        overflow: hidden;
      }

      .skeleton-pulse {
        animation: skeleton-pulse 1.5s ease-in-out infinite;
      }

      .skeleton-shimmer {
        animation: skeleton-shimmer 2s linear infinite;
      }

      .skeleton-wave {
        animation: skeleton-wave 1.6s linear infinite;
      }

      @keyframes skeleton-pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.4; }
      }

      @keyframes skeleton-shimmer {
        0% { background-position: -200% 0; }
        100% { background-position: 200% 0; }
      }

      @keyframes skeleton-wave {
        0% { transform: translateX(-100%); }
        50% { transform: translateX(100%); }
        100% { transform: translateX(100%); }
      }

      .skeleton-text {
        height: 1rem;
        margin-bottom: 0.5rem;
      }

      .skeleton-text.large {
        height: 1.5rem;
      }

      .skeleton-text.small {
        height: 0.75rem;
      }

      .skeleton-text.title {
        height: 2rem;
        width: 60%;
      }

      .skeleton-card {
        padding: 1rem;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        margin-bottom: 1rem;
      }

      .skeleton-button {
        height: 2.5rem;
        width: 120px;
        border-radius: 6px;
      }

      .skeleton-progress {
        height: 8px;
        border-radius: 4px;
        margin: 1rem 0;
      }

      .skeleton-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
      }

      .skeleton-grid {
        display: grid;
        gap: 1rem;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      }

      .skeleton-fade-in {
        animation: skeleton-fade-in 0.3s ease-in;
      }

      .skeleton-fade-out {
        animation: skeleton-fade-out 0.3s ease-out;
      }

      @keyframes skeleton-fade-in {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
      }

      @keyframes skeleton-fade-out {
        from { opacity: 1; transform: translateY(0); }
        to { opacity: 0; transform: translateY(-20px); }
      }

      .skeleton-generation-card {
        padding: 2rem;
        border-radius: 12px;
        background: #ffffff;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        margin: 1rem 0;
      }

      .skeleton-phase-item {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 1rem;
        border-bottom: 1px solid #f0f0f0;
      }

      .skeleton-phase-item:last-child {
        border-bottom: none;
      }
    `;
    
    document.head.appendChild(style);
  }

  /**
   * Âü∫Êú¨ÁöÑ„Å™„Çπ„Ç±„É´„Éà„É≥Ë¶ÅÁ¥†‰ΩúÊàê
   */
  createElement(type, className = '', animation = 'shimmer') {
    const element = document.createElement('div');
    element.className = `skeleton ${this.animations[animation]} ${className}`;
    return element;
  }

  /**
   * „ÉÜ„Ç≠„Çπ„Éà„Çπ„Ç±„É´„Éà„É≥‰ΩúÊàê
   */
  createTextSkeleton(size = 'normal', width = '100%') {
    const skeleton = this.createElement('div', `skeleton-text ${size}`);
    skeleton.style.width = width;
    return skeleton;
  }

  /**
   * „Ç´„Éº„Éâ„Çπ„Ç±„É´„Éà„É≥‰ΩúÊàê
   */
  createCardSkeleton() {
    const card = this.createElement('div', 'skeleton-card');
    
    // „Çø„Ç§„Éà„É´
    card.appendChild(this.createTextSkeleton('title', '60%'));
    
    // „Ç≥„É≥„ÉÜ„É≥„ÉÑË°å
    for (let i = 0; i < 3; i++) {
      const width = i === 2 ? '80%' : '100%';
      card.appendChild(this.createTextSkeleton('normal', width));
    }
    
    return card;
  }

  /**
   * ÁîüÊàê„Éó„É≠„Çª„ÇπÁî®„Çπ„Ç±„É´„Éà„É≥
   */
  createGenerationSkeleton() {
    const container = document.createElement('div');
    container.className = 'skeleton-generation-card skeleton-fade-in';
    
    // „Çø„Ç§„Éà„É´ÈÉ®ÂàÜ
    const titleSection = document.createElement('div');
    titleSection.appendChild(this.createTextSkeleton('large', '40%'));
    titleSection.appendChild(this.createTextSkeleton('normal', '60%'));
    container.appendChild(titleSection);
    
    // „Éó„É≠„Ç∞„É¨„Çπ„Éê„Éº
    container.appendChild(this.createElement('div', 'skeleton-progress'));
    
    // „Éï„Çß„Éº„Ç∫„É™„Çπ„Éà
    const phasesList = document.createElement('div');
    for (let i = 0; i < 8; i++) {
      const phaseItem = document.createElement('div');
      phaseItem.className = 'skeleton-phase-item';
      
      // „Ç¢„Ç§„Ç≥„É≥ÈÉ®ÂàÜ
      phaseItem.appendChild(this.createElement('div', 'skeleton-avatar'));
      
      // „ÉÜ„Ç≠„Çπ„ÉàÈÉ®ÂàÜ
      const textSection = document.createElement('div');
      textSection.style.flex = '1';
      textSection.appendChild(this.createTextSkeleton('normal', '70%'));
      textSection.appendChild(this.createTextSkeleton('small', '40%'));
      phaseItem.appendChild(textSection);
      
      // „Çπ„ÉÜ„Éº„Çø„ÇπÈÉ®ÂàÜ
      phaseItem.appendChild(this.createElement('div', 'skeleton-button'));
      
      phasesList.appendChild(phaseItem);
    }
    
    container.appendChild(phasesList);
    return container;
  }

  /**
   * „Éï„Ç©„Éº„É†Áî®„Çπ„Ç±„É´„Éà„É≥
   */
  createFormSkeleton() {
    const form = document.createElement('div');
    form.className = 'skeleton-fade-in';
    
    // „Éï„Ç©„Éº„É†„Éï„Ç£„Éº„É´„Éâ
    for (let i = 0; i < 6; i++) {
      const field = document.createElement('div');
      field.style.marginBottom = '1.5rem';
      
      // „É©„Éô„É´
      field.appendChild(this.createTextSkeleton('small', '30%'));
      
      // ÂÖ•Âäõ„Éï„Ç£„Éº„É´„Éâ
      const input = this.createElement('div', '', 'pulse');
      input.style.height = '2.5rem';
      input.style.marginTop = '0.5rem';
      field.appendChild(input);
      
      form.appendChild(field);
    }
    
    return form;
  }

  /**
   * ÁµêÊûú„Ç´„Éº„ÉâÁî®„Çπ„Ç±„É´„Éà„É≥
   */
  createResultSkeleton() {
    const container = document.createElement('div');
    container.className = 'skeleton-fade-in';
    
    // „Éò„ÉÉ„ÉÄ„Éº
    const header = document.createElement('div');
    header.style.marginBottom = '2rem';
    header.appendChild(this.createTextSkeleton('title', '50%'));
    header.appendChild(this.createTextSkeleton('normal', '80%'));
    container.appendChild(header);
    
    // Áµ±Ë®à„Ç∞„É™„ÉÉ„Éâ
    const statsGrid = document.createElement('div');
    statsGrid.className = 'skeleton-grid';
    
    for (let i = 0; i < 3; i++) {
      const statCard = this.createCardSkeleton();
      statsGrid.appendChild(statCard);
    }
    
    container.appendChild(statsGrid);
    
    // „Éï„Çß„Éº„Ç∫ÁµêÊûú
    const phasesSection = document.createElement('div');
    phasesSection.style.marginTop = '2rem';
    
    for (let i = 0; i < 5; i++) {
      phasesSection.appendChild(this.createCardSkeleton());
    }
    
    container.appendChild(phasesSection);
    
    return container;
  }

  /**
   * „Çπ„Ç±„É´„Éà„É≥Ë°®Á§∫
   */
  show(containerId, type = 'card', options = {}) {
    const container = document.getElementById(containerId);
    if (!container) {
      return null;
    }

    // Êó¢Â≠ò„ÅÆ„Çπ„Ç±„É´„Éà„É≥„ÇíÂâäÈô§
    this.hide(containerId);

    let skeleton;
    
    switch (type) {
      case 'generation':
        skeleton = this.createGenerationSkeleton();
        break;
      case 'form':
        skeleton = this.createFormSkeleton();
        break;
      case 'result':
        skeleton = this.createResultSkeleton();
        break;
      case 'card':
      default:
        skeleton = this.createCardSkeleton();
        break;
    }

    // „Ç™„Éó„Ç∑„Éß„É≥ÈÅ©Áî®
    if (options.height) {
      skeleton.style.height = options.height;
    }
    
    if (options.className) {
      skeleton.classList.add(options.className);
    }

    // „Ç≥„É≥„ÉÜ„Éä„Å´ËøΩÂä†
    container.innerHTML = '';
    container.appendChild(skeleton);
    
    // ÁÆ°ÁêÜÁî®„Å´Ë®òÈå≤
    this.activeSkeletons.set(containerId, {
      element: skeleton,
      type,
      startTime: Date.now()
    });

    return skeleton;
  }

  /**
   * „Çπ„Ç±„É´„Éà„É≥ÈùûË°®Á§∫
   */
  hide(containerId, fadeOut = true) {
    const skeletonData = this.activeSkeletons.get(containerId);
    if (!skeletonData) return;

    const container = document.getElementById(containerId);
    if (!container) return;

    if (fadeOut) {
      skeletonData.element.classList.add('skeleton-fade-out');
      setTimeout(() => {
        if (container.contains(skeletonData.element)) {
          container.removeChild(skeletonData.element);
        }
        this.activeSkeletons.delete(containerId);
      }, 300);
    } else {
      if (container.contains(skeletonData.element)) {
        container.removeChild(skeletonData.element);
      }
      this.activeSkeletons.delete(containerId);
    }
  }

  /**
   * ÊÆµÈöéÁöÑ„Ç≥„É≥„ÉÜ„É≥„ÉÑË°®Á§∫
   */
  showProgressiveContent(containerId, contentCreator, steps = 3, interval = 500) {
    const container = document.getElementById(containerId);
    if (!container) return;

    this.show(containerId, 'card');

    let currentStep = 0;
    
    const showNextStep = () => {
      if (currentStep >= steps) {
        // ÊúÄÁµÇ„Ç≥„É≥„ÉÜ„É≥„ÉÑË°®Á§∫
        this.hide(containerId);
        const finalContent = contentCreator();
        finalContent.classList.add('skeleton-fade-in');
        container.appendChild(finalContent);
        return;
      }

      // ÊÆµÈöéÁöÑ„Å´„Çπ„Ç±„É´„Éà„É≥„ÇíÊõ¥Êñ∞
      const partialContent = contentCreator(currentStep / steps);
      if (partialContent) {
        container.innerHTML = '';
        container.appendChild(partialContent);
      }

      currentStep++;
      setTimeout(showNextStep, interval);
    };

    setTimeout(showNextStep, interval);
  }

  /**
   * ÂÖ®„Çπ„Ç±„É´„Éà„É≥ÂâäÈô§
   */
  hideAll() {
    for (const containerId of this.activeSkeletons.keys()) {
      this.hide(containerId, false);
    }
  }

  /**
   * Áµ±Ë®àÊÉÖÂ†±ÂèñÂæó
   */
  getStats() {
    const stats = {
      active: this.activeSkeletons.size,
      instances: []
    };

    for (const [containerId, data] of this.activeSkeletons.entries()) {
      stats.instances.push({
        containerId,
        type: data.type,
        duration: Date.now() - data.startTime
      });
    }

    return stats;
  }
}

// „Ç∞„É≠„Éº„Éê„É´„Ç§„É≥„Çπ„Çø„É≥„Çπ‰ΩúÊàê
const skeletonLoader = new SkeletonLoader();

// „Ç∞„É≠„Éº„Éê„É´„Çπ„Ç≥„Éº„Éó„ÅßÂà©Áî®ÂèØËÉΩ„Å´
if (typeof window !== 'undefined') {
  window.SkeletonLoader = SkeletonLoader;
  window.skeletonLoader = skeletonLoader;
}